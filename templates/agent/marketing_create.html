{% extends "agent/layout.html" %}

{% block agent_content %}
<style>
  .creator-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
  }

  .creator-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid rgba(200, 180, 151, 0.2);
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header-left h1 {
    font-family: var(--font-heading);
    font-size: 2rem;
    color: var(--charcoal-brown);
    margin: 0 0 0.5rem 0;
    font-weight: 600;
  }

  .header-breadcrumb {
    color: rgba(58, 53, 44, 0.6);
    font-size: 0.9rem;
  }

  .back-to-hub {
    background: rgba(107, 106, 69, 0.1);
    color: var(--olive-green);
    border: 1.5px solid var(--olive-green);
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
  }

  .back-to-hub:hover {
    background: var(--olive-green);
    color: white;
  }

  .creator-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }

  .editor-panel {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(246, 242, 232, 0.95) 100%);
    border: 1px solid rgba(200, 180, 151, 0.2);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 8rem;
  }

  .editor-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    color: var(--charcoal-brown);
    margin: 0 0 1.5rem 0;
    font-weight: 600;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-weight: 600;
    color: var(--olive-green);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 1px solid rgba(200, 180, 151, 0.3);
    border-radius: 8px;
    font-size: 0.95rem;
    color: var(--charcoal-brown);
    background: white;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--olive-green);
    box-shadow: 0 0 0 3px rgba(107, 106, 69, 0.1);
  }

  .form-textarea {
    min-height: 100px;
    resize: vertical;
  }

  .toggle-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(107, 106, 69, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(107, 106, 69, 0.15);
  }

  .toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(200, 180, 151, 0.3);
    transition: 0.3s;
    border-radius: 26px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }

  .toggle-switch input:checked + .toggle-slider {
    background-color: var(--olive-green);
  }

  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(24px);
  }

  .toggle-label {
    font-weight: 500;
    color: var(--charcoal-brown);
    font-size: 0.95rem;
  }

  .preview-panel {
    background: rgba(246, 242, 232, 0.5);
    border: 2px dashed rgba(107, 106, 69, 0.2);
    border-radius: 16px;
    padding: 2rem;
    min-height: 600px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .preview-title {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    color: var(--charcoal-brown);
    margin: 0 0 1rem 0;
    font-weight: 600;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .preview-title::before {
    content: '';
    width: 8px;
    height: 8px;
    background: #4ade80;
    border-radius: 50%;
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .preview-content {
    width: 100%;
    max-width: 600px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .preview-frame {
    width: 100%;
    aspect-ratio: 8.5 / 11;
    background: white;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  .preview-headline {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    color: var(--charcoal-brown);
    margin: 0 0 1rem 0;
    font-weight: 600;
    line-height: 1.2;
  }

  .preview-subtext {
    font-size: 1.25rem;
    color: rgba(58, 53, 44, 0.8);
    margin: 0 0 2rem 0;
  }

  .preview-price {
    font-family: var(--font-heading);
    font-size: 3rem;
    color: var(--olive-green);
    margin: 0 0 1rem 0;
    font-weight: 700;
  }

  .preview-address {
    font-size: 1.1rem;
    color: var(--charcoal-brown);
    margin: 0 0 2rem 0;
    font-weight: 500;
  }

  .preview-divider {
    width: 80px;
    height: 3px;
    background: linear-gradient(90deg, rgba(107, 106, 69, 0.3) 0%, rgba(107, 106, 69, 0.8) 50%, rgba(107, 106, 69, 0.3) 100%);
    margin: 2rem auto;
    border-radius: 2px;
  }

  .preview-agent-info {
    margin-top: auto;
    padding-top: 2rem;
    border-top: 1px solid rgba(200, 180, 151, 0.2);
    width: 100%;
  }

  .agent-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--charcoal-brown);
    margin: 0 0 0.25rem 0;
  }

  .agent-contact {
    font-size: 0.9rem;
    color: rgba(58, 53, 44, 0.7);
    margin: 0;
  }

  .generate-btn {
    background: linear-gradient(135deg, var(--olive-green) 0%, rgba(107, 106, 69, 0.95) 100%);
    color: white;
    border: none;
    padding: 1rem 2.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(107, 106, 69, 0.3);
    margin-top: 2rem;
    width: 100%;
  }

  .generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(107, 106, 69, 0.4);
  }

  .ai-refine-btn {
    background: linear-gradient(135deg, #8B7355 0%, #6B5D4A 100%);
    color: white;
    border: none;
    padding: 0.875rem 1rem;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .ai-refine-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(139, 115, 85, 0.4);
  }

  .ai-refine-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .ai-refine-btn-full {
    background: linear-gradient(135deg, rgba(139, 115, 85, 0.1) 0%, rgba(107, 93, 74, 0.1) 100%);
    color: #6B5D4A;
    border: 1.5px solid #8B7355;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
  }

  .ai-refine-btn-full:hover {
    background: linear-gradient(135deg, #8B7355 0%, #6B5D4A 100%);
    color: white;
  }

  .ai-refine-btn-full:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .helper-text {
    font-size: 0.85rem;
    color: rgba(58, 53, 44, 0.6);
    font-style: italic;
    margin-top: 0.5rem;
  }

  @media (max-width: 1200px) {
    .creator-grid {
      grid-template-columns: 1fr;
    }

    .editor-panel {
      position: static;
    }

    .preview-panel {
      order: -1;
    }
  }

  @media (max-width: 768px) {
    .creator-container {
      padding: 1rem;
    }

    .creator-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .editor-panel {
      padding: 1.5rem;
    }

    .preview-frame {
      padding: 1rem;
    }

    .preview-headline {
      font-size: 1.75rem;
    }

    .preview-price {
      font-size: 2rem;
    }
  }
</style>

<div class="creator-container">
  <!-- Header -->
  <div class="creator-header">
    <div class="header-left">
      <h1>Create Marketing Asset</h1>
      <div class="header-breadcrumb">
        {{ category|replace('-', ' ')|title }} ‚Üí {{ asset_type|replace('-', ' ')|title }}
      </div>
    </div>
    <a href="{{ url_for('agent_marketing_hub', tx_id=tx_id) }}" class="back-to-hub">
      ‚Üê Back to Hub
    </a>
  </div>

  {% if not agent_profile or not agent_profile.get('professional_photo') or not agent_profile.get('brokerage_logo') %}
  <div style="background: linear-gradient(135deg, #FFF3CD 0%, #FFE69C 100%); border: 2px solid #FFCA28; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: start; gap: 1rem;">
    <div style="font-size: 24px;">‚ÑπÔ∏è</div>
    <div style="flex: 1;">
      <div style="font-weight: 600; color: #856404; margin-bottom: 0.25rem;">Profile Setup Needed</div>
      <div style="color: #856404; font-size: 0.9rem; line-height: 1.5;">
        Your <strong>professional photo</strong> and <strong>brokerage logo</strong> are not set. 
        <a href="{{ url_for('agent_settings_profile') }}" style="color: #6B6A45; text-decoration: underline; font-weight: 600;">Upload them in Settings</a> 
        to have them appear on your marketing materials.
      </div>
    </div>
  </div>
  {% endif %}

  <form id="marketing-form" method="POST" action="{{ url_for('agent_marketing_generate', tx_id=tx_id) }}" enctype="multipart/form-data" target="_blank">
    <input type="hidden" name="category" value="{{ category }}">
    <input type="hidden" name="asset_type" value="{{ asset_type }}">
    
    <div class="creator-grid">
      <!-- Editor Panel -->
      <div class="editor-panel">
        <h2 class="editor-title">Customize Your Marketing</h2>

        <div class="form-group">
          <label class="form-label">Headline</label>
          <input 
            type="text" 
            name="headline" 
            id="headline-input"
            class="form-input" 
            placeholder="Just Listed"
            value="{% if category == 'just-listed' %}Just Listed{% elif category == 'coming-soon' %}Coming Soon{% elif category == 'open-house' %}Open House{% elif category == 'sold' %}Sold{% elif category == 'under-contract' %}Under Contract{% elif category == 'price-reduction' %}Price Reduced{% elif category == 'back-on-market' %}Back on Market{% else %}Luxury Living Awaits{% endif %}"
            oninput="updatePreview()"
          >
        </div>

        <div class="form-group">
          <label class="form-label">Subheading</label>
          <div style="display: flex; gap: 0.5rem;">
            <input 
              type="text" 
              name="subtext" 
              id="subtext-input"
              class="form-input" 
              placeholder="Your dream home awaits"
              value="Luxury living in {{ transaction.property_city or 'your area' }}"
              oninput="updatePreview()"
              style="flex: 1;"
            >
            <button type="button" onclick="refineText('subtext')" class="ai-refine-btn" title="AI Enhance">‚ú®</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Price</label>
          <input 
            type="text" 
            name="price" 
            id="price-input"
            class="form-input" 
            placeholder="$799,000"
            value="${{ "{:,.0f}".format(transaction.list_price) if transaction.list_price else '799,000' }}"
            oninput="updatePreview()"
          >
        </div>

        <div class="form-group">
          <label class="form-label">Property Address</label>
          <input 
            type="text" 
            name="property_address" 
            id="address-input"
            class="form-input" 
            placeholder="123 Main Street"
            value="{{ transaction.property_address or '' }}"
            oninput="updatePreview()"
          >
        </div>

        <div class="form-group">
          <label class="form-label">Custom Text (Optional)</label>
          <textarea 
            name="custom_text" 
            id="custom-text-input"
            class="form-textarea" 
            placeholder="Add any additional details..."
            oninput="updatePreview()"
          ></textarea>
          <button type="button" onclick="refineText('custom_text')" class="ai-refine-btn-full" style="margin-top: 0.5rem;">
            ‚ú® Enhance with AI
          </button>
          <p class="helper-text">Leave blank to use default text</p>
        </div>

        <div class="form-group">
          <label class="form-label">Property Photos (Optional)</label>
          <input 
            type="file" 
            name="property_photos" 
            id="property-photos-input"
            class="form-input" 
            accept="image/*"
            multiple
            onchange="handlePropertyPhotos(this)"
            style="padding: 0.5rem;"
          >
          <p class="helper-text">Upload up to 3 high-quality property images</p>
          <div id="photo-preview-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 0.5rem;"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Layout Style</label>
          <select name="layout_style" id="layout-style-select" class="form-input" onchange="updatePreview()">
            <option value="magazine" selected>‚ú® Magazine Editorial - Asymmetric Designer Layout</option>
            <option value="showcase">üíé Luxury Showcase - Large Hero + Inset Photos</option>
            <option value="modern">üé® Modern Elegance - Overlapping Composition</option>
            <option value="editorial">üìê Designer Portfolio - Angular & Bold</option>
            <option value="collection">üëë Premium Collection - Multi-Photo Spread</option>
            <option value="hero">Hero Image - Large Top Photo</option>
            <option value="split">Split View - Photo Left, Details Right</option>
            <option value="gallery">Gallery Style - 2-3 Photos Grid</option>
            <option value="minimal">Minimal Elegance - Small Featured Photo</option>
            <option value="classic">Classic - Center Focus (No Property Photos)</option>
          </select>
          <p class="helper-text">Choose how property photos are displayed</p>
        </div>

        <div class="form-group">
          <label class="form-label">Color Scheme</label>
          <select name="color_scheme" id="color-scheme-select" class="form-input" onchange="updatePreview()">
            <option value="classic">Classic Olive & Cream (Default)</option>
            <option value="navy">Navy & Gold Elegance</option>
            <option value="charcoal">Charcoal & Rose Gold</option>
            <option value="forest">Forest Green & Ivory</option>
            <option value="burgundy">Burgundy & Champagne</option>
          </select>
        </div>

        <div class="form-group">
          <div class="toggle-group">
            <label class="toggle-switch">
              <input type="checkbox" name="include_photo" id="photo-toggle" checked onchange="updatePreview()">
              <span class="toggle-slider"></span>
            </label>
            <label class="toggle-label" for="photo-toggle">
              Include My Photo
            </label>
          </div>
        </div>

        <div class="form-group">
          <div class="toggle-group">
            <label class="toggle-switch">
              <input type="checkbox" name="include_logo" id="logo-toggle" checked onchange="updatePreview()">
              <span class="toggle-slider"></span>
            </label>
            <label class="toggle-label" for="logo-toggle">
              Include My Logo
            </label>
          </div>
        </div>

        <div class="form-group">
          <div class="toggle-group">
            <label class="toggle-switch">
              <input type="checkbox" name="include_lender" id="lender-toggle" onchange="updatePreview()">
              <span class="toggle-slider"></span>
            </label>
            <label class="toggle-label" for="lender-toggle">
              Include Lender Information
            </label>
          </div>
        </div>

        <button type="submit" class="generate-btn">
          Generate & Download
        </button>
      </div>

      <!-- Preview Panel -->
      <div class="preview-panel">
        <p class="preview-title">Live Preview</p>
        <div class="preview-content">
          <div class="preview-frame" id="preview-frame">
            <div class="preview-headline" id="preview-headline">Just Listed</div>
            <div class="preview-subtext" id="preview-subtext">Luxury living in {{ transaction.property_city or 'your area' }}</div>
            <div class="preview-divider"></div>
            <div class="preview-price" id="preview-price">${{ "{:,.0f}".format(transaction.list_price) if transaction.list_price else '799,000' }}</div>
            <div class="preview-address" id="preview-address">{{ transaction.property_address or '123 Main Street' }}</div>
            <div class="preview-custom-text" id="preview-custom-text" style="margin-top: 2rem; font-size: 0.95rem; color: rgba(58, 53, 44, 0.85); line-height: 1.6; max-width: 80%; margin-left: auto; margin-right: auto; display: none;"></div>
            <div class="preview-divider"></div>
            <div class="preview-agent-info">
              <div class="agent-name">{{ user.name }}</div>
              <div class="agent-contact">{{ user.phone or user.email }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  function updatePreview() {
    // Update headline with smooth transition
    const headline = document.getElementById('headline-input').value || 'Just Listed';
    const headlineEl = document.getElementById('preview-headline');
    if (headlineEl.textContent !== headline) {
      headlineEl.style.opacity = '0.5';
      setTimeout(() => {
        headlineEl.textContent = headline;
        headlineEl.style.opacity = '1';
      }, 100);
    }

    // Update subtext with smooth transition
    const subtext = document.getElementById('subtext-input').value || 'Luxury living awaits';
    const subtextEl = document.getElementById('preview-subtext');
    if (subtextEl.textContent !== subtext) {
      subtextEl.style.opacity = '0.5';
      setTimeout(() => {
        subtextEl.textContent = subtext;
        subtextEl.style.opacity = '1';
      }, 100);
    }

    // Update price with smooth transition
    const price = document.getElementById('price-input').value || '$799,000';
    const priceEl = document.getElementById('preview-price');
    if (priceEl.textContent !== price) {
      priceEl.style.opacity = '0.5';
      setTimeout(() => {
        priceEl.textContent = price;
        priceEl.style.opacity = '1';
      }, 100);
    }

    // Update address with smooth transition
    const address = document.getElementById('address-input').value || '123 Main Street';
    const addressEl = document.getElementById('preview-address');
    if (addressEl.textContent !== address) {
      addressEl.style.opacity = '0.5';
      setTimeout(() => {
        addressEl.textContent = address;
        addressEl.style.opacity = '1';
      }, 100);
    }

    // Update custom text with smooth transition
    const customText = document.getElementById('custom-text-input').value;
    const customTextEl = document.getElementById('preview-custom-text');
    if (customText && customText.trim()) {
      customTextEl.style.display = 'block';
      if (customTextEl.textContent !== customText) {
        customTextEl.style.opacity = '0.5';
        setTimeout(() => {
          customTextEl.textContent = customText;
          customTextEl.style.opacity = '1';
        }, 100);
      }
    } else {
      customTextEl.style.display = 'none';
    }
  }

  // Initialize preview on page load
  document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    
    // Add smooth transition CSS
    const style = document.createElement('style');
    style.textContent = `
      .preview-headline, .preview-subtext, .preview-price, .preview-address, .preview-custom-text {
        transition: opacity 0.15s ease-in-out;
      }
    `;
    document.head.appendChild(style);
  });

  // AI Text Refinement
  async function refineText(field) {
    const inputId = field === 'headline' ? 'headline-input' : 
                    field === 'subtext' ? 'subtext-input' : 
                    'custom-text-input';
    
    const input = document.getElementById(inputId);
    const originalText = input.value.trim();
    
    if (!originalText) {
      alert('Please enter some text first!');
      return;
    }
    
    // Disable button and show loading
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '‚è≥';
    
    try {
      const response = await fetch('/agent/marketing/refine-text', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: originalText,
          field: field
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        input.value = data.refined_text;
        updatePreview();
        button.innerHTML = '‚úÖ';
        setTimeout(() => {
          button.innerHTML = originalContent;
          button.disabled = false;
        }, 2000);
      } else {
        alert('Failed to enhance text. Please try again.');
        button.innerHTML = originalContent;
        button.disabled = false;
      }
    } catch (error) {
      console.error('Error refining text:', error);
      alert('Failed to enhance text. Please try again.');
      button.innerHTML = originalContent;
      button.disabled = false;
    }
  }

  // Handle property photo uploads
  function handlePropertyPhotos(input) {
    const previewGrid = document.getElementById('photo-preview-grid');
    previewGrid.innerHTML = '';
    
    if (input.files && input.files.length > 0) {
      // Limit to 3 photos
      const filesToProcess = Array.from(input.files).slice(0, 3);
      
      filesToProcess.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const previewDiv = document.createElement('div');
          previewDiv.style.cssText = 'position: relative; aspect-ratio: 4/3; border-radius: 8px; overflow: hidden; border: 2px solid rgba(200, 180, 151, 0.3);';
          
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = '√ó';
          removeBtn.type = 'button';
          removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border-radius: 50%; background: rgba(255, 255, 255, 0.9); border: none; cursor: pointer; font-size: 18px; line-height: 1; color: #333;';
          removeBtn.onclick = () => {
            previewDiv.remove();
            if (previewGrid.children.length === 0) {
              input.value = '';
            }
          };
          
          previewDiv.appendChild(img);
          previewDiv.appendChild(removeBtn);
          previewGrid.appendChild(previewDiv);
        };
        
        reader.readAsDataURL(file);
      });
      
      if (input.files.length > 3) {
        alert('Maximum 3 property photos allowed. Only the first 3 will be used.');
      }
    }
  }
</script>

{% endblock %}

