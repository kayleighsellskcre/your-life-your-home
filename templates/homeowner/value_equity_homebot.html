{% extends "homeowner/layout.html" %}
{% block title %}Equity Overview ‚Ä¢ Your Life Your Home{% endblock %}

{% block homeowner_content %}
<style>
  .homebot-hero {
    text-align: center;
    padding: 3rem 2rem 2rem;
    background: linear-gradient(135deg, #6B6A45 0%, #8B7A5A 100%);
    color: white;
    margin-bottom: 2rem;
    border-radius: var(--border-radius-lg);
  }
  
  .homebot-hero h1 {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    color: white;
  }
  
  .homebot-hero p {
    font-size: 1.1rem;
    opacity: 0.95;
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.6;
  }
  
  .professional-info {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    box-shadow: var(--shadow-light);
  }
  
  .professional-info img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--olive-green);
  }
  
  .professional-info-content h2 {
    font-size: 1.3rem;
    color: var(--charcoal-brown);
    margin-bottom: 0.5rem;
  }
  
  .professional-info-content p {
    color: var(--charcoal-brown);
    opacity: 0.8;
    margin: 0.25rem 0;
  }
  
  .widget-section {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 0;
    min-height: 800px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    position: relative;
    isolation: isolate;
    margin-bottom: 3rem;
  }
  
  /* Ensure widget section doesn't cause page scroll issues */
  .widget-section::after {
    content: '';
    display: block;
    clear: both;
  }
  
  .widget-header {
    background: linear-gradient(135deg, #6B6A45 0%, #8B7A5A 100%);
    color: white;
    padding: 1.5rem 2rem;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  .widget-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .widget-header p {
    margin: 0.5rem 0 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }
  
  #homebot_homeowner {
    width: 100%;
    min-height: 700px;
    position: relative;
    border: none;
    margin: 0;
    padding: 0;
    display: block;
    z-index: 1;
    pointer-events: auto;
    background: var(--white);
  }
  
  #homebot_homeowner iframe {
    width: 100% !important;
    min-height: 700px !important;
    border: none !important;
    display: block !important;
    pointer-events: auto !important;
    transition: height 0.3s ease;
  }
  
  /* Prevent any parent click handlers from interfering */
  .widget-section * {
    pointer-events: auto;
  }
  
  .ylh-actions-below {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 3rem;
  }
  
  .ylh-action-card {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    display: block;
  }
  
  .ylh-action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    border-color: var(--olive-green);
  }
  
  .ylh-action-card h3 {
    color: var(--charcoal-brown);
    margin: 0 0 0.75rem;
    font-size: 1.3rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .ylh-action-card p {
    color: #666;
    margin: 0;
    line-height: 1.6;
    font-size: 0.95rem;
  }
  
  .no-homebot-message {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--white);
    border: 2px dashed var(--taupe-beige);
    border-radius: var(--border-radius-lg);
  }
  
  .no-homebot-message h2 {
    color: var(--charcoal-brown);
    margin-bottom: 1rem;
  }
  
  .no-homebot-message p {
    color: var(--charcoal-brown);
    opacity: 0.8;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto 1.5rem;
  }
</style>

<div class="homebot-hero">
  <h1>üè† Your Home Equity Dashboard</h1>
  <p>
    Everything you need to track your home's value, understand your equity, and explore your options ‚Äì 
    all in one place, powered by Homebot and personalized by your real estate professional.
  </p>
</div>

{% if professional_info %}
<div class="professional-info">
  {% if professional_info.professional_photo %}
  <img src="{{ url_for('static', filename=professional_info.professional_photo) if not professional_info.professional_photo.startswith('http') else professional_info.professional_photo }}" alt="{{ professional_info.name }}">
  {% else %}
  <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--olive-green); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">
    {{ professional_info.name[0] if professional_info.name else '?' }}
  </div>
  {% endif %}
  <div class="professional-info-content">
    <h2>Your Real Estate Professional</h2>
    <p><strong>{{ professional_info.name }}</strong></p>
    {% if professional_info.brokerage_name %}
    <p>{{ professional_info.brokerage_name }}{% if professional_info.team_name %} - {{ professional_info.team_name }}{% endif %}</p>
    {% endif %}
    {% if professional_info.email %}
    <p style="margin-top: 0.5rem;">
      <a href="mailto:{{ professional_info.email }}" style="color: var(--olive-green); text-decoration: none;">
        {{ professional_info.email }}
      </a>
    </p>
    {% endif %}
  </div>
</div>
{% endif %}

{% if snapshot and (snapshot.value_estimate or snapshot.loan_balance) %}
<!-- Homebot Synced Data Display -->
<div class="dashboard-section" style="margin-bottom: 2rem;">
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
    {% if snapshot.value_estimate %}
    <div class="card" style="background: linear-gradient(135deg, #6B6A45 0%, #8B7A5A 100%); color: white; border: none;">
      <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Home Value</div>
      <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">${{ "{:,.0f}".format(snapshot.value_estimate) }}</div>
      <div style="font-size: 0.75rem; opacity: 0.8;">Synced from Homebot</div>
    </div>
    {% endif %}
    
    {% if snapshot.loan_balance %}
    <div class="card" style="background: linear-gradient(135deg, #8B7A5A 0%, #A69B7A 100%); color: white; border: none;">
      <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Loan Balance</div>
      <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">${{ "{:,.0f}".format(snapshot.loan_balance) }}</div>
      <div style="font-size: 0.75rem; opacity: 0.8;">Synced from Homebot</div>
    </div>
    {% endif %}
    
    {% if snapshot.equity_estimate %}
    <div class="card" style="background: linear-gradient(135deg, #5A6D47 0%, #6B6A45 100%); color: white; border: none;">
      <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">Your Equity</div>
      <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">${{ "{:,.0f}".format(snapshot.equity_estimate) }}</div>
      <div style="font-size: 0.75rem; opacity: 0.8;">Synced from Homebot</div>
    </div>
    {% endif %}
    
    {% if snapshot.loan_rate %}
    <div class="card" style="background: var(--white); border: 2px solid var(--taupe-beige);">
      <div style="font-size: 0.85rem; color: var(--olive-green); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Interest Rate</div>
      <div style="font-size: 1.75rem; font-weight: 700; color: var(--charcoal-brown); margin-bottom: 0.5rem;">{{ "{:.2f}".format(snapshot.loan_rate) }}%</div>
      <div style="font-size: 0.75rem; color: #999;">Synced from Homebot</div>
    </div>
    {% endif %}
    
    {% if snapshot.loan_payment %}
    <div class="card" style="background: var(--white); border: 2px solid var(--taupe-beige);">
      <div style="font-size: 0.85rem; color: var(--olive-green); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Monthly Payment</div>
      <div style="font-size: 1.75rem; font-weight: 700; color: var(--charcoal-brown); margin-bottom: 0.5rem;">${{ "{:,.0f}".format(snapshot.loan_payment) }}</div>
      <div style="font-size: 0.75rem; color: #999;">Synced from Homebot</div>
    </div>
    {% endif %}
  </div>
  
  {% if snapshot.value_estimate and snapshot.loan_balance %}
  <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light-cream); border-radius: var(--border-radius); border-left: 4px solid var(--olive-green);">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
      <span style="font-size: 1.2rem;">üìä</span>
      <strong style="color: var(--charcoal-brown);">Loan-to-Value (LTV):</strong>
      <span style="color: var(--olive-green); font-weight: 700; font-size: 1.1rem;">
        {{ "{:.1f}".format((snapshot.loan_balance / snapshot.value_estimate) * 100) }}%
      </span>
    </div>
    <p style="margin: 0; font-size: 0.9rem; color: #666;">
      This data is automatically synced from Homebot when you link your account. 
      {% if snapshot.updated_at %}
      Last updated: {{ snapshot.updated_at[:10] if snapshot.updated_at else 'Recently' }}
      {% endif %}
    </p>
  </div>
  {% endif %}
</div>
{% endif %}

<div class="widget-section">
  {% if homebot_widget_id %}
    <div class="widget-header">
      <h2>
        <span>üè†</span>
        <span>Your Home Value & Equity Dashboard</span>
      </h2>
      <p>Powered by Homebot ‚Ä¢ All tools and scenarios run right here in your dashboard</p>
    </div>
    <div id="homebot_homeowner" style="width: 100%; min-height: 700px; position: relative;"></div>
  {% else %}
    <div class="no-homebot-message">
      <h2>Homebot Not Connected</h2>
      <p>
        Your {{ 'agent' if professional_info and professional_info.role == 'agent' else 'lender' }} hasn't connected their Homebot account yet.
      </p>
      <p>
        Please reach out to them directly for equity updates and home value tracking.
      </p>
      {% if professional_info and professional_info.email %}
      <a href="mailto:{{ professional_info.email }}" style="display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--olive-green); color: white; text-decoration: none; border-radius: var(--border-radius); font-weight: 500;">
        Contact {{ professional_info.name }}
      </a>
      {% endif %}
    </div>
  {% endif %}
</div>

<!-- YLYH Action Cards Below Widget -->
<div class="ylh-actions-below">
  <a href="{{ url_for('homeowner_value_my_home') }}" class="ylh-action-card">
    <h3>
      <span>üìä</span>
      <span>Get Instant Home Worth</span>
    </h3>
    <p>Pull a comprehensive home value report with comparable sales, market trends, and detailed property insights.</p>
  </a>
  
  <a href="{{ url_for('homeowner_reno_planner') }}" class="ylh-action-card">
    <h3>
      <span>üî®</span>
      <span>Plan Your Renovations</span>
    </h3>
    <p>Explore how your home equity can fund your next renovation project. Calculate ROI and plan your upgrades.</p>
  </a>
  
  <a href="{{ url_for('homeowner_next_plan_move') }}" class="ylh-action-card">
    <h3>
      <span>üè°</span>
      <span>Plan Your Next Move</span>
    </h3>
    <p>Use your current home equity to plan your next home purchase. Calculate affordability and explore options.</p>
  </a>
  
  {% if professional_info and professional_info.email %}
  <a href="mailto:{{ professional_info.email }}?subject=Home Equity Questions" class="ylh-action-card">
    <h3>
      <span>üí¨</span>
      <span>Talk to Your Professional</span>
    </h3>
    <p>Have questions about your home value or equity? Reach out to {{ professional_info.name }} for personalized guidance.</p>
  </a>
  {% endif %}
</div>

{% if homebot_widget_id %}
<script>
  // CRITICAL: Isolate Homebot widget from any page-level click handlers
  (function() {
    'use strict';
    
    // Mark widget container so other scripts can identify it
    var widgetContainer = document.getElementById('homebot_homeowner');
    var widgetSection = document.querySelector('.widget-section');
    
    if (widgetContainer) {
      // Add data attribute to identify widget area
      widgetContainer.setAttribute('data-homebot-widget', 'true');
      if (widgetSection) {
        widgetSection.setAttribute('data-homebot-widget', 'true');
      }
      
      // Stop event propagation at the container level
      ['click', 'mousedown', 'mouseup', 'submit', 'focusin', 'focusout'].forEach(function(eventType) {
        widgetContainer.addEventListener(eventType, function(e) {
          e.stopPropagation();
        }, true); // Capture phase
      });
    }
  })();

  // Homebot embed code - EXACT format from Homebot's embed instructions
  (function (h, b) {
    var w = window, d = document, s = 'script', x, y;
    w['_hb_namespace'] = h;
    w[h] = w[h] || function () { (w[h].q = w[h].q || []).push(arguments); };
    y = d.createElement(s); 
    x = d.getElementsByTagName(s)[0];
    y.async = 1;
    y.src = 'https://embed.homebotapp.com/lgw/v1/widget.js';
    x.parentNode.insertBefore(y, x);
  })('Homebot');

  // Initialize widget - Clean and simple
  (function() {
    // Get widget ID - ensure it's a clean string, not HTML
    var widgetId = '{{ homebot_widget_id|e }}';
    
    // Clean the widget ID - remove any HTML tags or extra content
    widgetId = widgetId.trim();
    
    // If widget ID contains HTML tags, extract just the ID
    if (widgetId.indexOf('<') !== -1 || widgetId.indexOf('&lt;') !== -1) {
      console.error('[HOMEBOT] ‚ùå Widget ID appears to contain HTML. Expected just the ID string.');
      // Try to extract ID from common patterns
      var idMatch = widgetId.match(/['"]([a-f0-9]{40,})['"]/);
      if (idMatch) {
        widgetId = idMatch[1];
        console.log('[HOMEBOT] Extracted widget ID:', widgetId);
      } else {
        console.error('[HOMEBOT] ‚ùå Could not extract valid widget ID');
        return;
      }
    }
    
    var container = '#homebot_homeowner';
    var maxAttempts = 50;
    var attempts = 0;
    
    console.log('[HOMEBOT] Starting initialization...');
    console.log('[HOMEBOT] Widget ID (cleaned):', widgetId);
    console.log('[HOMEBOT] Widget ID length:', widgetId.length);
    console.log('[HOMEBOT] Container:', container);
    
    function initHomebot() {
      attempts++;
      
      if (typeof window.Homebot === 'function') {
        console.log('[HOMEBOT] ‚úÖ Homebot function found, initializing widget...');
        try {
          // Use exact Homebot format: Homebot(container, widgetId)
          window.Homebot(container, widgetId);
          console.log('[HOMEBOT] ‚úÖ Widget initialization call completed');
          
          // Verify iframe creation and functionality
          setTimeout(function() {
            var containerEl = document.querySelector(container);
            if (containerEl) {
              var iframe = containerEl.querySelector('iframe');
              if (iframe) {
                console.log('[HOMEBOT] ‚úÖ‚úÖ‚úÖ Iframe successfully created!');
                console.log('[HOMEBOT] Iframe src:', iframe.src);
                console.log('[HOMEBOT] Iframe dimensions:', iframe.offsetWidth + 'x' + iframe.offsetHeight);
                
                // CRITICAL: Ensure iframe can receive ALL events and submit forms
                // DO NOT use sandbox - it blocks form submissions!
                // Homebot needs full iframe functionality
                iframe.style.pointerEvents = 'auto';
                iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen; geolocation');
                iframe.setAttribute('allowfullscreen', 'true');
                
                // Force pointer events
                iframe.style.cssText += 'pointer-events: auto !important;';
                
                // Monitor for widget interactions and prevent redirects
                iframe.addEventListener('load', function() {
                  console.log('[HOMEBOT] ‚úÖ Iframe content loaded - widget should be fully functional');
                  console.log('[HOMEBOT] Iframe allow:', iframe.getAttribute('allow'));
                  console.log('[HOMEBOT] Iframe pointer-events:', window.getComputedStyle(iframe).pointerEvents);
                  
                  // Ensure pointer events are still active after load
                  setTimeout(function() {
                    iframe.style.pointerEvents = 'auto';
                    console.log('[HOMEBOT] ‚úÖ Pointer events confirmed: auto');
                  }, 500);
                  
                  // Prevent any navigation away from the page
                  // The iframe should handle all interactions internally
                  try {
                    var iframeWindow = iframe.contentWindow;
                    if (iframeWindow) {
                      // Override any top-level navigation attempts
                      var originalOpen = iframeWindow.open;
                      if (originalOpen) {
                        iframeWindow.open = function(url, target) {
                          // If trying to open in parent/top, open in new tab instead
                          if (target === '_parent' || target === '_top') {
                            window.open(url, '_blank');
                            return null;
                          }
                          return originalOpen.call(this, url, target);
                        };
                      }
                    }
                  } catch (e) {
                    // CORS - can't access iframe content, which is fine
                    console.log('[HOMEBOT] ‚ÑπÔ∏è Cannot access iframe window (CORS) - widget will handle navigation internally');
                  }
                });
                
                // Listen for any messages from the iframe (Homebot might send postMessage)
                window.addEventListener('message', function(event) {
                  // Only accept messages from Homebot domains
                  if (event.origin.includes('homebotapp.com')) {
                    console.log('[HOMEBOT] Message received from widget:', event.data);
                    
                    // Handle iframe resize requests (Homebot might request height changes)
                    if (event.data && (event.data.type === 'resize' || event.data.height)) {
                      var newHeight = event.data.height || event.data;
                      if (typeof newHeight === 'number' && newHeight > 0) {
                        iframe.style.height = newHeight + 'px';
                        containerEl.style.minHeight = newHeight + 'px';
                        console.log('[HOMEBOT] Iframe resized to:', newHeight + 'px');
                      }
                    }
                    
                    // Handle any navigation requests by keeping them in the iframe
                    if (event.data && event.data.type === 'navigate') {
                      // Prevent navigation - widget should handle internally
                      console.log('[HOMEBOT] Navigation request intercepted - keeping in iframe');
                    }
                  }
                });
                
                // Monitor iframe for dynamic content changes and auto-resize
                var resizeObserver = new ResizeObserver(function(entries) {
                  for (var entry of entries) {
                    var height = entry.contentRect.height;
                    if (height > 0) {
                      iframe.style.height = height + 'px';
                      console.log('[HOMEBOT] Auto-resized iframe to:', height + 'px');
                    }
                  }
                });
                
                // Try to observe iframe content (may fail due to CORS)
                try {
                  var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                  if (iframeDoc && iframeDoc.body) {
                    resizeObserver.observe(iframeDoc.body);
                  }
                } catch (e) {
                  console.log('[HOMEBOT] ‚ÑπÔ∏è Cannot observe iframe content (CORS) - will use postMessage for resize');
                }
              } else {
                console.warn('[HOMEBOT] ‚ö†Ô∏è Iframe not found after initialization');
              }
            }
          }, 2000);
        } catch (error) {
          console.error('[HOMEBOT] ‚ùå Error during initialization:', error);
          console.error('[HOMEBOT] Error stack:', error.stack);
        }
      } else if (window.Homebot && Array.isArray(window.Homebot.q)) {
        // Homebot is queuing - our call is already queued, just wait
        console.log('[HOMEBOT] Homebot script loading, call queued...');
        if (attempts < maxAttempts) {
          setTimeout(initHomebot, 100);
        }
      } else if (attempts < maxAttempts) {
        // Keep waiting for Homebot to load
        if (attempts % 10 === 0) {
          console.log('[HOMEBOT] Waiting for Homebot script... (attempt ' + attempts + ')');
        }
        setTimeout(initHomebot, 100);
      } else {
        console.error('[HOMEBOT] ‚ùå Failed to load Homebot after', maxAttempts, 'attempts');
        var containerEl = document.querySelector(container);
        if (containerEl) {
          containerEl.innerHTML = '<div style="padding: 2rem; text-align: center; color: #d32f2f;"><p style="margin-bottom: 1rem; font-weight: 600;">‚ö†Ô∏è Unable to load Homebot widget</p><p style="font-size: 0.9rem;">Please check your browser console for errors or try refreshing the page.</p></div>';
        }
      }
    }
    
    // Start initialization - wait for DOM and a bit more for other scripts
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit longer to ensure other scripts don't interfere
        setTimeout(initHomebot, 800);
      });
    } else {
      // DOM already loaded
      setTimeout(initHomebot, 800);
    }
  })();
</script>
{% endif %}

{% endblock %}
