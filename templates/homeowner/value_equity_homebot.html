{% extends "homeowner/layout.html" %}
{% block title %}Value & Equity • Your Life Your Home{% endblock %}

{% block homeowner_content %}
<style>
  /* ===========================
     VALUE & EQUITY PAGE
     Organic • Luxurious • Effortless
     =========================== */
  
  .value-equity-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 3rem 2rem;
  }
  
  /* PAGE HEADER */
  .page-header {
    margin-bottom: 3rem;
    text-align: center;
  }
  
  .page-header h1 {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    color: var(--charcoal-brown);
    margin-bottom: 0.75rem;
    font-weight: 400;
  }
  
  .page-header p {
    font-size: 1.125rem;
    color: rgba(58, 53, 44, 0.7);
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto;
  }
  
  /* FINANCIAL SNAPSHOT CARDS */
  .snapshot-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }
  
  .snapshot-card {
    background: var(--white);
    border: 1px solid rgba(107, 106, 69, 0.15);
    border-radius: 12px;
    padding: 2rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 16px rgba(58, 53, 44, 0.08);
  }
  
  .snapshot-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(58, 53, 44, 0.12);
    border-color: rgba(107, 106, 69, 0.25);
  }
  
  .snapshot-card-label {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(58, 53, 44, 0.6);
    margin-bottom: 0.75rem;
  }
  
  .snapshot-card-value {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    font-weight: 400;
    color: var(--charcoal-brown);
    margin-bottom: 0.5rem;
    line-height: 1.2;
  }
  
  .snapshot-card-sublabel {
    font-size: 0.9rem;
    color: rgba(58, 53, 44, 0.6);
    line-height: 1.5;
  }
  
  .snapshot-card-edit {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid var(--taupe-beige);
    border-radius: 6px;
    color: var(--olive-green);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .snapshot-card-edit:hover {
    background: var(--light-cream);
    border-color: var(--olive-green);
  }
  
  /* HOMEBOT WIDGET SECTION */
  .homebot-section {
    background: linear-gradient(135deg, rgba(107, 106, 69, 0.05) 0%, rgba(200, 180, 151, 0.05) 100%);
    border: 1px solid rgba(107, 106, 69, 0.15);
    border-radius: 16px;
    padding: 2.5rem;
    margin-bottom: 3rem;
    position: relative;
    overflow: hidden;
  }
  
  .homebot-section::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(107, 106, 69, 0.08) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
  }
  
  .homebot-section h2 {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    color: var(--charcoal-brown);
    margin-bottom: 1rem;
    font-weight: 400;
  }
  
  .homebot-section p {
    font-size: 1rem;
    color: rgba(58, 53, 44, 0.7);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }
  
  .homebot-widget {
    background: var(--white);
    border-radius: 12px;
    padding: 2rem;
    min-height: 400px;
    box-shadow: 0 4px 16px rgba(58, 53, 44, 0.08);
    position: relative;
    z-index: 1;
  }
  
  /* TABS SECTION */
  .tabs-container {
    background: var(--white);
    border: 1px solid rgba(107, 106, 69, 0.15);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 3rem;
  }
  
  .tabs-nav {
    display: flex;
    border-bottom: 1px solid rgba(107, 106, 69, 0.15);
    background: var(--light-cream);
  }
  
  .tab-button {
    flex: 1;
    padding: 1.25rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(58, 53, 44, 0.6);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .tab-button:hover {
    background: rgba(107, 106, 69, 0.08);
    color: var(--charcoal-brown);
  }
  
  .tab-button.active {
    color: var(--charcoal-brown);
    border-bottom-color: var(--olive-green);
    background: var(--white);
    font-weight: 700;
  }
  
  .tab-content {
    padding: 2.5rem;
  }
  
  .tab-panel {
    display: none;
  }
  
  .tab-panel.active {
    display: block;
  }
  
  .tab-panel h3 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    color: var(--charcoal-brown);
    margin-bottom: 1rem;
    font-weight: 400;
  }
  
  .tab-panel p {
    font-size: 1rem;
    color: rgba(58, 53, 44, 0.7);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }
  
  /* INFO CARDS */
  .info-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }
  
  .info-card {
    background: var(--light-cream);
    border: 1px solid rgba(107, 106, 69, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
  }
  
  .info-card h4 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--charcoal-brown);
    margin-bottom: 0.75rem;
  }
  
  .info-card p {
    font-size: 0.9rem;
    color: rgba(58, 53, 44, 0.7);
    line-height: 1.6;
    margin: 0;
  }
  
  /* CHART CONTAINER */
  .chart-container {
    background: var(--light-cream);
    border: 1px solid rgba(107, 106, 69, 0.1);
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
    min-height: 350px;
  }
  
  /* MOBILE RESPONSIVE */
  @media (max-width: 768px) {
    .value-equity-page {
      padding: 2rem 1rem;
    }
    
    .page-header h1 {
      font-size: 1.75rem;
    }
    
    .page-header p {
      font-size: 1rem;
    }
    
    .snapshot-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .snapshot-card {
      padding: 1.5rem;
    }
    
    .snapshot-card-value {
      font-size: 2rem;
    }
    
    .homebot-section {
      padding: 1.5rem;
    }
    
    .homebot-section h2 {
      font-size: 1.5rem;
    }
    
    .homebot-widget {
      padding: 1rem;
      min-height: 300px;
    }
    
    .tabs-nav {
      flex-direction: column;
    }
    
    .tab-button {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid rgba(107, 106, 69, 0.1);
      border-left: 3px solid transparent;
    }
    
    .tab-button.active {
      border-left-color: var(--olive-green);
      border-bottom-color: rgba(107, 106, 69, 0.1);
    }
    
    .tab-content {
      padding: 1.5rem;
    }
    
    .info-cards-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .chart-container {
      padding: 1rem;
      min-height: 250px;
    }
  }
  
  /* PROPERTY SELECTOR */
  .property-selector {
    background: var(--light-cream);
    border: 1px solid rgba(107, 106, 69, 0.15);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .property-selector label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--charcoal-brown);
  }
  
  .property-selector select {
    flex: 1;
    min-width: 200px;
    padding: 0.625rem 1rem;
    border: 1px solid var(--taupe-beige);
    border-radius: 6px;
    background: var(--white);
    font-size: 0.9rem;
    color: var(--charcoal-brown);
  }
  
  .property-selector button {
    padding: 0.625rem 1.25rem;
    background: var(--olive-green);
    color: var(--white);
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .property-selector button:hover {
    background: #5A5938;
  }
  
  /* MODALS */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  
  .modal-overlay.active {
    display: flex;
  }
  
  .modal-content {
    background: var(--white);
    border-radius: 16px;
    padding: 2.5rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .modal-header h2 {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    color: var(--charcoal-brown);
    margin-bottom: 1.5rem;
    font-weight: 400;
  }
  
  .modal-body {
    margin-bottom: 2rem;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--olive-green);
    margin-bottom: 0.5rem;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.875rem;
    border: 2px solid var(--taupe-beige);
    border-radius: 6px;
    font-size: 1rem;
    color: var(--charcoal-brown);
    background: var(--white);
    transition: all 0.2s ease;
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--olive-green);
    box-shadow: 0 0 0 3px rgba(107, 106, 69, 0.1);
  }
  
  .modal-footer {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }
  
  .btn-secondary {
    padding: 0.875rem 1.5rem;
    background: var(--light-cream);
    border: 1px solid var(--taupe-beige);
    border-radius: 8px;
    color: var(--charcoal-brown);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-secondary:hover {
    background: #E5E1D3;
  }
  
  .btn-primary {
    padding: 0.875rem 1.5rem;
    background: var(--olive-green);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-primary:hover {
    background: #5A5938;
  }
  
  @media (max-width: 768px) {
    .modal-content {
      padding: 1.5rem;
      max-height: 95vh;
    }
    
    .modal-footer {
      flex-direction: column;
    }
    
    .btn-secondary,
    .btn-primary {
      width: 100%;
    }
  }
</style>

<div class="value-equity-page">
  <!-- Page Header -->
  <div class="page-header">
    <h1>Value & Equity</h1>
    <p>Track your home's value, equity growth, and financial position with clarity and confidence.</p>
  </div>
  
  <!-- Property Selector (if multiple properties) -->
  {% if user_properties and user_properties|length > 1 %}
  <div class="property-selector">
    <form method="POST" action="{{ url_for('homeowner_switch_property') }}" style="display: flex; align-items: center; gap: 1rem; width: 100%; flex-wrap: wrap;">
      <label for="property_select">Viewing Property:</label>
      <select name="property_id" id="property_select">
        {% for prop in user_properties %}
          <option value="{{ prop.property_id }}" {% if current_property and prop.property_id == current_property.property_id %}selected{% endif %}>
            {{ prop.address or 'Property ' + loop.index|string }}
          </option>
        {% endfor %}
      </select>
      <button type="submit">Switch</button>
    </form>
  </div>
  {% endif %}
  
  <!-- Financial Snapshot Cards -->
  <div class="snapshot-grid">
    <!-- Home Value -->
    <div class="snapshot-card">
      <div class="snapshot-card-label">Estimated Home Value</div>
      <div class="snapshot-card-value">
        {% if snapshot and snapshot.get('value_estimate') %}
          ${{ "{:,}".format(snapshot.get('value_estimate')|int) }}
        {% else %}
          —
        {% endif %}
      </div>
      <div class="snapshot-card-sublabel">Your home's current market value</div>
      <button class="snapshot-card-edit" onclick="openEditModal('value')">Update Value</button>
    </div>
    
    <!-- Equity -->
    <div class="snapshot-card">
      <div class="snapshot-card-label">Total Equity</div>
      <div class="snapshot-card-value">
        {% if snapshot and snapshot.get('equity_estimate') %}
          ${{ "{:,}".format(snapshot.get('equity_estimate')|int) }}
        {% elif snapshot and snapshot.get('value_estimate') and snapshot.get('loan_balance') %}
          ${{ "{:,}".format((snapshot.get('value_estimate') - snapshot.get('loan_balance'))|int) }}
        {% else %}
          —
        {% endif %}
      </div>
      <div class="snapshot-card-sublabel">Value minus loan balance</div>
    </div>
    
    <!-- Loan Balance -->
    <div class="snapshot-card">
      <div class="snapshot-card-label">Loan Balance</div>
      <div class="snapshot-card-value">
        {% if snapshot and snapshot.get('loan_balance') %}
          ${{ "{:,}".format(snapshot.get('loan_balance')|int) }}
        {% else %}
          —
        {% endif %}
      </div>
      <div class="snapshot-card-sublabel">Current mortgage balance</div>
      <button class="snapshot-card-edit" onclick="openEditModal('loan')">Update Loan</button>
    </div>
  </div>
  
  <!-- Homebot Widget Section -->
  <div class="homebot-section">
    <h2>Your Homebot Digest</h2>
    <p>Get personalized insights about your home's value, equity opportunities, and market trends.</p>
    <div class="homebot-widget">
      {% if homebot_widget_html %}
        {{ homebot_widget_html|safe }}
      {% else %}
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(58, 53, 44, 0.5);">
          <p>Homebot insights will appear here once configured.</p>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Tabs Section -->
  <div class="tabs-container">
    <div class="tabs-nav">
      <button class="tab-button active" onclick="switchTab(event, 'overview')">Overview</button>
      <button class="tab-button" onclick="switchTab(event, 'scenarios')">Scenarios</button>
      <button class="tab-button" onclick="switchTab(event, 'history')">History</button>
    </div>
    
    <div class="tab-content">
      <!-- Overview Panel -->
      <div class="tab-panel active" id="overview">
        <h3>Financial Overview</h3>
        <p>A clear snapshot of your home's financial position and key metrics.</p>
        
        <div class="info-cards-grid">
          <div class="info-card">
            <h4>Loan-to-Value (LTV)</h4>
            <p>
              {% if snapshot and snapshot.get('value_estimate') and snapshot.get('loan_balance') and snapshot.get('value_estimate') > 0 %}
                {% set ltv = (snapshot.get('loan_balance') / snapshot.get('value_estimate') * 100) %}
                {{ "%.1f"|format(ltv) }}%
              {% else %}
                —
              {% endif %}
            </p>
          </div>
          
          <div class="info-card">
            <h4>Interest Rate</h4>
            <p>
              {% if snapshot and snapshot.get('loan_rate') %}
                {{ "%.2f"|format(snapshot.get('loan_rate')) }}%
              {% else %}
                —
              {% endif %}
            </p>
          </div>
          
          <div class="info-card">
            <h4>Monthly Payment</h4>
            <p>
              {% if snapshot and snapshot.get('loan_payment') %}
                ${{ "{:,}".format(snapshot.get('loan_payment')|int) }}
              {% else %}
                —
              {% endif %}
            </p>
          </div>
        </div>
      </div>
      
      <!-- Scenarios Panel -->
      <div class="tab-panel" id="scenarios">
        <h3>What-If Scenarios</h3>
        <p>Explore different financial scenarios to understand your options and opportunities.</p>
        
        <div class="info-cards-grid">
          <div class="info-card">
            <h4>Refinance Opportunity</h4>
            <p>See how refinancing at today's rates could impact your monthly payment and long-term savings.</p>
          </div>
          
          <div class="info-card">
            <h4>Cash-Out Refinance</h4>
            <p>Unlock your equity for renovations, investments, or other financial goals.</p>
          </div>
          
          <div class="info-card">
            <h4>Future Value Projection</h4>
            <p>Estimate your home's value and equity growth over the next 1, 3, or 5 years.</p>
          </div>
        </div>
      </div>
      
      <!-- History Panel -->
      <div class="tab-panel" id="history">
        <h3>Value & Equity History</h3>
        <p>Track how your home's value, loan balance, and equity have changed over time.</p>
        
        {% if snapshot_history and snapshot_history|length > 0 %}
        <div class="chart-container">
          <canvas id="equityChart"></canvas>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
        <script>
          (function() {
            const historyData = {{ snapshot_history|tojson|safe }};
            if (historyData && Array.isArray(historyData) && historyData.length > 0) {
              const ctx = document.getElementById('equityChart');
              if (ctx) {
                const dates = historyData.map(h => {
                  const d = h.snapshot_date ? h.snapshot_date.substring(0, 10) : '';
                  return d || '—';
                }).reverse();
                const values = historyData.map(h => h.value_estimate || 0).reverse();
                const balances = historyData.map(h => h.loan_balance || 0).reverse();
                const equities = historyData.map(h => {
                  if (h.equity_estimate) return h.equity_estimate;
                  if (h.value_estimate && h.loan_balance) return h.value_estimate - h.loan_balance;
                  return 0;
                }).reverse();
                
                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: dates,
                    datasets: [
                      {
                        label: 'Home Value',
                        data: values,
                        borderColor: '#6B6A45',
                        backgroundColor: 'rgba(107, 106, 69, 0.1)',
                        tension: 0.4,
                        fill: false
                      },
                      {
                        label: 'Loan Balance',
                        data: balances,
                        borderColor: '#C8B497',
                        backgroundColor: 'rgba(200, 180, 151, 0.1)',
                        tension: 0.4,
                        fill: false
                      },
                      {
                        label: 'Equity',
                        data: equities,
                        borderColor: '#5A6D47',
                        backgroundColor: 'rgba(90, 109, 71, 0.1)',
                        tension: 0.4,
                        fill: true
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: 'bottom',
                        labels: {
                          font: { family: 'inherit', size: 12 },
                          color: '#3A352C',
                          padding: 16
                        }
                      },
                      tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                          label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                          }
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: false,
                        ticks: {
                          callback: function(value) {
                            return '$' + value.toLocaleString();
                          },
                          font: { size: 11 },
                          color: '#666'
                        },
                        grid: {
                          color: 'rgba(200, 180, 151, 0.2)'
                        }
                      },
                      x: {
                        ticks: {
                          font: { size: 11 },
                          color: '#666',
                          maxRotation: 45,
                          minRotation: 0
                        },
                        grid: {
                          display: false
                        }
                      }
                    }
                  }
                });
              }
            }
          })();
        </script>
        {% else %}
        <div class="info-card">
          <h4>No History Yet</h4>
          <p>As you track your home's value over time, your historical data will appear here.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Edit Value/Loan Modal -->
<div id="editModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="editModalTitle">Update Value</h2>
    </div>
    <form id="editForm" method="POST" action="{{ url_for('homeowner_value_equity_overview') }}">
      <div class="modal-body">
        <div class="form-group">
          <label for="editField" id="editLabel">New Value</label>
          <input type="text" id="editField" name="edit_field" placeholder="e.g., 485,000" required />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Tab Switching
  function switchTab(event, tabName) {
    // Hide all tab panels
    const panels = document.querySelectorAll('.tab-panel');
    panels.forEach(panel => panel.classList.remove('active'));
    
    // Remove active from all buttons
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected panel and activate button
    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');
  }
  
  // Modal Functions
  function openEditModal(type) {
    const modal = document.getElementById('editModal');
    const title = document.getElementById('editModalTitle');
    const label = document.getElementById('editLabel');
    const field = document.getElementById('editField');
    
    if (type === 'value') {
      title.textContent = 'Update Home Value';
      label.textContent = 'Estimated Home Value';
      field.placeholder = 'e.g., 485,000';
      field.name = 'value_estimate';
      {% if snapshot and snapshot.get('value_estimate') %}
      field.value = '{{ snapshot.get("value_estimate")|int }}';
      {% endif %}
    } else if (type === 'loan') {
      title.textContent = 'Update Loan Balance';
      label.textContent = 'Current Loan Balance';
      field.placeholder = 'e.g., 275,000';
      field.name = 'loan_balance';
      {% if snapshot and snapshot.get('loan_balance') %}
      field.value = '{{ snapshot.get("loan_balance")|int }}';
      {% endif %}
    }
    
    modal.classList.add('active');
  }
  
  function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
  }
  
  // Close modal on outside click
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  });
  
  // Format number inputs
  document.getElementById('editField').addEventListener('blur', function() {
    let val = this.value.replace(/,/g, '');
    if (!isNaN(val) && val !== '') {
      this.value = parseInt(val).toLocaleString();
    }
  });
</script>

{% endblock %}
