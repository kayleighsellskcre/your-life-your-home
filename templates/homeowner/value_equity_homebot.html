{% extends "homeowner/layout.html" %}
{% block title %}Equity Center ‚Ä¢ Your Life Your Home{% endblock %}

{% block homeowner_content %}
<style>
  /* Equity Center - Product-Style Layout */
  .equity-page {
    max-width: 1600px;
    margin: 0 auto;
  }

  /* HERO SECTION */
  .equity-hero {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 3rem;
    margin-bottom: 3rem;
    padding: 2.5rem;
    background: linear-gradient(135deg, #6B6A45 0%, #8B7A5A 100%);
    border-radius: var(--border-radius-lg);
    color: white;
  }

  @media (max-width: 1024px) {
    .equity-hero {
      grid-template-columns: 1fr;
    }
  }

  .equity-hero-left {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .equity-hero .eyebrow {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.9;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .equity-hero h1 {
    font-size: 2.5rem;
    font-weight: 400;
    margin: 0 0 1rem;
    color: white;
    font-family: 'Playfair Display', Georgia, serif;
  }
  
  .equity-hero .sub {
    font-size: 1.1rem;
    opacity: 0.95;
    line-height: 1.7;
    margin-bottom: 2rem;
  }

  .equity-status-row {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .status-pill {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 0.75rem 1.25rem;
    border-radius: 50px;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .status-pill .label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.8;
  }

  .status-pill .value {
    font-size: 0.95rem;
    font-weight: 600;
  }

  /* AGENT CARD */
  .equity-hero-right {
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }

  .agent-card {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    max-width: 400px;
    width: 100%;
    color: var(--charcoal-brown);
  }

  .agent-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid var(--olive-green);
    margin-bottom: 1rem;
  }

  .agent-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--olive-green);
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .agent-card h2 {
    font-size: 1.5rem;
    margin: 0 0 0.5rem;
    color: var(--charcoal-brown);
    font-weight: 500;
  }

  .agent-brokerage {
    color: #666;
    margin: 0 0 0.75rem;
    font-size: 0.95rem;
  }

  .agent-contact {
    color: #666;
    font-size: 0.9rem;
    margin: 0.25rem 0;
  }
  
  .agent-cta {
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background: var(--olive-green);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 500;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s ease;
  }

  .agent-cta:hover {
    background: #5A6D47;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(107, 106, 69, 0.3);
  }

  /* SNAPSHOT CARDS */
  .equity-snapshot {
    margin-bottom: 3rem;
  }

  .snapshot-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .snapshot-card {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .snapshot-card.clickable {
    cursor: pointer;
  }

  .snapshot-card.clickable:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    border-color: var(--olive-green);
  }

  .snapshot-card.clickable::after {
    content: '‚Üí';
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    font-size: 1.5rem;
    color: var(--olive-green);
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateX(-10px);
  }

  .snapshot-card.clickable:hover::after {
    opacity: 1;
    transform: translateX(0);
  }

  .snapshot-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--taupe-beige);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
  }

  .snapshot-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
    border-color: var(--olive-green);
  }

  .snapshot-card:hover::before {
    transform: scaleX(1);
    background: var(--olive-green);
  }

  .snapshot-card.snapshot-primary {
    background: linear-gradient(135deg, #6B6A45 0%, #8B7A5A 100%);
    color: white;
    border: none;
  }

  .snapshot-card.snapshot-primary.clickable:hover {
    background: linear-gradient(135deg, #5A6D47 0%, #7A6A4A 100%);
  }

  .snapshot-card.snapshot-primary.clickable::after {
    color: white;
  }

  .snapshot-card.snapshot-primary p[style*="font-size: 0.85rem"] {
    color: rgba(255, 255, 255, 0.9);
  }

  .snapshot-card.snapshot-primary::before {
    background: rgba(255, 255, 255, 0.3);
  }

  .snapshot-card h3 {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 1rem;
    opacity: 0.8;
    font-weight: 600;
  }

  .snapshot-card.snapshot-primary h3 {
    opacity: 0.9;
  }

  .snapshot-card .big-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
    color: var(--charcoal-brown);
    line-height: 1;
  }

  .snapshot-card.snapshot-primary .big-number {
    color: white;
  }

  .snapshot-card .delta {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
  }

  .snapshot-card.snapshot-primary .delta {
    color: rgba(255, 255, 255, 0.9);
  }

  .snapshot-card .hint {
    font-size: 0.85rem;
    color: #999;
    margin: 0;
  }

  .snapshot-card.snapshot-primary .hint {
    color: rgba(255, 255, 255, 0.8);
  }

  /* PROGRESS BAR */
  .paydown-progress {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-light);
  }

  .paydown-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-weight: 600;
    color: var(--charcoal-brown);
  }

  .paydown-label {
    font-size: 0.9rem;
    color: var(--olive-green);
    font-weight: 500;
  }

  .progress-bar {
    height: 12px;
    background: var(--light-cream);
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 1rem;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #6B6A45 0%, #8B7A5A 100%);
    border-radius: 6px;
    transition: width 1s ease;
    position: relative;
  }

  .progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .progress-footer {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: #666;
  }

  /* MAIN AREA WITH TABS */
  .equity-main {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 3rem;
    margin-bottom: 3rem;
  }

  @media (max-width: 1024px) {
    .equity-main {
      grid-template-columns: 1fr;
    }
  }

  .equity-main-left {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 0;
    overflow: hidden;
  }

  /* TABS */
  .equity-tabs {
    display: flex;
    background: var(--light-cream);
    border-bottom: 2px solid var(--taupe-beige);
  }

  .equity-tabs .tab {
    flex: 1;
    padding: 1.25rem 2rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    font-size: 1rem;
    font-weight: 500;
    color: #666;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .equity-tabs .tab:hover {
    color: var(--olive-green);
    background: rgba(107, 106, 69, 0.05);
  }

  .equity-tabs .tab.active {
    color: var(--olive-green);
    border-bottom-color: var(--olive-green);
    background: var(--white);
  }

  /* TAB PANELS */
  .tab-panels {
    padding: 2.5rem;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .tab-panel h2 {
    font-size: 1.75rem;
    margin: 0 0 0.5rem;
    color: var(--charcoal-brown);
    font-weight: 400;
  }

  .panel-sub {
    color: #666;
    margin: 0 0 2rem;
    line-height: 1.6;
  }

  /* HOMEBOT WIDGET CONTAINER */
  .homebot-widget-container {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 0;
    min-height: 700px;
    overflow: hidden;
    position: relative;
    isolation: isolate;
  }
  
  #homebot_homeowner {
    width: 100%;
    min-height: 700px;
    position: relative;
    border: none;
    margin: 0;
    padding: 0;
    display: block;
    z-index: 1;
    pointer-events: auto;
  }

  #homebot_homeowner iframe {
    width: 100% !important;
    min-height: 700px !important;
    border: none !important;
    display: block !important;
    pointer-events: auto !important;
    transition: height 0.3s ease;
  }

  .homebot-skeleton {
    padding: 4rem 2rem;
    text-align: center;
    color: #999;
  }

  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
    background: var(--light-cream);
    border-radius: var(--border-radius-lg);
  }

  .empty-state h3 {
    color: var(--charcoal-brown);
    margin-bottom: 1rem;
  }

  /* SCENARIO CARDS */
  .scenario-grid {
    display: grid;
    gap: 1.5rem;
  }

  .scenario-card {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    transition: all 0.3s ease;
  }

  .scenario-card:hover {
    border-color: var(--olive-green);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .scenario-card h3 {
    font-size: 1.3rem;
    margin: 0 0 0.75rem;
    color: var(--charcoal-brown);
    font-weight: 500;
  }

  .scenario-card p {
    color: #666;
    margin: 0 0 1.5rem;
    line-height: 1.6;
  }

  .scenario-card label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--olive-green);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .scenario-slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--light-cream);
    outline: none;
    -webkit-appearance: none;
    margin-bottom: 1rem;
  }

  .scenario-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--olive-green);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .scenario-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 12px rgba(107, 106, 69, 0.4);
  }

  .scenario-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--olive-green);
    cursor: pointer;
    border: none;
    transition: all 0.2s ease;
  }

  .scenario-output {
    padding: 1rem;
    background: var(--light-cream);
    border-radius: var(--border-radius);
    color: var(--charcoal-brown);
    font-weight: 500;
    margin: 0;
  }

  .linkish {
    background: none;
    border: none;
    color: var(--olive-green);
    text-decoration: underline;
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    font-family: inherit;
  }

  .linkish:hover {
    color: #5A6D47;
  }

  /* HISTORY SECTION */
  .history-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
  }

  @media (max-width: 768px) {
    .history-layout {
      grid-template-columns: 1fr;
    }
  }

  .chart-card {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
  }

  .chart-card h3 {
    font-size: 1.2rem;
    margin: 0 0 1.5rem;
    color: var(--charcoal-brown);
    font-weight: 500;
  }

  .chart-placeholder {
    height: 300px;
    background: var(--light-cream);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    border: 2px dashed var(--taupe-beige);
  }

  .history-list {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 2rem;
  }
  
  .history-list h3 {
    font-size: 1.2rem;
    margin: 0 0 1.5rem;
    color: var(--charcoal-brown);
    font-weight: 500;
  }

  .history-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .history-list li {
    padding: 1rem 0;
    border-bottom: 1px solid var(--taupe-beige);
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    font-size: 0.9rem;
  }

  .history-list li:last-child {
    border-bottom: none;
  }

  .snap-date {
    color: #666;
  }

  .snap-value {
    font-weight: 600;
    color: var(--charcoal-brown);
  }

  .snap-equity {
    color: var(--olive-green);
    font-weight: 500;
  }

  /* RIGHT SIDEBAR */
  .equity-main-right {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .equity-main-right h3 {
    font-size: 1.3rem;
    margin: 0 0 0.5rem;
    color: var(--charcoal-brown);
    font-weight: 500;
  }

  .action-btn {
    width: 100%;
    padding: 1rem 1.5rem;
    background: var(--olive-green);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    font-size: 0.95rem;
  }

  .action-btn:hover {
    background: #5A6D47;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(107, 106, 69, 0.3);
  }

  .action-btn.secondary {
    background: var(--white);
    color: var(--olive-green);
    border: 2px solid var(--olive-green);
  }

  .action-btn.secondary:hover {
    background: var(--light-cream);
  }

  .info-card {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
  }

  .info-card.subtle {
    background: var(--light-cream);
    border-color: rgba(200, 180, 151, 0.3);
  }

  .info-card h4 {
    font-size: 1rem;
    margin: 0 0 0.75rem;
    color: var(--charcoal-brown);
    font-weight: 600;
  }

  .info-card p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
    line-height: 1.6;
  }

  /* INTERACTIVE TOOLTIPS */
  .tooltip-trigger {
    position: relative;
    display: inline-block;
    cursor: help;
    border-bottom: 1px dotted var(--olive-green);
    color: var(--olive-green);
    font-weight: 500;
  }

  .tooltip {
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--charcoal-brown);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: var(--border-radius);
    font-size: 0.85rem;
    width: 250px;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    transform: translateX(-50%) translateY(-10px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: var(--charcoal-brown);
  }

  .tooltip-trigger:hover .tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }

  /* EXPANDABLE EDUCATIONAL CARDS */
  .edu-card {
    background: var(--white);
    border: 2px solid var(--taupe-beige);
    border-radius: var(--border-radius-lg);
    margin-bottom: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .edu-card:hover {
    border-color: var(--olive-green);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .edu-card-header {
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--light-cream);
    transition: background 0.3s ease;
  }

  .edu-card-header:hover {
    background: rgba(107, 106, 69, 0.05);
  }

  .edu-card-header h4 {
    margin: 0;
    font-size: 1rem;
    color: var(--charcoal-brown);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .edu-card-toggle {
    font-size: 1.2rem;
    color: var(--olive-green);
    transition: transform 0.3s ease;
  }

  .edu-card.expanded .edu-card-toggle {
    transform: rotate(180deg);
  }

  .edu-card-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0 1.5rem;
  }

  .edu-card.expanded .edu-card-content {
    max-height: 500px;
    padding: 1.5rem;
  }

  .edu-card-content p {
    margin: 0 0 1rem;
    color: #666;
    line-height: 1.7;
    font-size: 0.95rem;
  }

  .edu-card-content ul {
    margin: 0.5rem 0 1rem 1.5rem;
    padding: 0;
    color: #666;
    line-height: 1.8;
  }

  .edu-card-content li {
    margin-bottom: 0.5rem;
  }

  /* ENHANCED SCENARIO CARDS WITH CALCULATIONS */
  .scenario-card {
    position: relative;
  }

  .scenario-value-display {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--olive-green);
    margin-bottom: 0.5rem;
    min-height: 1.5rem;
  }

  .scenario-details {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
    line-height: 1.6;
  }

  /* ANIMATED NUMBER COUNTERS */
  @keyframes countUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .big-number {
    animation: countUp 0.6s ease;
  }

  /* SMOOTH CARD ENTRANCE */
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .snapshot-card {
    animation: slideInUp 0.5s ease backwards;
  }

  .snapshot-card:nth-child(1) { animation-delay: 0.1s; }
  .snapshot-card:nth-child(2) { animation-delay: 0.2s; }
  .snapshot-card:nth-child(3) { animation-delay: 0.3s; }
  .snapshot-card:nth-child(4) { animation-delay: 0.4s; }

  /* PULSE ANIMATION FOR IMPORTANT INFO */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .highlight-pulse {
    animation: pulse 2s ease-in-out infinite;
  }

  /* INTERACTIVE HOVER STATES */
  .status-pill {
    transition: all 0.3s ease;
    cursor: default;
  }

  .status-pill:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
  }

  /* SMOOTH PROGRESS BAR ANIMATION */
  .progress-fill {
    transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ENHANCED ACTION BUTTONS */
  .action-btn {
    position: relative;
    overflow: hidden;
  }

  .action-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .action-btn:hover::before {
    width: 300px;
    height: 300px;
  }

  .action-btn span {
    position: relative;
    z-index: 1;
  }

  /* EDUCATIONAL BADGES */
  .learn-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--olive-green);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-left: 0.5rem;
  }
</style>

<section class="equity-page">
  <!-- HERO + AGENT CARD -->
  <header class="equity-hero">
    <div class="equity-hero-left">
      <p class="eyebrow">Your Life Your Home ¬∑ Equity Center</p>
      <h1>See What Your Home Is Doing For You</h1>
      <p class="sub">
        Track your home value, loan payoff, and equity ‚Äî all in one place.
        Powered by Homebot, presented inside your YLYH dashboard.
      </p>

      <div class="equity-status-row">
        <div class="status-pill clickable" onclick="openEditAddressModal()" style="cursor: pointer;" title="Click to edit address">
          <span class="label">Home</span>
          <span class="value">
            {% if current_property and current_property.get('address') %}
              {{ current_property.address }}
            {% elif homeowner_data and homeowner_data.get('address') %}
              {{ homeowner_data.address }}
            {% else %}
              Your home address
            {% endif %}
          </span>
          <span style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">‚úèÔ∏è Click to edit</span>
        </div>
        <div class="status-pill">
          <span class="label">Last Update</span>
          <span class="value">
            {% if snapshot and snapshot.updated_at %}
              {{ snapshot.updated_at[:10] if snapshot.updated_at|length > 10 else snapshot.updated_at }}
            {% else %}
              Updates monthly
            {% endif %}
          </span>
        </div>
        {% if properties and properties|length > 1 %}
        <div class="status-pill" style="background: rgba(255, 255, 255, 0.25);">
          <span class="label">Properties</span>
          <span class="value">{{ properties|length }} homes</span>
        </div>
        {% endif %}
      </div>
      
      <!-- Property Selector (if multiple properties) -->
      {% if properties and properties|length > 1 %}
      <div style="margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <form method="post" action="{{ url_for('homeowner_switch_property') }}" style="display: flex; gap: 1rem; align-items: center;">
          <label style="color: white; font-weight: 600; font-size: 0.9rem;">üè° Switch Property:</label>
          <select name="property_id" onchange="this.form.submit()" style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.9); color: var(--olive-green); font-weight: 600; cursor: pointer; min-width: 250px;">
            {% for prop in properties %}
            <option value="{{ prop.get('id') if prop.get('id') else prop.id }}" {% if (prop.get('id') if prop.get('id') else prop.id) == current_property_id %}selected{% endif %}>
              {{ prop.get('address') if prop.get('address') else prop.address }}{% if prop.get('is_primary') or (prop.is_primary if prop.is_primary else False) %} (Primary){% endif %}
              {% set prop_type = prop.get('property_type') if prop.get('property_type') else prop.property_type %}
              {% if prop_type and prop_type != 'primary' %} - {{ prop_type|title }}{% endif %}
              {% set est_value = prop.get('estimated_value') if prop.get('estimated_value') else prop.estimated_value %}
              {% if est_value %} - ${{ "{:,.0f}".format(est_value) }}{% endif %}
            </option>
            {% endfor %}
          </select>
        </form>
      </div>
      {% endif %}
      
      <!-- Add Property Button -->
      <div style="margin-top: 1rem;">
        <button type="button" onclick="openAddPropertyModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1.25rem; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;">
          ‚ûï Add Another Property
        </button>
      </div>
</div>

    <div class="equity-hero-right">
{% if professional_info %}
      <div class="agent-card">
  {% if professional_info.professional_photo %}
        <img class="agent-photo" src="{{ url_for('static', filename=professional_info.professional_photo) if not professional_info.professional_photo.startswith('http') else professional_info.professional_photo }}" alt="{{ professional_info.name }}">
  {% else %}
        <div class="agent-photo" style="background: var(--olive-green); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: bold;">
    {{ professional_info.name[0] if professional_info.name else '?' }}
  </div>
  {% endif %}
        <div class="agent-text">
          <p class="agent-label">Your Real Estate Pro</p>
          <h2>{{ professional_info.name }}</h2>
    {% if professional_info.brokerage_name %}
            <p class="agent-brokerage">{{ professional_info.brokerage_name }}{% if professional_info.team_name %} - {{ professional_info.team_name }}{% endif %}</p>
    {% endif %}
    {% if professional_info.email %}
            <p class="agent-contact">{{ professional_info.email }}</p>
          {% endif %}
          <button type="button" class="agent-cta" onclick="window.location.href='mailto:{{ professional_info.email }}'">
            Message {{ professional_info.name.split(' ')[0] if professional_info.name else 'Your Pro' }}
          </button>
        </div>
      </div>
      {% endif %}
    </div>
  </header>

  <!-- SNAPSHOT: BIG NUMBERS -->
  <section class="equity-snapshot">
    <div class="snapshot-grid">
      <article class="snapshot-card snapshot-primary clickable" data-snap="value" onclick="window.location.href='{{ url_for('homeowner_value_my_home') }}'">
        <h3>Estimated Home Value</h3>
        <p class="big-number">
          {% if snapshot and snapshot.value_estimate %}
            ${{ "{:,.0f}".format(snapshot.value_estimate) }}
          {% else %}
            ‚Äî
          {% endif %}
        </p>
        <p class="delta">
          {% if snapshot and snapshot.value_refresh_source %}
            Synced from {{ snapshot.value_refresh_source }}
          {% else %}
            Monthly updates via Homebot
    {% endif %}
        </p>
        <p style="margin-top: 0.75rem; font-size: 0.85rem; opacity: 0.9; font-style: italic;">Click to get detailed home value report</p>
      </article>

      <article class="snapshot-card clickable" data-snap="loan" onclick="window.location.href='{{ url_for('homeowner_value_equity_overview') }}'">
        <h3>Loan Balance</h3>
        <p class="big-number">
          {% if snapshot and snapshot.loan_balance %}
            ${{ "{:,.0f}".format(snapshot.loan_balance) }}
          {% else %}
            ‚Äî
          {% endif %}
        </p>
        <p class="hint">Updates as you make payments</p>
        <p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--olive-green); font-weight: 500;">Click to edit loan details</p>
      </article>

      <article class="snapshot-card clickable" data-snap="equity" onclick="window.location.href='{{ url_for('homeowner_value_equity_overview') }}'">
        <h3>
          Total Equity
          <span class="tooltip-trigger">
            ‚ÑπÔ∏è
            <span class="tooltip">
              Equity is the portion of your home you actually own. It's your home's value minus what you still owe. You can use equity for renovations, investments, or as a down payment on your next home.
            </span>
          </span>
        </h3>
        <p class="big-number">
          {% if snapshot and snapshot.equity_estimate %}
            ${{ "{:,.0f}".format(snapshot.equity_estimate) }}
          {% elif snapshot and snapshot.value_estimate and snapshot.loan_balance %}
            ${{ "{:,.0f}".format(snapshot.value_estimate - snapshot.loan_balance) }}
          {% else %}
            ‚Äî
          {% endif %}
        </p>
        <p class="hint">Value minus loan balance</p>
        <p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--olive-green); font-weight: 500;">Click to update or correct your equity</p>
      </article>

      <article class="snapshot-card clickable" data-snap="ltv" onclick="window.location.href='{{ url_for('homeowner_next_loan_paths') }}'">
        <h3>
          Loan-to-Value (LTV)
          <span class="tooltip-trigger">
            ‚ÑπÔ∏è
            <span class="tooltip">
              LTV is your loan balance divided by your home's value. Lower LTV (under 80%) often means better rates and no PMI. Lenders use this to assess risk.
            </span>
          </span>
        </h3>
        <p class="big-number">
          {% if snapshot and snapshot.value_estimate and snapshot.loan_balance and snapshot.value_estimate > 0 %}
            {{ "{:.1f}".format((snapshot.loan_balance / snapshot.value_estimate) * 100) }}%
          {% else %}
            ‚Äî
          {% endif %}
        </p>
        <p class="hint">Lower is usually better for financing</p>
        <p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--olive-green); font-weight: 500;">Click to learn about refinancing</p>
      </article>
    </div>

    {% if snapshot and snapshot.loan_balance and snapshot.value_estimate %}
    <div class="paydown-progress">
      <div class="paydown-header">
        <span>Loan Paydown Journey</span>
        <span class="paydown-label">
          {% set paydown_percent = ((snapshot.value_estimate - snapshot.loan_balance) / snapshot.value_estimate * 100) if snapshot.value_estimate > 0 else 0 %}
          {% if paydown_percent < 20 %}
            You're on your way to payoff
          {% elif paydown_percent < 50 %}
            Making great progress
          {% elif paydown_percent < 80 %}
            Over halfway there
          {% else %}
            Almost paid off
          {% endif %}
        </span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ paydown_percent }}%;"></div>
      </div>
      <div class="progress-footer">
        <span>Current Balance: ${{ "{:,.0f}".format(snapshot.loan_balance) }}</span>
        <span>Equity: ${{ "{:,.0f}".format(snapshot.value_estimate - snapshot.loan_balance) }}</span>
  </div>
</div>
{% endif %}
  </section>

  <!-- MAIN AREA: TABS + HOMEBOT WIDGET -->
  <section class="equity-main">
    <div class="equity-main-left">
      <!-- TABS -->
      <div class="equity-tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="scenarios">Scenarios</button>
        <button class="tab" data-tab="history">History</button>
      </div>

      <!-- TAB PANELS -->
      <div class="tab-panels">
        <!-- OVERVIEW: HOMEBOT INLINE -->
        <div class="tab-panel active" id="tab-overview">
          <h2>Live Equity Overview</h2>
          <p class="panel-sub">
            Use the tool below to view your current home value and equity.
            Everything runs inside Your Life Your Home but is powered by your
            agent's Homebot account.
          </p>

          <!-- Edit Loan Details Form -->
          <div class="card" style="background: var(--light-cream); border: 2px solid var(--taupe-beige); margin-bottom: 2rem; padding: 2rem;">
            <h3 style="margin: 0 0 1rem; color: var(--charcoal-brown); font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
              <span>‚úèÔ∏è</span>
              <span>Update Your Loan Details</span>
            </h3>
            <p style="margin: 0 0 1.5rem; color: #666; font-size: 0.95rem;">
              If your home value or loan information needs correction, update it here. All numbers will automatically recalculate.
            </p>
            <form method="post" action="{{ url_for('homeowner_value_equity_overview') }}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
              <div>
                <label for="value_estimate" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Home Value</label>
                <input type="text" id="value_estimate" name="value_estimate" placeholder="e.g., 480,000" value="{% if snapshot and snapshot.value_estimate %}{{ snapshot.value_estimate|int }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem;" />
              </div>
              <div>
                <label for="loan_balance" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Loan Balance</label>
                <input type="text" id="loan_balance" name="loan_balance" placeholder="e.g., 275,000" value="{% if snapshot and snapshot.loan_balance %}{{ snapshot.loan_balance|int }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem;" />
              </div>
              <div>
                <label for="loan_rate" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Interest Rate (%)</label>
                <input type="text" id="loan_rate" name="loan_rate" placeholder="e.g., 3.38" value="{% if snapshot and snapshot.loan_rate %}{{ snapshot.loan_rate }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem;" />
              </div>
              <div>
                <label for="loan_payment" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Monthly Payment</label>
                <input type="text" id="loan_payment" name="loan_payment" placeholder="e.g., 2,450" value="{% if snapshot and snapshot.loan_payment %}{{ snapshot.loan_payment|int }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem;" />
              </div>
              <div>
                <label for="loan_term_years" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Loan Term (Years)</label>
                <select id="loan_term_years" name="loan_term_years" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem;">
                  <option value="">Select term</option>
                  <option value="15" {% if snapshot and snapshot.loan_term_years == 15 %}selected{% endif %}>15 years</option>
                  <option value="20" {% if snapshot and snapshot.loan_term_years == 20 %}selected{% endif %}>20 years</option>
                  <option value="30" {% if snapshot and snapshot.loan_term_years == 30 %}selected{% endif %}>30 years</option>
                </select>
              </div>
              <div>
                <label for="loan_start_date" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Loan Start Date</label>
                <input type="date" id="loan_start_date" name="loan_start_date" value="{% if snapshot and snapshot.loan_start_date %}{{ snapshot.loan_start_date }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem;" />
              </div>
              <div style="grid-column: 1 / -1; margin-top: 0.5rem;">
                <button type="submit" class="action-btn" style="width: auto; padding: 1rem 2rem;">
                  Save Changes
                </button>
              </div>
            </form>
            <script>
              // Ensure form submission works
              document.addEventListener('DOMContentLoaded', function() {
                var form = document.querySelector('form[method="post"][action*="equity-overview"]');
                if (form) {
                  console.log('[FORM] Found loan details form');
                  
                  form.addEventListener('submit', function(e) {
                    console.log('[FORM] Form submitting...');
                    var formData = new FormData(form);
                    var data = {};
                    for (var pair of formData.entries()) {
                      data[pair[0]] = pair[1];
                    }
                    console.log('[FORM] Form data being submitted:', data);
                    // Don't prevent default - let it submit normally
                  });
                  
                  // Also add click handler to submit button for debugging
                  var submitBtn = form.querySelector('button[type="submit"]');
                  if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                      console.log('[FORM] Submit button clicked');
                      // Don't prevent default
                    });
                  }
                } else {
                  console.error('[FORM] Loan details form not found!');
                }
              });
            </script>
          </div>

  {% if homebot_widget_id %}
          <div id="homebot_homeowner" class="homebot-widget-container">
            <!-- Homebot will fully render here -->
            <div class="homebot-skeleton">
              <p>Loading your equity experience‚Ä¶</p>
            </div>
          </div>
  {% else %}
          <div class="empty-state">
            <h3>Coming Soon</h3>
            <p>
              Your agent hasn't connected their Homebot account yet.
              {% if professional_info and professional_info.name %}
              Reach out to {{ professional_info.name }} to turn on automatic equity updates.
              {% else %}
              Contact your agent to turn on automatic equity updates.
              {% endif %}
            </p>
          </div>
          {% endif %}
        </div>

        <!-- SCENARIOS -->
        <div class="tab-panel" id="tab-scenarios">
          <h2>What-If Scenarios</h2>
          <p class="panel-sub">
            Play with different strategies: extra payments, cash-out, or a future move.
            These tools use your latest value and loan data as a starting point.
          </p>

          <div class="scenario-grid">
            <div class="scenario-card">
              <h3>Payoff Faster</h3>
              <p>Add an extra principal payment and see how much sooner you could be debt-free and how much interest you'd save.</p>
              <label>Extra per month: <span id="payoff-amount-display">$0</span></label>
              <input type="range" min="0" max="1000" step="50" value="0"
                     class="scenario-slider" data-scenario="payoff" id="payoff-slider">
              <div class="scenario-value-display" data-output="payoff"></div>
              <p class="scenario-output" data-output="payoff">
                Drag the slider to see your payoff timeline and interest savings.
              </p>
              <div class="scenario-details" data-details="payoff"></div>
            </div>

            <div class="scenario-card">
              <h3>Cash-Out Equity</h3>
              <p>See how much cash you could access while keeping a comfortable payment. Cash-out refinancing lets you borrow against your equity.</p>
              <label>Target cash-out amount: <span id="cashout-amount-display">$0</span></label>
              <input type="range" min="0" max="200000" step="10000" value="0"
                     class="scenario-slider" data-scenario="cashout" id="cashout-slider">
              <div class="scenario-value-display" data-output="cashout"></div>
              <p class="scenario-output" data-output="cashout">
                Drag the slider to explore cash-out options.
              </p>
              <div class="scenario-details" data-details="cashout"></div>
            </div>

            <div class="scenario-card">
              <h3>Stay vs. Move</h3>
              <p>Compare using equity to upgrade this home vs. roll it into a new one.</p>
              <button class="linkish" type="button" onclick="window.location.href='{{ url_for('homeowner_next_plan_move') }}'">
                Start a "Stay vs Move" comparison ‚Üí
              </button>
            </div>
          </div>
        </div>

        <!-- HISTORY -->
        <div class="tab-panel" id="tab-history">
          <h2>Value & Equity Over Time</h2>
          <p class="panel-sub">
            Track how your home value, loan balance, and equity have changed over time.
          </p>

          <div class="history-layout">
            <div class="chart-card">
              <h3>Value vs Balance Over Time</h3>
              {% if snapshot_history and snapshot_history|length > 0 %}
              <div class="chart-container" style="margin-top: 1.5rem; position: relative; height: 300px;">
                <canvas id="equityChart"></canvas>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
              <script>
                // eslint-disable-next-line
                (function() {
                  // Template variable - will be replaced by Jinja2
                  const historyData = {{ snapshot_history|tojson|safe if snapshot_history else '[]' }};
                  if (historyData && Array.isArray(historyData) && historyData.length > 0) {
                    const ctx = document.getElementById('equityChart');
                    if (ctx) {
                      const dates = historyData.map(h => {
                        const d = h.snapshot_date ? h.snapshot_date.substring(0, 10) : '';
                        return d || '‚Äî';
                      }).reverse();
                      const values = historyData.map(h => h.value_estimate || 0).reverse();
                      const balances = historyData.map(h => h.loan_balance || 0).reverse();
                      const equities = historyData.map(h => {
                        if (h.equity_estimate) return h.equity_estimate;
                        if (h.value_estimate && h.loan_balance) return h.value_estimate - h.loan_balance;
                        return 0;
                      }).reverse();
                      
                      new Chart(ctx, {
                        type: 'line',
                        data: {
                          labels: dates,
                          datasets: [
                            {
                              label: 'Home Value',
                              data: values,
                              borderColor: '#6B6A45',
                              backgroundColor: 'rgba(107, 106, 69, 0.1)',
                              tension: 0.4,
                              fill: false
                            },
                            {
                              label: 'Loan Balance',
                              data: balances,
                              borderColor: '#C8B497',
                              backgroundColor: 'rgba(200, 180, 151, 0.1)',
                              tension: 0.4,
                              fill: false
                            },
                            {
                              label: 'Equity',
                              data: equities,
                              borderColor: '#5A6D47',
                              backgroundColor: 'rgba(90, 109, 71, 0.1)',
                              tension: 0.4,
                              fill: true
                            }
                          ]
                        },
                        options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                            legend: {
                              position: 'bottom',
                              labels: {
                                font: { family: 'inherit', size: 12 },
                                color: '#3A352C'
                              }
                            },
                            tooltip: {
                              mode: 'index',
                              intersect: false,
                              callbacks: {
                                label: function(context) {
                                  return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                              }
                            }
                          },
                          scales: {
                            y: {
                              beginAtZero: false,
                              ticks: {
                                callback: function(value) {
                                  return '$' + value.toLocaleString();
                                },
                                font: { size: 11 },
                                color: '#666'
                              },
                              grid: {
                                color: 'rgba(200, 180, 151, 0.2)'
                              }
                            },
                            x: {
                              ticks: {
                                font: { size: 10 },
                                color: '#666',
                                maxRotation: 45,
                                minRotation: 45
                              },
                              grid: {
                                display: false
                              }
                            }
                          }
                        }
                      });
                    }
                  }
                })();
              </script>
              {% else %}
              <div class="chart-placeholder">
                <p>Chart will appear here once you have historical data.</p>
                <p style="font-size: 0.85rem; margin-top: 0.5rem; color: #999;">
                  Historical snapshots are created automatically when you update your loan details.
                </p>
              </div>
              {% endif %}
            </div>

            <div class="history-list">
              <h3>Monthly Snapshots</h3>
              <ul>
                {% if snapshot_history and snapshot_history|length > 0 %}
                  {% for hist in snapshot_history %}
                  <li>
                    <span class="snap-date">{{ hist.snapshot_date[:10] if hist.snapshot_date and hist.snapshot_date|length > 10 else (hist.snapshot_date or '‚Äî') }}</span>
                    <span class="snap-value">
                      {% if hist.value_estimate %}
                        ${{ "{:,.0f}".format(hist.value_estimate) }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </span>
                    <span class="snap-equity">
                      {% if hist.equity_estimate %}
                        ${{ "{:,.0f}".format(hist.equity_estimate) }}
                      {% elif hist.value_estimate and hist.loan_balance %}
                        ${{ "{:,.0f}".format(hist.value_estimate - hist.loan_balance) }}
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </span>
                  </li>
                  {% endfor %}
                {% elif snapshot and snapshot.updated_at %}
                <li>
                  <span class="snap-date">{{ snapshot.updated_at[:10] if snapshot.updated_at|length > 10 else snapshot.updated_at }}</span>
                  <span class="snap-value">
                    {% if snapshot.value_estimate %}
                      ${{ "{:,.0f}".format(snapshot.value_estimate) }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </span>
                  <span class="snap-equity">
                    {% if snapshot.equity_estimate %}
                      ${{ "{:,.0f}".format(snapshot.equity_estimate) }}
                    {% elif snapshot.value_estimate and snapshot.loan_balance %}
                      ${{ "{:,.0f}".format(snapshot.value_estimate - snapshot.loan_balance) }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </span>
                </li>
                {% else %}
                <li>No history yet. Your first snapshot will appear after your next update.</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR: ACTIONS -->
    <aside class="equity-main-right">
      <h3>Quick Actions</h3>
      <button class="action-btn" type="button" onclick="window.location.href='{{ url_for('homeowner_next_loan_paths') }}'">
        <span>üîç</span> <span>Explore refinance options</span>
      </button>
      <button class="action-btn" type="button" onclick="document.querySelector('[data-tab=&quot;scenarios&quot;]').click(); setTimeout(function(){ document.querySelector('.scenario-slider[data-scenario=&quot;cashout&quot;]').focus(); }, 300);">
        <span>üí∞</span> <span>See cash-out equity ideas</span>
      </button>
      <button class="action-btn" type="button" onclick="window.location.href='{{ url_for('homeowner_next_plan_move') }}'">
        <span>üè°</span> <span>Plan my "next home" timeline</span>
      </button>
      {% if professional_info and professional_info.email %}
      <button class="action-btn secondary" type="button" onclick="window.location.href='mailto:{{ professional_info.email }}?subject=Home Equity Questions'">
        Ask {{ professional_info.name.split(' ')[0] if professional_info.name else 'Your Pro' }} a question
      </button>
      {% endif %}

      <div class="edu-card">
        <div class="edu-card-header" onclick="this.parentElement.classList.toggle('expanded')">
          <h4>
            <span>üìö</span>
            <span>How This Works</span>
          </h4>
          <span class="edu-card-toggle">‚ñº</span>
    </div>
        <div class="edu-card-content">
          <p>
            <strong>Homebot Integration:</strong> Homebot automatically tracks your home's value and equity in the background using real estate data and market trends.
          </p>
          <p>
            <strong>Your Dashboard:</strong> Your Life Your Home turns that data into an interactive dashboard with tools from your agent and lender, all in one place.
          </p>
          <p>
            <strong>Monthly Updates:</strong> Your equity numbers update monthly, so you always know where you stand without having to check multiple sources.
          </p>
        </div>
      </div>

      <div class="edu-card">
        <div class="edu-card-header" onclick="this.parentElement.classList.toggle('expanded')">
          <h4>
            <span>üîí</span>
            <span>Data Ownership & Privacy</span>
          </h4>
          <span class="edu-card-toggle">‚ñº</span>
        </div>
        <div class="edu-card-content">
          <p>
            {% if professional_info and professional_info.name %}
            Your equity experience is tied to {{ professional_info.name }}'s Homebot account,
            {% else %}
            Your equity experience is tied to your agent's Homebot account,
  {% endif %}
            so your relationship stays directly with your trusted pro ‚Äî not with a portal.
          </p>
          <p>
            <strong>Your Data:</strong> All your home value and equity information is private and only shared with your real estate professional. We never sell your data.
          </p>
        </div>
</div>

      <div class="edu-card">
        <div class="edu-card-header" onclick="this.parentElement.classList.toggle('expanded')">
          <h4>
            <span>üí°</span>
            <span>Understanding Equity</span>
          </h4>
          <span class="edu-card-toggle">‚ñº</span>
        </div>
        <div class="edu-card-content">
          <p>
            <strong>What is Equity?</strong> Equity is the portion of your home you actually own. It grows as you pay down your mortgage and as your home's value increases.
          </p>
          <p>
            <strong>How to Use Equity:</strong>
          </p>
          <ul>
            <li><strong>Renovations:</strong> Use equity to fund home improvements that increase value</li>
            <li><strong>Debt Consolidation:</strong> Refinance to pay off high-interest debt</li>
            <li><strong>Investments:</strong> Use equity for other investments or opportunities</li>
            <li><strong>Next Home:</strong> Use equity as a down payment on your next property</li>
          </ul>
          <p>
            <strong>Talk to Your Pro:</strong> Always consult with your lender or agent before making equity decisions. They can help you understand the best options for your situation.
          </p>
        </div>
      </div>
    </aside>
  </section>
</section>

{% if homebot_widget_id %}
<script>
  // CRITICAL: Isolate Homebot widget from any page-level click handlers
  (function() {
    'use strict';
    
    var widgetContainer = document.getElementById('homebot_homeowner');
    var widgetSection = document.querySelector('.homebot-widget-container');
    
    if (widgetContainer) {
      widgetContainer.setAttribute('data-homebot-widget', 'true');
      if (widgetSection) {
        widgetSection.setAttribute('data-homebot-widget', 'true');
      }
      
      ['click', 'mousedown', 'mouseup', 'submit', 'focusin', 'focusout'].forEach(function(eventType) {
        widgetContainer.addEventListener(eventType, function(e) {
          e.stopPropagation();
        }, true);
      });
    }
  })();

  // Homebot embed code
  (function (h, b) {
    var w = window, d = document, s = 'script', x, y;
    w['_hb_namespace'] = h;
    w[h] = w[h] || function () { (w[h].q = w[h].q || []).push(arguments); };
    y = d.createElement(s); 
    x = d.getElementsByTagName(s)[0];
    y.async = 1;
    y.src = 'https://embed.homebotapp.com/lgw/v1/widget.js';
    x.parentNode.insertBefore(y, x);
  })('Homebot');
  
  // Initialize widget
  (function() {
    // Template variable - will be replaced by Jinja2
    // eslint-disable-next-line
    var widgetId = '{{ homebot_widget_id|e }}';
    widgetId = widgetId.trim();
    
    if (widgetId.indexOf('<') !== -1 || widgetId.indexOf('&lt;') !== -1) {
      var idMatch = widgetId.match(/['"]([a-f0-9]{40,})['"]/);
      if (idMatch) {
        widgetId = idMatch[1];
      } else {
        console.error('[HOMEBOT] ‚ùå Could not extract valid widget ID');
        return;
      }
    }
    
    var container = '#homebot_homeowner';
    var maxAttempts = 50;
    var attempts = 0;
    
    function initHomebot() {
      attempts++;
      
      if (typeof window.Homebot === 'function') {
        try {
        window.Homebot(container, widgetId);
          
          setTimeout(function() {
            var containerEl = document.querySelector(container);
            if (containerEl) {
              var iframe = containerEl.querySelector('iframe');
              if (iframe) {
                iframe.style.pointerEvents = 'auto';
                iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen; geolocation');
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.style.cssText += 'pointer-events: auto !important;';
                
                // Remove skeleton loader
                var skeleton = containerEl.querySelector('.homebot-skeleton');
                if (skeleton) {
                  skeleton.style.display = 'none';
                }
              }
            }
          }, 2000);
        } catch (error) {
          console.error('[HOMEBOT] Error:', error);
        }
      } else if (window.Homebot && Array.isArray(window.Homebot.q)) {
        if (attempts < maxAttempts) {
          setTimeout(initHomebot, 100);
        }
      } else if (attempts < maxAttempts) {
        setTimeout(initHomebot, 100);
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initHomebot, 800);
      });
    } else {
      setTimeout(initHomebot, 800);
    }
  })();

  // Tab switching
  document.querySelectorAll(".equity-tabs .tab").forEach((tab) => {
    tab.addEventListener("click", () => {
      const target = tab.dataset.tab;

      document.querySelectorAll(".equity-tabs .tab").forEach((t) => t.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach((p) => p.classList.remove("active"));

      tab.classList.add("active");
      document.getElementById("tab-" + target).classList.add("active");
    });
  });

  // Scenario sliders with real calculations (Homebot-style formulas)
  function calculatePayoff(extraPayment, loanBalance, interestRate, monthlyPayment, loanTermYears, loanStartDate) {
    if (!loanBalance || !interestRate || !monthlyPayment || loanBalance <= 0) {
      return { years: 0, months: 0, interestSaved: 0, newPayment: monthlyPayment, yearsSaved: 0, origPayoffYears: 0, origPayoffMonths: 0 };
    }
    
    const monthlyRate = interestRate / 100 / 12;
    
    // Calculate remaining term based on loan start date and term (Homebot-style)
    let remainingMonths = 360; // Default 30 years
    if (loanTermYears && loanStartDate) {
      const startDate = new Date(loanStartDate);
      const today = new Date();
      const monthsElapsed = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
      const totalMonths = loanTermYears * 12;
      remainingMonths = Math.max(1, totalMonths - monthsElapsed);
    } else if (loanTermYears) {
      remainingMonths = loanTermYears * 12;
    }
    
    // Calculate payoff with extra payment
    let balance = loanBalance;
    let totalInterest = 0;
    let months = 0;
    const totalPayment = monthlyPayment + extraPayment;
    
    while (balance > 0.01 && months < remainingMonths + 60) {
      const interestPayment = balance * monthlyRate;
      const principalPayment = Math.min(totalPayment - interestPayment, balance);
      balance -= principalPayment;
      totalInterest += interestPayment;
      months++;
      if (balance <= 0.01) break;
    }
    
    // Calculate original payoff (without extra payment)
    let origBalance = loanBalance;
    let origMonths = 0;
    let origInterest = 0;
    while (origBalance > 0.01 && origMonths < remainingMonths + 60) {
      const origInterestPayment = origBalance * monthlyRate;
      const origPrincipalPayment = Math.min(monthlyPayment - origInterestPayment, origBalance);
      origBalance -= origPrincipalPayment;
      origInterest += origInterestPayment;
      origMonths++;
      if (origBalance <= 0.01) break;
    }
    
    return {
      years: Math.floor(months / 12),
      months: months % 12,
      interestSaved: Math.max(0, origInterest - totalInterest),
      newPayment: totalPayment,
      yearsSaved: Math.max(0, Math.floor((origMonths - months) / 12)),
      origPayoffYears: Math.floor(origMonths / 12),
      origPayoffMonths: origMonths % 12
    };
  }

  function calculateCashOut(cashOutAmount, currentBalance, interestRate, currentPayment, homeValue, loanTermYears, loanStartDate) {
    if (!cashOutAmount || cashOutAmount <= 0) {
      return { newBalance: currentBalance, newPayment: currentPayment, newLTV: 0 };
    }
    
    const newBalance = currentBalance + cashOutAmount;
    const newLTV = (newBalance / homeValue) * 100;
    
    // Calculate remaining term based on loan start date and term
    let remainingMonths = 360; // Default 30 years
    if (loanTermYears && loanStartDate) {
      const startDate = new Date(loanStartDate);
      const today = new Date();
      const monthsElapsed = (today.getFullYear() - startDate.getFullYear()) * 12 + (today.getMonth() - startDate.getMonth());
      const totalMonths = loanTermYears * 12;
      remainingMonths = Math.max(1, totalMonths - monthsElapsed);
    } else if (loanTermYears) {
      remainingMonths = loanTermYears * 12;
    }
    
    // Calculate new payment using amortization formula (Homebot-style)
    const monthlyRate = interestRate / 100 / 12;
    const newPayment = newBalance * (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / 
                      (Math.pow(1 + monthlyRate, remainingMonths) - 1);
    
    return {
      newBalance: newBalance,
      newPayment: newPayment,
      newLTV: newLTV,
      paymentIncrease: newPayment - currentPayment
    };
  }

  // Get snapshot data from page
  // Template variables below will be replaced by Jinja2 before JavaScript execution
  /* eslint-disable */
  const snapshotData = {
    loanBalance: {% if snapshot and snapshot.loan_balance %}{{ snapshot.loan_balance }}{% else %}0{% endif %},
    valueEstimate: {% if snapshot and snapshot.value_estimate %}{{ snapshot.value_estimate }}{% else %}0{% endif %},
    loanRate: {% if snapshot and snapshot.loan_rate %}{{ snapshot.loan_rate }}{% else %}4.5{% endif %},
    loanPayment: {% if snapshot and snapshot.loan_payment %}{{ snapshot.loan_payment }}{% else %}0{% endif %},
    loanTermYears: {% if snapshot and snapshot.loan_term_years %}{{ snapshot.loan_term_years }}{% else %}30{% endif %},
    loanStartDate: {% if snapshot and snapshot.loan_start_date %}'{{ snapshot.loan_start_date|e }}'{% else %}null{% endif %}
  };
  /* eslint-enable */

  document.querySelectorAll(".scenario-slider").forEach((slider) => {
    const type = slider.dataset.scenario;
    const amountDisplay = document.getElementById(type + '-amount-display');
    const valueDisplay = document.querySelector('.scenario-value-display[data-output="' + type + '"]');
    const output = document.querySelector('.scenario-output[data-output="' + type + '"]');
    const details = document.querySelector('.scenario-details[data-details="' + type + '"]');
    
    slider.addEventListener("input", (e) => {
      const value = Number(slider.value);
      
      if (amountDisplay) {
        amountDisplay.textContent = '$' + value.toLocaleString();
      }
      
      if (type === "payoff" && snapshotData.loanBalance > 0) {
        const result = calculatePayoff(
          value,
          snapshotData.loanBalance,
          snapshotData.loanRate || 4.5,
          snapshotData.loanPayment || 2000,
          snapshotData.loanTermYears || 30,
          snapshotData.loanStartDate
        );
        
        if (value > 0 && result.years > 0) {
          valueDisplay.innerHTML = '<strong style="color: var(--olive-green);">Pay off ' + 
            (result.yearsSaved > 0 ? result.yearsSaved + ' years earlier' : 'faster') + '</strong>';
          
          output.textContent = 'With $' + value.toLocaleString() + ' extra per month:';
          
          details.innerHTML = 
            '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--taupe-beige);">' +
            '<p style="margin: 0.25rem 0;"><strong>Current payoff:</strong> ' + result.origPayoffYears + ' years, ' + result.origPayoffMonths + ' months</p>' +
            '<p style="margin: 0.25rem 0; color: var(--olive-green);"><strong>New payoff:</strong> ' + result.years + ' years, ' + result.months + ' months</p>' +
            '<p style="margin: 0.25rem 0; color: var(--olive-green);"><strong>Interest saved:</strong> $' + 
            Math.round(result.interestSaved).toLocaleString() + '</p>' +
            '<p style="margin: 0.25rem 0; font-size: 0.8rem; color: #999;">New monthly payment: $' + 
            Math.round(result.newPayment).toLocaleString() + '/month</p>' +
            '</div>';
        } else {
          valueDisplay.textContent = '';
          output.textContent = 'Drag the slider to see your payoff timeline and interest savings.';
          details.innerHTML = '';
        }
      } else if (type === "cashout" && snapshotData.valueEstimate > 0) {
        const maxCashOut = Math.max(0, (snapshotData.valueEstimate * 0.8) - snapshotData.loanBalance);
        const actualCashOut = Math.min(value, maxCashOut);
        
        if (actualCashOut > 0 && snapshotData.loanBalance > 0) {
          const result = calculateCashOut(
            actualCashOut,
            snapshotData.loanBalance,
            snapshotData.loanRate || 4.5,
            snapshotData.loanPayment || 2000,
            snapshotData.valueEstimate,
            snapshotData.loanTermYears || 30,
            snapshotData.loanStartDate
          );
          
          valueDisplay.innerHTML = '<strong style="color: var(--olive-green);">Access $' + 
            actualCashOut.toLocaleString() + ' in cash</strong>';
          
          output.textContent = 'Cash-out refinance scenario:';
          
          const paymentChange = result.paymentIncrease > 0 ? '+' : '';
          details.innerHTML = 
            '<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--taupe-beige);">' +
            '<p style="margin: 0.25rem 0;"><strong>New loan balance:</strong> $' + 
            Math.round(result.newBalance).toLocaleString() + '</p>' +
            '<p style="margin: 0.25rem 0;"><strong>New LTV:</strong> ' + 
            result.newLTV.toFixed(1) + '%</p>' +
            '<p style="margin: 0.25rem 0;"><strong>Current payment:</strong> $' + 
            Math.round(snapshotData.loanPayment || 2000).toLocaleString() + '/month</p>' +
            '<p style="margin: 0.25rem 0; color: ' + (result.paymentIncrease > 0 ? '#d32f2f' : 'var(--olive-green)') + ';"><strong>Estimated new payment:</strong> $' + 
            Math.round(result.newPayment).toLocaleString() + '/month (' + paymentChange + '$' + Math.round(Math.abs(result.paymentIncrease)).toLocaleString() + ' change)</p>' +
            '<p style="margin: 0.5rem 0 0; font-size: 0.8rem; color: #999; font-style: italic;">' +
            'Note: Actual terms depend on current rates and your credit. Talk to your lender for exact numbers.</p>' +
            '</div>';
        } else if (value > maxCashOut) {
          valueDisplay.innerHTML = '<strong style="color: #d32f2f;">Maximum available: $' + 
            Math.round(maxCashOut).toLocaleString() + '</strong>';
          output.textContent = 'You can typically access up to 80% of your home\'s value minus your current loan.';
          details.innerHTML = '';
        } else {
          valueDisplay.textContent = '';
          output.textContent = 'Drag the slider to explore cash-out options.';
          details.innerHTML = '';
        }
      }
    });
  });

  // Animate numbers on page load
  function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      const current = Math.floor(progress * (end - start) + start);
      if (element.textContent.includes('$')) {
        element.textContent = '$' + current.toLocaleString();
      } else if (element.textContent.includes('%')) {
        element.textContent = (current / 100).toFixed(1) + '%';
      } else {
        element.textContent = current.toLocaleString();
      }
      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }

  // Animate snapshot cards on load
  document.querySelectorAll('.big-number').forEach((el) => {
    const text = el.textContent.trim();
    if (text && text !== '‚Äî') {
      const numMatch = text.match(/[\d,]+/);
      if (numMatch) {
        const num = parseInt(numMatch[0].replace(/,/g, ''));
        if (num > 0) {
          el.style.opacity = '0';
          setTimeout(() => {
            animateValue(el, 0, num, 1000);
            el.style.opacity = '1';
          }, 200);
        }
      }
    }
  });
</script>
{% endif %}

<!-- Edit Address Modal -->
<div id="editAddressModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0; color: var(--olive-green); font-size: 1.5rem;">Edit Property Address</h2>
      <button onclick="closeEditAddressModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; line-height: 1;">√ó</button>
    </div>
    <form method="post" action="{{ url_for('homeowner_update_property_address') }}">
      <input type="hidden" name="property_id" value="{{ current_property_id or '' }}">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; color: var(--charcoal-brown); margin-bottom: 0.5rem;">Property Address</label>
        <input type="text" name="address" value="{% if current_property and current_property.get('address') %}{{ current_property.address }}{% elif current_property %}{{ current_property.get('address', '') }}{% endif %}" required style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" placeholder="123 Main St, City, State ZIP">
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button type="button" onclick="closeEditAddressModal()" style="padding: 0.75rem 1.5rem; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--charcoal-brown);">Cancel</button>
        <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--olive-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Save Address</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Property Modal -->
<div id="addPropertyModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0; color: var(--olive-green); font-size: 1.5rem;">Add New Property</h2>
      <button onclick="closeAddPropertyModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; line-height: 1;">√ó</button>
    </div>
    <form method="post" action="{{ url_for('homeowner_add_property') }}">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; color: var(--charcoal-brown); margin-bottom: 0.5rem;">Property Address *</label>
        <input type="text" name="property_address" required style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" placeholder="123 Main St, City, State ZIP">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; color: var(--charcoal-brown); margin-bottom: 0.5rem;">Estimated Value (Optional)</label>
        <input type="text" name="estimated_value" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" placeholder="450000">
      </div>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; color: var(--charcoal-brown); margin-bottom: 0.5rem;">Property Type</label>
        <select name="property_type" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;">
          <option value="primary">Primary Residence</option>
          <option value="rental">Rental Property</option>
          <option value="investment">Investment Property</option>
          <option value="vacation">Vacation Home</option>
        </select>
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button type="button" onclick="closeAddPropertyModal()" style="padding: 0.75rem 1.5rem; border: 2px solid #e0e0e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--charcoal-brown);">Cancel</button>
        <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--olive-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Add Property</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openEditAddressModal() {
    document.getElementById('editAddressModal').style.display = 'flex';
  }
  
  function closeEditAddressModal() {
    document.getElementById('editAddressModal').style.display = 'none';
  }
  
  function openAddPropertyModal() {
    document.getElementById('addPropertyModal').style.display = 'flex';
  }
  
  function closeAddPropertyModal() {
    document.getElementById('addPropertyModal').style.display = 'none';
  }
  
  // Close modals when clicking outside
  var editModal = document.getElementById('editAddressModal');
  if (editModal) {
    editModal.addEventListener('click', function(e) {
      if (e.target === this) closeEditAddressModal();
    });
  }
  
  var addModal = document.getElementById('addPropertyModal');
  if (addModal) {
    addModal.addEventListener('click', function(e) {
      if (e.target === this) closeAddPropertyModal();
    });
  }
</script>

{% endblock %}
