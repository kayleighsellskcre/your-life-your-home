{% extends "homeowner/layout.html" %}
{% block title %}Equity Dashboard{% endblock %}

{% block homeowner_content %}
<div class="dashboard-main__header">
  <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
    <div style="flex: 1;">
      <p class="dashboard-tagline">Know your equity and options</p>
      <h1 style="margin: 0.5rem 0 1rem;">Equity Dashboard</h1>
      <p style="margin: 0;">Powerful tools to visualize, analyze, and maximize your home equity with real-time calculations and insights.</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: flex-end;">
      <a href="{{ cloud_cma_url }}" target="_blank" style="background: #6B6A45; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; white-space: nowrap; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem; text-decoration: none;">
        <span style="font-size: 1.2rem;">üìä</span>
        <span>Instant Home Worth</span>
      </a>
      <button onclick="openAddHomeModal()" style="background: #6B6A45; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; white-space: nowrap; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem;">
        <span style="font-size: 1.2rem;">üè†</span>
        <span>Add Home</span>
      </button>
    </div>
  </div>
</div>

{% if properties|length > 1 %}
<!-- Property Selector -->
<div class="dashboard-section">
  <div class="card" style="background: white; border: 1px solid rgba(200, 180, 151, 0.3);">
    <label style="display: block; font-size: 0.85rem; font-weight: 500; color: #6B6A45; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.75rem;">üè° Select Property</label>
    <form method="post" action="{{ url_for('homeowner_switch_property') }}" id="property-switch-form">
      <select name="property_id" onchange="this.form.submit()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 0.95rem; background: white; cursor: pointer;">
        {% for prop in properties %}
        <option value="{{ prop.id }}" {% if prop.id == current_property_id %}selected{% endif %}>
          {{ prop.address }}{% if prop.is_primary %} (Primary){% endif %}
          {% if prop.estimated_value %} - ${{ "{:,.0f}".format(prop.estimated_value) }}{% endif %}
        </option>
        {% endfor %}
      </select>
    </form>
  </div>
</div>
{% endif %}

<!-- Add Home Modal -->
<div id="add-home-modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: var(--white); border-radius: var(--border-radius); padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 style="margin: 0; font-family: var(--font-heading); font-size: 1.5rem;">üè† Add Another Home</h2>
      <button onclick="closeAddHomeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px;">√ó</button>
    </div>
    
    <form method="post" action="{{ url_for('homeowner_add_property') }}" style="display: flex; flex-direction: column; gap: 1.5rem;">
      <div>
        <label for="property_address" style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">Property Address</label>
        <input type="text" id="property_address" name="property_address" placeholder="e.g., 123 Main St, City, State" required />
      </div>

      <div>
        <label for="estimated_value" style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">Estimated Value</label>
        <input type="text" id="estimated_value" name="estimated_value" placeholder="e.g., 450,000" />
      </div>

      <div>
        <label for="property_type" style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">Property Type</label>
        <select id="property_type" name="property_type">
          <option value="primary">Primary Residence</option>
          <option value="investment">Investment Property</option>
          <option value="vacation">Vacation Home</option>
          <option value="rental">Rental Property</option>
        </select>
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
        <button type="submit" class="btn btn-primary" style="flex: 1;">Add Property</button>
        <button type="button" onclick="closeAddHomeModal()" class="btn btn-outline" style="flex: 1;">Cancel</button>
      </div>
    </form>

    <p style="margin-top: 1.5rem; font-size: 0.85rem; color: #888; text-align: center;">
      üí° You'll be able to switch between properties and track equity for each one separately.
    </p>
  </div>
</div>

<script>
  function openAddHomeModal() {
    document.getElementById('add-home-modal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeAddHomeModal() {
    document.getElementById('add-home-modal').style.display = 'none';
    document.body.style.overflow = '';
  }
  document.getElementById('add-home-modal').addEventListener('click', function(e) {
    if (e.target === this) closeAddHomeModal();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeAddHomeModal();
  });
</script>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-in {
    animation: fadeInUp 0.6s ease-out forwards;
  }
  .card {
    animation: fadeInUp 0.6s ease-out forwards;
  }
  
  /* Smooth scrolling for anchor links */
  html {
    scroll-behavior: smooth;
  }
  
  /* Better button hover states */
  .projection-btn:hover,
  .quick-btn:hover {
    transform: scale(1.05);
  }
  
  /* Mobile optimizations */
  @media (max-width: 768px) {
    .dashboard-main__header h1 {
      font-size: 1.75rem !important;
    }
    .card-value {
      font-size: 2rem !important;
    }
    #extra-payment-slider {
      height: 16px !important;
    }
    #extra-payment-slider::-webkit-slider-thumb {
      width: 32px !important;
      height: 32px !important;
    }
    #extra-payment-slider::-moz-range-thumb {
      width: 32px !important;
      height: 32px !important;
    }
  }
  
  /* Loading state animation */
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .loading {
    animation: pulse 1.5s ease-in-out infinite;
  }
</style>

<div class="dashboard-section">
  <!-- Hero Stats with Visual Progress Bars -->
  <div style="display: grid !important; grid-template-columns: 1fr 1fr 1fr !important; gap: 0.75rem !important; margin-bottom: 2rem; grid-auto-flow: column !important;">
    <!-- Home Value Card -->
    <div class="card" style="min-width: 0 !important; width: 100% !important; background: linear-gradient(135deg, #3A352C 0%, #2D2822 100%); color: white; position: relative; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.2); border: 1px solid rgba(200, 180, 151, 0.2);">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.08;">üè°</div>
      <div style="position: relative; z-index: 1;">
        <h2 style="font-size: 0.85rem; font-weight: 500; color: #C8B497; text-transform: uppercase; letter-spacing: 0.08em; margin: 0 0 1rem;">Home Value</h2>
        <div style="font-size: 2.5rem; font-weight: 400; color: #F6F2E8; margin-bottom: 0.5rem; font-family: var(--font-heading);">
          {% if current_value > 0 %}
            ${{ "{:,.0f}".format(current_value) }}
          {% else %}
            <span style="font-size: 2rem; color: #C8B497; opacity: 0.6;">‚Äî</span>
          {% endif %}
        </div>
        {% if monthly_appreciation > 0 %}
        <div style="background: rgba(200,180,151,0.15); padding: 0.5rem 0.75rem; border-radius: 6px; display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; border: 1px solid rgba(200,180,151,0.2);">
          <span style="font-size: 0.75rem; color: #C8B497; font-weight: 500;">üìà +${{ "{:,.0f}".format(monthly_appreciation) }}/mo</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Loan Balance Card -->
    <div class="card" style="min-width: 0 !important; width: 100% !important; background: linear-gradient(135deg, #9A8B7A 0%, #8A7C6D 100%); color: white; position: relative; overflow: hidden; border: 1px solid rgba(107, 106, 69, 0.3); box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.08;">üí≥</div>
      <div style="position: relative; z-index: 1;">
        <h2 style="font-size: 0.85rem; font-weight: 500; color: #F6F2E8; text-transform: uppercase; letter-spacing: 0.08em; margin: 0 0 1rem;">Loan Balance</h2>
        <div style="font-size: 2.5rem; font-weight: 400; color: white; margin-bottom: 0.5rem; font-family: var(--font-heading);">
          {% if loan_balance > 0 %}
            ${{ "{:,.0f}".format(loan_balance) }}
          {% else %}
            <span style="font-size: 2rem; opacity: 0.6;">‚Äî</span>
          {% endif %}
        </div>
        {% if loan_rate > 0 %}
        <div style="background: rgba(255,255,255,0.12); padding: 0.5rem 0.75rem; border-radius: 6px; display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; border: 1px solid rgba(255,255,255,0.15);">
          <span style="font-size: 0.75rem; color: #F6F2E8; font-weight: 500;">{{ "{:.2f}".format(loan_rate) }}% APR</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Equity Card with Progress Bar -->
    <div class="card" style="min-width: 0 !important; width: 100% !important; background: linear-gradient(135deg, #6B6A45 0%, #5A5938 100%); color: white; position: relative; overflow: hidden; border: 1px solid rgba(107, 106, 69, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.18);">
      <div style="position: absolute; top: -20px; right: -20px; font-size: 120px; opacity: 0.1;">üíé</div>
      <div style="position: relative; z-index: 1;">
        <h2 style="font-size: 0.85rem; font-weight: 500; color: #F6F2E8; text-transform: uppercase; letter-spacing: 0.08em; margin: 0 0 1rem;">Your Equity</h2>
        <div style="font-size: 2.5rem; font-weight: 400; color: white; margin-bottom: 1rem; font-family: var(--font-heading);">
          {% if equity_estimate > 0 %}
            ${{ "{:,.0f}".format(equity_estimate) }}
          {% else %}
            <span style="font-size: 2rem; opacity: 0.7;">‚Äî</span>
          {% endif %}
        </div>
        {% if ltv > 0 %}
        <div style="margin-top: 1rem;">
          <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.5rem; color: #F6F2E8; opacity: 0.95;">
            <span>{{ "{:.1f}".format(100 - ltv) }}% owned</span>
            <span>{{ "{:.1f}".format(ltv) }}% financed</span>
          </div>
          <div style="background: rgba(246,242,232,0.2); height: 8px; border-radius: 10px; overflow: hidden; border: 1px solid rgba(246,242,232,0.15);">
            <div style="background: #F6F2E8; height: 100%; width: {{ "{:.1f}".format(100 - ltv) }}%; transition: width 1s ease; box-shadow: 0 0 8px rgba(246,242,232,0.3);"></div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Interactive Equity Visualizer -->
  <div class="card" style="background: linear-gradient(135deg, var(--light-cream) 0%, var(--soft-tan) 100%); margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
      <span style="font-size: 1.5rem;">üìä</span>
      <span>Equity Breakdown</span>
    </h2>
    <p class="card-subtext" style="margin-bottom: 2rem;">Visual representation of your home's financial structure</p>
    
    {% if current_value > 0 and loan_balance > 0 %}
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; align-items: center;">
      <!-- Pie Chart Visualization -->
      <div style="flex: 1; min-width: 280px;">
        <canvas id="equityPieChart" width="280" height="280"></canvas>
      </div>
      
      <!-- Legend & Stats -->
      <div style="flex: 1; min-width: 280px;">
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 60px; height: 60px; background: var(--olive-green); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üíé</div>
            <div style="flex: 1;">
              <div style="font-size: 0.85rem; color: #6B6A45; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em;">Your Equity</div>
              <div style="font-size: 1.8rem; font-weight: 400; color: #3A352C; font-family: var(--font-heading);">${{ "{:,.0f}".format(equity_estimate) }}</div>
              <div style="font-size: 0.85rem; color: #888;">{{ "{:.1f}".format(100 - ltv) }}% of home value</div>
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 60px; height: 60px; background: var(--taupe-beige); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üè¶</div>
            <div style="flex: 1;">
              <div style="font-size: 0.85rem; color: #6B6A45; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em;">Loan Balance</div>
              <div style="font-size: 1.8rem; font-weight: 400; color: #3A352C; font-family: var(--font-heading);">${{ "{:,.0f}".format(loan_balance) }}</div>
              <div style="font-size: 0.85rem; color: #888;">{{ "{:.1f}".format(ltv) }}% of home value</div>
            </div>
          </div>

          {% if payoff_date %}
          <div style="background: rgba(186,140,97,0.15); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--olive-green);">
            <div style="font-size: 0.75rem; color: #6B6A45; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.25rem;">Projected Payoff</div>
            <div style="font-size: 1.2rem; font-weight: 400; color: #3A352C; font-family: var(--font-heading);">{{ payoff_date }}</div>
            <div style="font-size: 0.85rem; color: #888; margin-top: 0.25rem;">{{ "{:.1f}".format(years_remaining) }} years remaining</div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem 1rem; color: #888;">
      <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üìä</div>
      <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Enter your home value and loan details below</p>
      <p style="font-size: 0.9rem;">to see your interactive equity visualization!</p>
    </div>
    {% endif %}
  </div>

  <script>
    {% if current_value > 0 and loan_balance > 0 %}
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const canvas = document.getElementById('equityPieChart');
        if (!canvas || !canvas.getContext) {
          console.log('Canvas not supported');
          return;
        }
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 20;
        
        const equity = {{ equity_estimate }};
        const loan = {{ loan_balance }};
        const total = equity + loan;
        const equityAngle = (equity / total) * 2 * Math.PI;
        
        // Draw loan portion (taupe)
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, 0, equityAngle, false);
        ctx.closePath();
        ctx.fillStyle = '#BA8C61';
        ctx.fill();
        
        // Draw equity portion (olive green)
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, equityAngle, 2 * Math.PI, false);
        ctx.closePath();
        ctx.fillStyle = '#5A6D47';
        ctx.fill();
        
        // Draw center circle (white)
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();
        
        // Draw percentage text in center
        ctx.fillStyle = '#3A352C';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('{{ "{:.0f}".format(100 - ltv) }}%', centerX, centerY - 10);
        ctx.font = '14px Arial';
        ctx.fillText('Equity', centerX, centerY + 15);
      } catch (error) {
        console.error('Error drawing equity chart:', error);
      }
    });
    {% endif %}
  </script>

  <!-- Growth Projections with Interactive Timeline -->
  <div class="card" style="margin-bottom: 2rem; background: white; box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
      <span style="font-size: 1.5rem;">üìà</span>
      <span>Wealth Growth Projections</span>
    </h2>
    <p class="card-subtext" style="margin-bottom: 2rem;">See how your home equity could grow over time with market appreciation</p>
    
    {% if current_value > 0 %}
    <!-- Time Period Selector -->
    <div style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
      <button onclick="updateProjection(1)" id="btn-1yr" class="projection-btn active" style="padding: 0.75rem 1.5rem; border: 1px solid #6B6A45; background: #6B6A45; color: white; border-radius: 0; font-weight: 500; cursor: pointer; transition: all 0.3s; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem;">1 Year</button>
      <button onclick="updateProjection(3)" id="btn-3yr" class="projection-btn" style="padding: 0.75rem 1.5rem; border: 1px solid #6B6A45; background: white; color: #6B6A45; border-radius: 0; font-weight: 500; cursor: pointer; transition: all 0.3s; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem;">3 Years</button>
      <button onclick="updateProjection(5)" id="btn-5yr" class="projection-btn" style="padding: 0.75rem 1.5rem; border: 1px solid #6B6A45; background: white; color: #6B6A45; border-radius: 0; font-weight: 500; cursor: pointer; transition: all 0.3s; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem;">5 Years</button>
      <button onclick="updateProjection(10)" id="btn-10yr" class="projection-btn" style="padding: 0.75rem 1.5rem; border: 1px solid #6B6A45; background: white; color: #6B6A45; border-radius: 0; font-weight: 500; cursor: pointer; transition: all 0.3s; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.85rem;">10 Years</button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
      <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, var(--light-cream) 0%, var(--soft-tan) 100%); border-radius: 12px;">
        <div style="font-size: 0.85rem; color: #6B6A45; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem;">Projected Value</div>
        <div id="projected-value" style="font-size: 2.2rem; font-weight: 400; color: #3A352C; font-family: var(--font-heading);">${{ "{:,.0f}".format(one_year_value) }}</div>
        <div id="value-increase" style="font-size: 0.85rem; color: #6B6A45; margin-top: 0.5rem; font-weight: 500;">+${{ "{:,.0f}".format(one_year_value - current_value) }}</div>
      </div>

      <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #5A6D47 0%, #4a5d3a 100%); border-radius: 12px; color: white;">
        <div style="font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem; opacity: 0.95;">Projected Equity</div>
        <div id="projected-equity" style="font-size: 2.2rem; font-weight: 400; font-family: var(--font-heading);">${{ "{:,.0f}".format(equity_estimate + (one_year_value - current_value)) }}</div>
        <div id="equity-increase" style="font-size: 0.85rem; margin-top: 0.5rem; font-weight: 500; opacity: 0.9;">+${{ "{:,.0f}".format(one_year_value - current_value) }}</div>
      </div>

      <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, var(--light-cream) 0%, var(--soft-tan) 100%); border-radius: 12px;">
        <div style="font-size: 0.85rem; color: #6B6A45; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem;">Appreciation Rate</div>
        <div style="font-size: 2.2rem; font-weight: 700; color: var(--charcoal-brown);">4.0%</div>
        <div style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;">Annual estimate</div>
      </div>

      <div style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, var(--light-cream) 0%, var(--soft-tan) 100%); border-radius: 12px;">
        <div style="font-size: 0.85rem; color: var(--olive-green); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">Monthly Growth</div>
        <div id="monthly-growth" style="font-size: 2.2rem; font-weight: 700; color: var(--charcoal-brown);">${{ "{:,.0f}".format(monthly_appreciation) }}</div>
        <div style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;">Per month</div>
      </div>
    </div>

    <!-- Interactive Timeline Bars -->
    <div style="background: var(--light-cream); padding: 2rem; border-radius: 12px;">
      <h3 style="margin-bottom: 1.5rem; font-size: 1.1rem; color: var(--charcoal-brown);">Year-by-Year Growth Timeline</h3>
      <div id="timeline-bars" style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- Timeline bars will be generated by JavaScript -->
      </div>
    </div>

    <script>
      const currentValue = {{ current_value }};
      const currentEquity = {{ equity_estimate }};
      const loanBalance = {{ loan_balance }};
      const appreciationRate = 0.04;

      function updateProjection(years) {
        // Update button states
        const buttons = document.querySelectorAll('.projection-btn');
        buttons.forEach(btn => {
          btn.style.background = 'white';
          btn.style.color = 'var(--olive-green)';
          btn.classList.remove('active');
        });
        
        const activeBtn = document.getElementById(`btn-${years}yr`);
        if (activeBtn) {
          activeBtn.style.background = 'var(--olive-green)';
          activeBtn.style.color = 'white';
          activeBtn.classList.add('active');
        }

        // Calculate projections
        const futureValue = currentValue * Math.pow(1 + appreciationRate, years);
        const valueIncrease = futureValue - currentValue;
        const futureEquity = currentEquity + valueIncrease;
        const monthlyGrowth = (futureValue - currentValue) / (years * 12);

        // Update displays with null checks
        const projectedValueEl = document.getElementById('projected-value');
        const valueIncreaseEl = document.getElementById('value-increase');
        const projectedEquityEl = document.getElementById('projected-equity');
        const equityIncreaseEl = document.getElementById('equity-increase');
        const monthlyGrowthEl = document.getElementById('monthly-growth');
        
        if (projectedValueEl) projectedValueEl.textContent = '$' + formatCurrency(futureValue);
        if (valueIncreaseEl) valueIncreaseEl.textContent = '+$' + formatCurrency(valueIncrease);
        if (projectedEquityEl) projectedEquityEl.textContent = '$' + formatCurrency(futureEquity);
        if (equityIncreaseEl) equityIncreaseEl.textContent = '+$' + formatCurrency(valueIncrease);
        if (monthlyGrowthEl) monthlyGrowthEl.textContent = '$' + formatCurrency(monthlyGrowth);

        // Generate timeline bars
        generateTimeline(years);
      }

      function generateTimeline(years) {
        const container = document.getElementById('timeline-bars');
        if (!container) return;
        container.innerHTML = '';
        
        if (!currentValue || currentValue <= 0) return;
        
        const maxYears = Math.min(years, 10);
        for (let year = 1; year <= maxYears; year++) {
          const yearValue = currentValue * Math.pow(1 + appreciationRate, year);
          const yearEquity = currentEquity + (yearValue - currentValue);
          const percentage = (yearValue - currentValue) / (currentValue * Math.pow(1 + appreciationRate, maxYears) - currentValue) * 100;
          
          const yearDiv = document.createElement('div');
          yearDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 1rem;">
              <div style="min-width: 60px; font-size: 0.85rem; font-weight: 600; color: var(--olive-green);">Year ${year}</div>
              <div style="flex: 1; height: 36px; background: white; border-radius: 18px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                <div style="height: 100%; background: #6B6A45; width: ${percentage}%; transition: width 1s ease; display: flex; align-items: center; padding-left: 1rem; color: white; font-weight: 500; font-size: 0.85rem;">
                  $${Math.round(yearValue).toLocaleString()}
                </div>
              </div>
              <div style="min-width: 120px; text-align: right; font-size: 0.85rem; color: #888;">
                +$${Math.round(yearValue - currentValue).toLocaleString()}
              </div>
            </div>
          `;
          container.appendChild(yearDiv);
        }
      }

      // Initialize with 1 year view
      document.addEventListener('DOMContentLoaded', function() {
        generateTimeline(1);
      });
    </script>
    {% else %}
    <div style="text-align: center; padding: 3rem 1rem; color: #888;">
      <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üìà</div>
      <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Enter your home value below</p>
      <p style="font-size: 0.9rem;">to see your personalized wealth growth projections!</p>
    </div>
    {% endif %}
  </div>

  <!-- Quick Update Form - Streamlined -->
  <div class="card" style="margin-bottom: 2rem; background: white; box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">‚öôÔ∏è</span>
          <span>Update Loan Information</span>
        </h2>
        <p class="card-subtext" style="margin: 0.5rem 0 0;">Keep your data current for accurate projections and insights</p>
      </div>
      <button onclick="toggleFormExpanded()" id="form-toggle-btn" style="background: var(--olive-green); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: all 0.3s;">
        ‚úèÔ∏è Quick Update
      </button>
    </div>
    
    <div id="loan-form-container" style="display: none;">
      <form method="post" style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
        <div>
          <label for="value_estimate" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">üí∞ Current Home Value</label>
          <input type="text" id="value_estimate" name="value_estimate" placeholder="e.g., 450,000" value="{% if current_value > 0 %}{{ current_value|int }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--olive-green)'" onblur="this.style.borderColor='var(--taupe-beige)'" />
        </div>
        
        <div>
          <label for="loan_balance" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">üè¶ Current Loan Balance</label>
          <input type="text" id="loan_balance" name="loan_balance" placeholder="e.g., 320,000" value="{% if loan_balance > 0 %}{{ loan_balance|int }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--olive-green)'" onblur="this.style.borderColor='var(--taupe-beige)'" />
        </div>
        
        <div>
          <label for="loan_rate" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">üìä Interest Rate (%)</label>
          <input type="text" id="loan_rate" name="loan_rate" placeholder="e.g., 6.25" value="{% if loan_rate > 0 %}{{ loan_rate }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--olive-green)'" onblur="this.style.borderColor='var(--taupe-beige)'" />
        </div>
        
        <div>
          <label for="loan_payment" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">üí≥ Monthly Payment</label>
          <input type="text" id="loan_payment" name="loan_payment" placeholder="e.g., 2,400" value="{% if loan_payment > 0 %}{{ loan_payment|int }}{% endif %}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--olive-green)'" onblur="this.style.borderColor='var(--taupe-beige)'" />
        </div>
        
        <div>
          <label for="loan_term_years" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">üìÖ Loan Term</label>
          <select id="loan_term_years" name="loan_term_years" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem; background: white; cursor: pointer; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--olive-green)'" onblur="this.style.borderColor='var(--taupe-beige)'">
            <option value="">Select term...</option>
            <option value="15" {% if loan_term_years == 15 %}selected{% endif %}>15 years</option>
            <option value="20" {% if loan_term_years == 20 %}selected{% endif %}>20 years</option>
            <option value="30" {% if loan_term_years == 30 %}selected{% endif %}>30 years</option>
          </select>
        </div>
        
        <div>
          <label for="loan_start_date" style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">üóìÔ∏è Loan Start Date</label>
          <input type="date" id="loan_start_date" name="loan_start_date" value="{{ loan_start_date or '' }}" style="width: 100%; padding: 0.875rem; border: 2px solid var(--taupe-beige); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s;" onfocus="this.style.borderColor='var(--olive-green)'" onblur="this.style.borderColor='var(--taupe-beige)'" />
        </div>
        
        <div style="grid-column: 1 / -1; display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="btn btn-primary" onclick="this.disabled=true; this.textContent='üíæ Saving...'; this.form.submit();" style="flex: 1; padding: 1rem; font-size: 1.05rem; box-shadow: 0 4px 12px rgba(90, 109, 71, 0.3);">üíæ Save & Update Dashboard</button>
          <button type="button" onclick="toggleFormExpanded()" class="btn btn-outline" style="padding: 1rem 2rem;">Cancel</button>
        </div>
      </form>
    </div>

    <div id="current-info-display" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      {% if current_value > 0 or loan_balance > 0 %}
        {% if current_value > 0 %}
        <div style="padding: 1rem; background: var(--light-cream); border-radius: 8px; border-left: 3px solid var(--olive-green);">
          <div style="font-size: 0.75rem; color: var(--olive-green); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.25rem;">Home Value</div>
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--charcoal-brown);">${{ "{:,.0f}".format(current_value) }}</div>
        </div>
        {% endif %}
        
        {% if loan_balance > 0 %}
        <div style="padding: 1rem; background: var(--light-cream); border-radius: 8px; border-left: 3px solid var(--taupe-beige);">
          <div style="font-size: 0.75rem; color: var(--olive-green); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.25rem;">Loan Balance</div>
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--charcoal-brown);">${{ "{:,.0f}".format(loan_balance) }}</div>
        </div>
        {% endif %}
        
        {% if loan_rate > 0 %}
        <div style="padding: 1rem; background: var(--light-cream); border-radius: 8px; border-left: 3px solid var(--taupe-beige);">
          <div style="font-size: 0.75rem; color: var(--olive-green); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.25rem;">Interest Rate</div>
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--charcoal-brown);">{{ "{:.2f}".format(loan_rate) }}%</div>
        </div>
        {% endif %}
        
        {% if loan_payment > 0 %}
        <div style="padding: 1rem; background: var(--light-cream); border-radius: 8px; border-left: 3px solid var(--taupe-beige);">
          <div style="font-size: 0.75rem; color: var(--olive-green); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.25rem;">Monthly Payment</div>
          <div style="font-size: 1.5rem; font-weight: 700; color: var(--charcoal-brown);">${{ "{:,.0f}".format(loan_payment) }}</div>
        </div>
        {% endif %}
      {% else %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #888;">
          <div style="font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.3;">üìù</div>
          <p>Click "Quick Update" to add your loan information</p>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
  function toggleFormExpanded() {
    const form = document.getElementById('loan-form-container');
    const display = document.getElementById('current-info-display');
    const btn = document.getElementById('form-toggle-btn');
    
    if (!form || !display || !btn) return;      if (form.style.display === 'none') {
        form.style.display = 'block';
        display.style.display = 'none';
        btn.textContent = '‚úñÔ∏è Close';
        btn.style.background = 'var(--taupe-beige)';
      } else {
        form.style.display = 'none';
        display.style.display = 'grid';
        btn.textContent = '‚úèÔ∏è Quick Update';
        btn.style.background = 'var(--olive-green)';
      }
    }
  </script>

  <!-- Enhanced Mortgage Optimizer with Live Calculations -->
  <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #3A352C 0%, #4a3f35 100%); color: white; box-shadow: 0 8px 24px rgba(0,0,0,0.2);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
      <div>
        <h2 style="color: var(--soft-tan); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.5rem;">‚ö°</span>
          <span>Mortgage Payoff Accelerator</span>
        </h2>
        <p style="color: var(--taupe-beige); margin: 0.5rem 0 0;">See how extra monthly payments can save you thousands and years of debt</p>
      </div>
      {% if loan_balance > 0 and loan_rate > 0 and loan_payment > 0 %}
      <div style="background: rgba(186,140,97,0.2); padding: 0.5rem 1rem; border-radius: 20px; border: 2px solid var(--olive-green);">
        <span style="font-size: 0.85rem; font-weight: 600;">‚úÖ Calculator Active</span>
      </div>
      {% else %}
      <div style="background: rgba(186,140,97,0.15); padding: 0.5rem 1rem; border-radius: 20px; border: 2px solid rgba(186,140,97,0.3);">
        <span style="font-size: 0.85rem; font-weight: 600;">‚ÑπÔ∏è Add loan details above</span>
      </div>
      {% endif %}
    </div>

    <div style="background: rgba(255,255,255,0.08); border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
        <label style="font-weight: 600; color: var(--soft-tan); font-size: 1.05rem;">Extra Monthly Payment Amount</label>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button onclick="setExtraPayment(0)" class="quick-btn" style="padding: 0.4rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 16px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;">$0</button>
          <button onclick="setExtraPayment(100)" class="quick-btn" style="padding: 0.4rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 16px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;">$100</button>
          <button onclick="setExtraPayment(200)" class="quick-btn" style="padding: 0.4rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 16px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;">$200</button>
          <button onclick="setExtraPayment(500)" class="quick-btn" style="padding: 0.4rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 16px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;">$500</button>
          <button onclick="setExtraPayment(1000)" class="quick-btn" style="padding: 0.4rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 16px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;">$1,000</button>
        </div>
      </div>
      <div style="font-size: 3.5rem; font-weight: 700; color: var(--olive-green); margin: 1.5rem 0; text-align: center;">
        $<span id="extra-amount-display">200</span>
      </div>
      <input type="range" id="extra-payment-slider" min="0" max="2000" step="25" value="200" style="width: 100%; height: 12px; border-radius: 6px; background: rgba(255,255,255,0.2); outline: none; cursor: pointer; appearance: none; -webkit-appearance: none;" />
      <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--taupe-beige); margin-top: 0.75rem;">
        <span>$0/mo</span>
        <span>$2,000/mo</span>
      </div>
    </div>

    <style>
      #extra-payment-slider::-webkit-slider-thumb {
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--olive-green);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      #extra-payment-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--olive-green);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      .quick-btn:hover {
        background: rgba(255,255,255,0.2) !important;
        border-color: var(--olive-green) !important;
      }
    </style>

    <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 2rem;">
      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); border-radius: 12px; padding: 2rem; text-align: center; color: var(--charcoal-brown); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üí∞</div>
        <div style="font-size: 0.8rem; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; font-weight: 600;">Interest Saved</div>
        <div style="font-size: 2.8rem; font-weight: 400; margin-bottom: 0.5rem; color: #6B6A45; font-family: var(--font-heading);">$<span id="interest-saved">0</span></div>
        <div style="font-size: 0.85rem; color: #777;">Over life of loan</div>
      </div>

      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); border-radius: 12px; padding: 2rem; text-align: center; color: var(--charcoal-brown); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">‚è∞</div>
        <div style="font-size: 0.8rem; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; font-weight: 600;">Time Saved</div>
        <div style="font-size: 2.8rem; font-weight: 700; margin-bottom: 0.5rem; color: #2d5016;">
          <span id="years-saved">0</span><span style="font-size: 1.5rem;">y</span> <span id="months-saved">0</span><span style="font-size: 1.5rem;">m</span>
        </div>
        <div style="font-size: 0.85rem; color: #777;">Earlier payoff</div>
      </div>

      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); border-radius: 12px; padding: 2rem; text-align: center; color: var(--charcoal-brown); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üìÖ</div>
        <div style="font-size: 0.8rem; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; font-weight: 600;">New Payoff Date</div>
        <div style="font-size: 1.8rem; font-weight: 400; margin-bottom: 0.5rem; color: #6B6A45; font-family: var(--font-heading);"><span id="new-payoff-date">TBD</span></div>
        <div style="font-size: 0.85rem; color: #777;">vs. <span id="original-payoff-date">{{ payoff_date or 'Unknown' }}</span></div>
      </div>

      <div style="background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); border-radius: 12px; padding: 2rem; text-align: center; color: var(--charcoal-brown); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üìà</div>
        <div style="font-size: 0.8rem; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem; font-weight: 600;">Total Interest Paid</div>
        <div style="font-size: 1.6rem; font-weight: 700; margin-bottom: 0.25rem; color: #888; text-decoration: line-through;">$<span id="original-interest">0</span></div>
        <div style="font-size: 2rem; font-weight: 400; color: #6B6A45; font-family: var(--font-heading);">$<span id="new-interest">0</span></div>
      </div>
    </div>

    <div id="comparison-message" style="background: rgba(186,140,97,0.15); border-left: 4px solid var(--olive-green); padding: 1.5rem; border-radius: 8px; font-size: 1rem; line-height: 1.7;">
      üí° Adjust the slider above to see how different extra payment amounts impact your mortgage payoff!
    </div>

    <!-- Comparison Scenarios -->
    <div id="scenario-comparison" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.1);">
      <h3 style="color: var(--soft-tan); margin-bottom: 1.5rem; font-size: 1.2rem;">Compare Popular Strategies</h3>
      <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
        <div style="background: rgba(255,255,255,0.08); padding: 1.25rem; border-radius: 8px; border: 2px solid rgba(186,140,97,0.2);">
          <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--soft-tan);">Current Plan</div>
          <div style="font-size: 0.85rem; line-height: 1.6;">
            <div style="margin-bottom: 0.5rem;">Payment: <strong id="scenario-current-payment">$0</strong></div>
            <div style="margin-bottom: 0.5rem;">Payoff: <strong id="scenario-current-date">‚Äî</strong></div>
            <div>Interest: <strong id="scenario-current-interest">$0</strong></div>
          </div>
        </div>
        
        <div style="background: rgba(90,109,71,0.15); padding: 1.25rem; border-radius: 8px; border: 2px solid var(--olive-green);">
          <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--olive-green);">+$100/month</div>
          <div style="font-size: 0.85rem; line-height: 1.6;">
            <div style="margin-bottom: 0.5rem;">Payment: <strong id="scenario-100-payment">$0</strong></div>
            <div style="margin-bottom: 0.5rem;">Payoff: <strong id="scenario-100-date">‚Äî</strong></div>
            <div>Interest: <strong id="scenario-100-interest">$0</strong></div>
          </div>
        </div>
        
        <div style="background: rgba(90,109,71,0.15); padding: 1.25rem; border-radius: 8px; border: 2px solid var(--olive-green);">
          <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--olive-green);">+$500/month</div>
          <div style="font-size: 0.85rem; line-height: 1.6;">
            <div style="margin-bottom: 0.5rem;">Payment: <strong id="scenario-500-payment">$0</strong></div>
            <div style="margin-bottom: 0.5rem;">Payoff: <strong id="scenario-500-date">‚Äî</strong></div>
            <div>Interest: <strong id="scenario-500-interest">$0</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const loanData = {
      balance: {{ loan_balance or 0 }},
      rate: {{ loan_rate or 0 }},
      payment: {{ loan_payment or 0 }},
      termYears: {{ loan_term_years or 0 }},
      startDate: "{{ loan_start_date or '' }}"
    };

    function formatCurrency(num) {
      return Math.round(num).toLocaleString('en-US');
    }

    function setExtraPayment(amount) {
      const slider = document.getElementById('extra-payment-slider');
      if (slider) {
        slider.value = amount;
        updateOptimizer();
      }
    }

    function calculatePayoff(extraPayment) {
      if (!loanData.balance || !loanData.rate || !loanData.payment) {
        return { 
          interestSaved: 0, 
          monthsSaved: 0, 
          newPayoffDate: 'Enter loan details',
          originalInterest: 0,
          newInterest: 0,
          originalMonths: 0,
          newMonths: 0
        };
      }

      const monthlyRate = loanData.rate / 100 / 12;
      const maxMonths = loanData.termYears > 0 ? loanData.termYears * 12 : 360;
      
      // Calculate original payoff
      let balance = loanData.balance, months = 0, totalInterest = 0;
      while (balance > 0.01 && months < maxMonths) {
        const interestPayment = balance * monthlyRate;
        const principalPayment = loanData.payment - interestPayment;
        if (principalPayment <= 0) break;
        totalInterest += interestPayment;
        balance -= principalPayment;
        months++;
      }

      // Calculate with extra payments
      const totalPayment = loanData.payment + extraPayment;
      let balanceExtra = loanData.balance, monthsExtra = 0, totalInterestExtra = 0;
      while (balanceExtra > 0.01 && monthsExtra < maxMonths) {
        const interestPayment = balanceExtra * monthlyRate;
        const principalPayment = totalPayment - interestPayment;
        if (principalPayment <= 0) break;
        totalInterestExtra += interestPayment;
        balanceExtra -= principalPayment;
        monthsExtra++;
      }

      let newPayoffDate = 'Unknown';
      if (loanData.startDate && monthsExtra > 0) {
        try {
          const start = new Date(loanData.startDate);
          if (!isNaN(start.getTime())) {
            const payoff = new Date(start);
            payoff.setMonth(payoff.getMonth() + monthsExtra);
            newPayoffDate = payoff.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          }
        } catch (e) {}
      }

      return {
        interestSaved: Math.max(0, totalInterest - totalInterestExtra),
        monthsSaved: Math.max(0, months - monthsExtra),
        newPayoffDate: newPayoffDate,
        originalInterest: totalInterest,
        newInterest: totalInterestExtra,
        originalMonths: months,
        newMonths: monthsExtra
      };
    }

    function updateOptimizer() {
      const slider = document.getElementById('extra-payment-slider');
      if (!slider) return;
      
      const extraPayment = parseFloat(slider.value);
      const displayEl = document.getElementById('extra-amount-display');
      if (displayEl) displayEl.textContent = formatCurrency(extraPayment);

      const results = calculatePayoff(extraPayment);
      const hasLoanData = loanData.balance > 0 && loanData.rate > 0 && loanData.payment > 0;
      
      // Update all display elements with null checks
      const interestSavedEl = document.getElementById('interest-saved');
      const yearsSavedEl = document.getElementById('years-saved');
      const monthsSavedEl = document.getElementById('months-saved');
      const newPayoffDateEl = document.getElementById('new-payoff-date');
      const originalInterestEl = document.getElementById('original-interest');
      const newInterestEl = document.getElementById('new-interest');
      const comparisonMessageEl = document.getElementById('comparison-message');
      const scenarioComparisonEl = document.getElementById('scenario-comparison');
      
      if (!hasLoanData) {
        if (interestSavedEl) interestSavedEl.textContent = '---';
        if (yearsSavedEl) yearsSavedEl.textContent = '--';
        if (monthsSavedEl) monthsSavedEl.textContent = '--';
        if (newPayoffDateEl) newPayoffDateEl.textContent = 'Enter details';
        if (originalInterestEl) originalInterestEl.textContent = '0';
        if (newInterestEl) newInterestEl.textContent = '0';
        if (comparisonMessageEl) comparisonMessageEl.innerHTML = '‚¨ÜÔ∏è <strong>Fill out your loan information above</strong> to unlock the power of this calculator! You\'ll see exactly how much you can save with extra payments.';
        if (scenarioComparisonEl) scenarioComparisonEl.style.display = 'none';
      } else {
        if (interestSavedEl) interestSavedEl.textContent = formatCurrency(results.interestSaved);
        const yearsSaved = Math.floor(results.monthsSaved / 12);
        const monthsSavedRemainder = Math.round(results.monthsSaved % 12);
        if (yearsSavedEl) yearsSavedEl.textContent = yearsSaved;
        if (monthsSavedEl) monthsSavedEl.textContent = monthsSavedRemainder;
        if (newPayoffDateEl) newPayoffDateEl.textContent = results.newPayoffDate;
        if (originalInterestEl) originalInterestEl.textContent = formatCurrency(results.originalInterest);
        if (newInterestEl) newInterestEl.textContent = formatCurrency(results.newInterest);

        if (comparisonMessageEl) {
          if (extraPayment > 0 && results.interestSaved > 0) {
            comparisonMessageEl.innerHTML = `üéØ <strong>By paying $${formatCurrency(extraPayment)} extra each month</strong>, you'll save <strong>$${formatCurrency(results.interestSaved)}</strong> in interest and own your home <strong>${yearsSaved} years ${monthsSavedRemainder} months earlier</strong>! That's the power of strategic payments.`;
          } else {
            comparisonMessageEl.innerHTML = 'üí° Move the slider to see how extra payments can dramatically reduce your loan burden and build equity faster!';
          }
        }

        // Update scenario comparison
        updateScenarios();
        if (scenarioComparisonEl) scenarioComparisonEl.style.display = 'block';
      }
    }

    function updateScenarios() {
      // Current plan
      const current = calculatePayoff(0);
      const currentPaymentEl = document.getElementById('scenario-current-payment');
      const currentDateEl = document.getElementById('scenario-current-date');
      const currentInterestEl = document.getElementById('scenario-current-interest');
      
      if (currentPaymentEl) currentPaymentEl.textContent = '$' + formatCurrency(loanData.payment);
      if (currentDateEl) currentDateEl.textContent = current.newPayoffDate;
      if (currentInterestEl) currentInterestEl.textContent = '$' + formatCurrency(current.originalInterest);

      // +$100/month
      const s100 = calculatePayoff(100);
      const s100PaymentEl = document.getElementById('scenario-100-payment');
      const s100DateEl = document.getElementById('scenario-100-date');
      const s100InterestEl = document.getElementById('scenario-100-interest');
      
      if (s100PaymentEl) s100PaymentEl.textContent = '$' + formatCurrency(loanData.payment + 100);
      if (s100DateEl) s100DateEl.textContent = s100.newPayoffDate;
      if (s100InterestEl) s100InterestEl.textContent = '$' + formatCurrency(s100.newInterest);

      // +$500/month
      const s500 = calculatePayoff(500);
      const s500PaymentEl = document.getElementById('scenario-500-payment');
      const s500DateEl = document.getElementById('scenario-500-date');
      const s500InterestEl = document.getElementById('scenario-500-interest');
      
      if (s500PaymentEl) s500PaymentEl.textContent = '$' + formatCurrency(loanData.payment + 500);
      if (s500DateEl) s500DateEl.textContent = s500.newPayoffDate;
      if (s500InterestEl) s500InterestEl.textContent = '$' + formatCurrency(s500.newInterest);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const slider = document.getElementById('extra-payment-slider');
      if (slider) {
        slider.addEventListener('input', updateOptimizer);
        updateOptimizer();
      }
    });
  </script>

  <!-- Smart Tips & Action Items -->
  {% if tips %}
  <div class="card" style="margin-bottom: 2rem; background: white; box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
      <span style="font-size: 1.5rem;">üí°</span>
      <span>Personalized Savings Opportunities</span>
    </h2>
    <p class="card-subtext" style="margin-bottom: 2rem;">Based on your current loan profile, here are strategic moves you could make:</p>
    <div style="display: grid; gap: 1.25rem;">
      {% for tip in tips %}
        <div style="background: linear-gradient(135deg, var(--light-cream) 0%, var(--soft-tan) 100%); border-left: 4px solid var(--olive-green); padding: 1.5rem; border-radius: 8px; font-size: 0.95rem; line-height: 1.7; display: flex; gap: 1rem; align-items: flex-start; transition: transform 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
          <div style="font-size: 1.8rem; flex-shrink: 0;">
            {% if 'refinanc' in tip.lower() %}üéØ
            {% elif 'payment' in tip.lower() %}üíé
            {% elif 'PMI' in tip %}‚ú®
            {% elif 'equity' in tip.lower() %}üè°
            {% elif 'save' in tip.lower() or 'saving' in tip.lower() %}üí∞
            {% else %}üìä
            {% endif %}
          </div>
          <div style="flex: 1;">{{ tip }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Equity Usage Scenarios -->
  {% if equity_estimate > 50000 %}
  <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, var(--soft-tan) 0%, var(--light-cream) 100%); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
      <span style="font-size: 1.5rem;">üéØ</span>
      <span>What You Could Do With Your Equity</span>
    </h2>
    <p class="card-subtext" style="margin-bottom: 2rem;">Your equity represents real financial power. Here are common ways homeowners leverage it:</p>
    
    <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
      <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üè†</div>
        <h3 style="font-size: 1.1rem; color: var(--charcoal-brown); margin-bottom: 0.75rem;">Home Renovations</h3>
        <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin-bottom: 1rem;">Fund kitchen remodels, bathroom upgrades, or additions that increase both enjoyment and home value.</p>
        <div style="background: var(--light-cream); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--olive-green); font-weight: 600;">
          Potential: ${{ "{:,.0f}".format(equity_estimate * 0.8) }} available
        </div>
      </div>

      <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üí≥</div>
        <h3 style="font-size: 1.1rem; color: var(--charcoal-brown); margin-bottom: 0.75rem;">Debt Consolidation</h3>
        <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin-bottom: 1rem;">Pay off high-interest credit cards or loans by tapping into lower-rate home equity.</p>
        <div style="background: var(--light-cream); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--olive-green); font-weight: 600;">
          Could save 10-20% in interest
        </div>
      </div>

      <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üè°</div>
        <h3 style="font-size: 1.1rem; color: var(--charcoal-brown); margin-bottom: 0.75rem;">Down Payment</h3>
        <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin-bottom: 1rem;">Use equity as a down payment for a new home, investment property, or vacation home.</p>
        <div style="background: var(--light-cream); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--olive-green); font-weight: 600;">
          Leverage for next property
        </div>
      </div>

      <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üéì</div>
        <h3 style="font-size: 1.1rem; color: var(--charcoal-brown); margin-bottom: 0.75rem;">Education Funding</h3>
        <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin-bottom: 1rem;">Invest in education for yourself or family members at lower interest rates than student loans.</p>
        <div style="background: var(--light-cream); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--olive-green); font-weight: 600;">
          Education investment option
        </div>
      </div>

      <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üíº</div>
        <h3 style="font-size: 1.1rem; color: var(--charcoal-brown); margin-bottom: 0.75rem;">Business Investment</h3>
        <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin-bottom: 1rem;">Fund a business startup or expansion with more favorable terms than business loans.</p>
        <div style="background: var(--light-cream); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--olive-green); font-weight: 600;">
          Entrepreneurial leverage
        </div>
      </div>

      <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üõ°Ô∏è</div>
        <h3 style="font-size: 1.1rem; color: var(--charcoal-brown); margin-bottom: 0.75rem;">Emergency Reserve</h3>
        <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin-bottom: 1rem;">Establish a HELOC as a safety net for unexpected expenses or opportunities.</p>
        <div style="background: var(--light-cream); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--olive-green); font-weight: 600;">
          Financial safety net
        </div>
      </div>
    </div>

    <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(58, 53, 44, 0.05); border-radius: 8px; border-left: 4px solid var(--olive-green);">
      <div style="font-size: 0.85rem; font-weight: 600; color: var(--olive-green); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem;">‚ö†Ô∏è Important Note</div>
      <p style="font-size: 0.9rem; line-height: 1.6; color: #666; margin: 0;">Using home equity means borrowing against your home. Always consult with a financial advisor to understand the risks and ensure any equity access strategy aligns with your long-term financial goals.</p>
    </div>
  </div>
  {% endif %}

  <!-- Educational Content -->
  <div class="card" style="margin-bottom: 2rem; background: white; box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
    <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
      <span style="font-size: 1.5rem;">üìö</span>
      <span>Understanding Your Equity</span>
    </h2>
    <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
      <div style="padding: 1.5rem; background: var(--light-cream); border-radius: 8px;">
        <h3 style="font-size: 1rem; color: var(--olive-green); margin-bottom: 0.75rem; font-weight: 600;">What is Home Equity?</h3>
        <p style="font-size: 0.9rem; line-height: 1.7; color: #666;">Equity is the difference between your home's current market value and what you owe on your mortgage. It represents the portion of your home you truly own outright. As you pay down your mortgage and your home appreciates, your equity grows.</p>
      </div>

      <div style="padding: 1.5rem; background: var(--light-cream); border-radius: 8px;">
        <h3 style="font-size: 1rem; color: var(--olive-green); margin-bottom: 0.75rem; font-weight: 600;">How Equity Grows</h3>
        <p style="font-size: 0.9rem; line-height: 1.7; color: #666;">Your equity increases in two ways: through mortgage principal payments (forced savings) and home value appreciation (market growth). Both work together to build wealth over time, making homeownership a powerful wealth-building tool.</p>
      </div>

      <div style="padding: 1.5rem; background: var(--light-cream); border-radius: 8px;">
        <h3 style="font-size: 1rem; color: var(--olive-green); margin-bottom: 0.75rem; font-weight: 600;">LTV Ratio Explained</h3>
        <p style="font-size: 0.9rem; line-height: 1.7; color: #666;">Loan-to-Value (LTV) is your loan balance divided by your home's value. Lower LTV means more equity. Below 80% LTV, you may eliminate PMI. Below 50% LTV opens access to better refinancing terms and equity products.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}
