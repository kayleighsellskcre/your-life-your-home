{% extends "homeowner/layout.html" %}

{% block homeowner_content %}

<!-- Luxurious Ombre Background - Bright Creams, Sages, Golds -->
<div style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: linear-gradient(135deg, 
    #FEFCF8 0%, 
    #FCF9F4 15%, 
    #F5F2EA 30%, 
    #EFECE0 45%, 
    #E8E4D8 60%, 
    #E0DCD0 75%, 
    #D8D4C8 90%, 
    #D0CCC0 100%);
  z-index: -1000;
  pointer-events: none;
  opacity: 1;
"></div>

<!-- Luxurious Gradient Overlay with Gold Accents -->
<div style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: 
    radial-gradient(ellipse at 15% 25%, rgba(255, 215, 80, 0.4) 0%, rgba(255, 215, 80, 0.15) 40%, transparent 70%),
    radial-gradient(ellipse at 85% 75%, rgba(160, 180, 150, 0.35) 0%, rgba(160, 180, 150, 0.12) 40%, transparent 70%),
    radial-gradient(ellipse at 50% 50%, rgba(200, 195, 180, 0.2) 0%, rgba(200, 195, 180, 0.08) 50%, transparent 80%),
    radial-gradient(ellipse at 70% 20%, rgba(220, 200, 140, 0.3) 0%, transparent 60%),
    radial-gradient(ellipse at 30% 80%, rgba(255, 250, 240, 0.25) 0%, transparent 50%),
    linear-gradient(135deg, 
      rgba(254, 252, 248, 0.5) 0%, 
      rgba(252, 249, 244, 0.4) 20%, 
      rgba(245, 242, 234, 0.3) 40%, 
      rgba(239, 236, 224, 0.25) 60%, 
      rgba(232, 228, 216, 0.3) 80%, 
      rgba(224, 220, 208, 0.35) 100%);
  z-index: -999;
  pointer-events: none;
  opacity: 1;
"></div>

<!-- Flowing Fabric Endless Scroll Background - Top decorative layer -->
<div class="fabric-scroll-container">
  <div class="fabric-scroll fabric-scroll-1"></div>
  <div class="fabric-scroll fabric-scroll-2"></div>
  <div class="fabric-scroll fabric-scroll-3"></div>
</div>

<style>
  /* ========================================
     FLOWING FABRIC ENDLESS SCROLL ANIMATION
     ======================================== */
  
  .fabric-scroll-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    z-index: -998;
    pointer-events: none;
    opacity: 0.02;
  }
  
  .fabric-scroll {
    position: absolute;
    width: 40vw;
    height: 200vh;
    background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 800%22 preserveAspectRatio=%22none%22%3E%3Cpath d=%22M0,0 Q100,50 200,0 T400,0 L400,800 Q300,750 200,800 T0,800 Z%22 fill=%22%23E8DFD1%22 opacity=%220.6%22/%3E%3Cpath d=%22M50,100 Q150,150 250,100 T450,100 L450,700 Q350,650 250,700 T50,700 Z%22 fill=%22%23D4C7B3%22 opacity=%220.4%22/%3E%3Cpath d=%22M20,200 Q120,240 220,200 T420,200 L420,600 Q320,560 220,600 T20,600 Z%22 fill=%22%23F0E8DA%22 opacity=%220.5%22/%3E%3C/svg%3E');
    background-size: 100% auto;
    background-repeat: repeat-y;
    filter: blur(1px);
  }
  
  .fabric-scroll-1 {
    left: -10%;
    animation: fabricFlow1 60s linear infinite;
    opacity: 0.7;
  }
  
  .fabric-scroll-2 {
    left: 35%;
    animation: fabricFlow2 80s linear infinite;
    animation-delay: -20s;
    opacity: 0.5;
  }
  
  .fabric-scroll-3 {
    right: -10%;
    animation: fabricFlow3 100s linear infinite;
    animation-delay: -40s;
    opacity: 0.6;
  }
  
  @keyframes fabricFlow1 {
    from {
      transform: translateY(-50%) rotate(5deg);
    }
    to {
      transform: translateY(0%) rotate(5deg);
    }
  }
  
  @keyframes fabricFlow2 {
    from {
      transform: translateY(-50%) rotate(-3deg);
    }
    to {
      transform: translateY(0%) rotate(-3deg);
    }
  }
  
  @keyframes fabricFlow3 {
    from {
      transform: translateY(-50%) rotate(4deg);
    }
    to {
      transform: translateY(0%) rotate(4deg);
    }
  }

  /* ========================================
     ELEGANT PINTEREST-STYLE MOOD BOARD
     Mediterranean Plaster with Dried Botanicals
     ======================================== */

  .board-view {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 3rem 5rem;
    min-height: 100vh;
    position: relative;
    z-index: 1;
  }

  /* Action Bar - Hidden on print */
  .board-actions {
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin: 0 -3rem 0;
    border-bottom: 1px solid #EDE8E3;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    z-index: 100;
    position: relative;
  }

  .back-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #9B8B7E;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .back-link:hover {
    color: #6B6A45;
  }

  .board-actions-center {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.3rem;
    align-items: center;
  }

  .board-actions-right {
    margin-left: auto;
    display: flex;
    gap: 0.6rem;
    align-items: center;
  }
  
  /* Layout Switcher */
  .layout-switcher {
    display: flex;
    gap: 0.3rem;
    padding: 0.3rem;
    background: #F6F2E8;
    border-radius: 20px;
  }
  
  .layout-btn {
    padding: 0.5rem 0.9rem;
    border-radius: 16px;
    border: none;
    background: transparent;
    color: #7A7265;
    font-weight: 500;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .layout-btn:hover {
    background: rgba(255, 255, 255, 0.5);
  }
  
  .layout-btn.active {
    background: white;
    color: #6B6A45;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }

  .action-btn {
    padding: 0.7rem 1.3rem;
    border-radius: 24px;
    border: 1px solid #E5DDD0;
    background: white;
    color: #7A7265;
    font-weight: 500;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .action-btn:hover {
    border-color: #C9B8A8;
    background: #FEFDFB;
    transform: translateY(-1px);
  }

  .action-btn.primary {
    background: #6B6A45;
    color: white;
    border-color: #6B6A45;
  }

  .action-btn.primary:hover {
    background: #5a5939;
  }

  /* Elegant Header Area */
  .board-header {
    text-align: center;
    padding: 5rem 2rem 4rem;
    background: transparent;
  }

  .board-category {
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: #B8A89A;
    margin-bottom: 1.5rem;
    font-weight: 500;
  }

  .board-title {
    font-size: 3.2rem;
    margin: 0 0 1.5rem;
    color: #3A352C;
    font-weight: 300;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    font-family: 'Playfair Display', Georgia, serif;
  }

  .board-vision {
    font-size: 1.1rem;
    color: #7A7265;
    font-style: italic;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.7;
    font-weight: 300;
  }

  /* Curated Editorial Collage - Organic Layout (Default) */
  .gallery {
    margin-bottom: 4rem;
    padding: 0 1rem;
  }

  .gallery-collage {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    justify-content: center;
    align-items: flex-start;
    position: relative;
    max-width: 850px;
    margin: 0 auto;
    padding: 2rem 0;
    transition: all 0.4s ease;
  }

  /* Organic/Collage Layout - Staggered with rotation */
  .gallery-collage.organic .gallery-item {
    position: relative;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    transition: all 0.35s ease;
    width: 180px;
    min-height: 180px;
    height: auto;
  }

  .gallery-collage.organic .gallery-item:nth-child(6n+1) {
    transform: rotate(-4deg);
    width: 180px;
    min-height: 180px;
    height: auto;
    margin-top: 20px;
    margin-left: -10px;
  }

  .gallery-collage.organic .gallery-item:nth-child(6n+2) {
    transform: rotate(3deg);
    width: 160px;
    min-height: 160px;
    height: auto;
    margin-top: -15px;
    margin-right: -8px;
  }

  .gallery-collage.organic .gallery-item:nth-child(6n+3) {
    transform: rotate(-2deg);
    width: 200px;
    min-height: 200px;
    height: auto;
    margin-top: 35px;
  }

  .gallery-collage.organic .gallery-item:nth-child(6n+4) {
    transform: rotate(3.5deg);
    width: 170px;
    min-height: 170px;
    height: auto;
    margin-top: -10px;
    margin-left: -12px;
  }

  .gallery-collage.organic .gallery-item:nth-child(6n+5) {
    transform: rotate(-3deg);
    width: 150px;
    min-height: 150px;
    height: auto;
    margin-top: 25px;
    margin-right: -10px;
  }

  .gallery-collage.organic .gallery-item:nth-child(6n) {
    transform: rotate(2.5deg);
    width: 190px;
    min-height: 190px;
    height: auto;
    margin-top: -5px;
  }

  /* Grid Layout - Clean & Organized */
  .gallery-collage.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.2rem;
    max-width: 900px;
  }

  .gallery-collage.grid .gallery-item {
    width: 100% !important;
    min-height: 200px !important;
    height: auto !important;
    transform: none !important;
    margin: 0 !important;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .gallery-collage.grid .gallery-item:hover {
    transform: translateY(-8px) !important;
    box-shadow: 0 12px 32px rgba(0,0,0,0.15);
  }

  /* Editorial/Magazine Layout - Asymmetric Featured */
  .gallery-collage.editorial {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 1rem;
    max-width: 1000px;
  }

  .gallery-collage.editorial .gallery-item {
    transform: none !important;
    margin: 0 !important;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    transition: all 0.3s ease;
    min-height: 200px;
    height: auto;
  }

  .gallery-collage.editorial .gallery-item:nth-child(1) {
    grid-column: span 8;
    grid-row: span 2;
  }

  .gallery-collage.editorial .gallery-item:nth-child(2) {
    grid-column: span 4;
  }

  .gallery-collage.editorial .gallery-item:nth-child(3) {
    grid-column: span 4;
  }

  .gallery-collage.editorial .gallery-item:nth-child(4) {
    grid-column: span 6;
  }

  .gallery-collage.editorial .gallery-item:nth-child(5) {
    grid-column: span 6;
  }

  .gallery-collage.editorial .gallery-item:nth-child(6) {
    grid-column: span 4;
  }

  .gallery-collage.editorial .gallery-item:nth-child(7) {
    grid-column: span 8;
    grid-row: span 2;
  }

  .gallery-collage.editorial .gallery-item:nth-child(8) {
    grid-column: span 4;
  }

  .gallery-collage.editorial .gallery-item:nth-child(n+9) {
    grid-column: span 6;
  }

  .gallery-item {
    position: relative;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    transition: all 0.35s ease;
  }

  .gallery-item:hover {
    transform: scale(1.15) rotate(0deg) !important;
    box-shadow: 0 16px 40px rgba(0,0,0,0.2);
    z-index: 30;
    margin: 0 !important;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
    min-height: 150px;
  }

  /* Elegant Floating Labels - Luxurious positioning on board */
  .floating-labels-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
    overflow: hidden;
  }
  
  .floating-label {
    position: absolute;
    font-size: 0.75rem;
    font-weight: 300;
    color: rgba(107, 106, 69, 0.35);
    text-transform: lowercase;
    letter-spacing: 0.25em;
    padding: 0.5rem 1.2rem;
    background: rgba(255, 255, 255, 0.75);
    border-radius: 30px;
    pointer-events: none;
    font-style: italic;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 20px rgba(107, 106, 69, 0.08), 
                0 1px 3px rgba(107, 106, 69, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
    opacity: 0;
    animation: fadeInFloat 3s ease-out forwards;
    transform: rotate(0deg);
    border: 1px solid rgba(107, 106, 69, 0.08);
    font-family: 'Playfair Display', Georgia, serif;
    white-space: nowrap;
  }
  
  @keyframes fadeInFloat {
    0% {
      opacity: 0;
      transform: translateY(20px) rotate(0deg) scale(0.9);
    }
    100% {
      opacity: 1;
      transform: translateY(0) rotate(var(--label-rotation, 0deg)) scale(1);
    }
  }
  
  .floating-label:nth-child(1) {
    --label-rotation: -2deg;
    animation-delay: 0.5s;
  }
  
  .floating-label:nth-child(2) {
    --label-rotation: 3deg;
    animation-delay: 1s;
  }
  
  .floating-label:nth-child(3) {
    --label-rotation: -4deg;
    animation-delay: 1.5s;
  }
  
  /* Subtle hover effect for labels */
  .floating-label:hover {
    color: rgba(107, 106, 69, 0.5);
    background: rgba(255, 255, 255, 0.85);
    transform: scale(1.05) rotate(var(--label-rotation, 0deg));
    transition: all 0.3s ease;
  }

  /* ========================================
     FIXTURES - Furniture/Items Between Photos
     ======================================== */
  .fixture-item {
    position: relative;
    display: inline-block;
    width: 180px;
    height: auto;
    margin: 0.8rem;
    filter: drop-shadow(0 8px 16px rgba(0,0,0,0.15));
    transition: all 0.3s ease;
    background: transparent;
  }

  .fixture-item img {
    width: 100%;
    height: auto;
    display: block;
    background: transparent;
    /* Minimal CSS processing - let JS handle background removal */
  }

  .fixture-item:hover {
    transform: scale(1.08);
    filter: drop-shadow(0 12px 24px rgba(0,0,0,0.25));
    z-index: 100;
  }

  /* Varied sizing and rotations for organic feel */
  .fixture-item:nth-child(6n+1) {
    width: 170px;
    transform: rotate(-6deg);
    margin-top: -8px;
  }

  .fixture-item:nth-child(6n+2) {
    width: 190px;
    transform: rotate(4deg);
    margin-top: 5px;
  }

  .fixture-item:nth-child(6n+3) {
    width: 160px;
    transform: rotate(-3deg);
    margin-top: -5px;
  }

  .fixture-item:nth-child(6n+4) {
    width: 200px;
    transform: rotate(5deg);
    margin-top: 8px;
  }

  .fixture-item:nth-child(6n+5) {
    width: 175px;
    transform: rotate(-4deg);
    margin-top: -3px;
  }

  .fixture-item:nth-child(6n) {
    width: 185px;
    transform: rotate(3deg);
    margin-top: 6px;
  }

  /* Color Palette Strip at Bottom */
  .color-palette-section {
    background: transparent;
    padding: 3rem 2rem;
    text-align: center;
  }

  .color-palette-title {
    font-size: 0.85rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #B8A89A;
    margin: 0 0 2rem;
    font-weight: 500;
  }

  .color-palette-strip {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 3rem;
    margin-bottom: 3rem;
    flex-wrap: wrap;
    padding: 2rem 1rem;
  }

  .color-swatch-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    position: relative;
  }

  .color-swatch-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    box-shadow: 0 10px 24px rgba(0,0,0,0.18);
    transition: all 0.4s ease;
    border: 4px solid white;
    position: relative;
  }

  .color-swatch-circle:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 14px 32px rgba(0,0,0,0.22);
  }

  .color-swatch-label {
    font-family: 'Playfair Display', 'Georgia', serif;
    font-size: 1rem;
    font-style: italic;
    color: #5A5545;
    letter-spacing: 0.03em;
    text-align: center;
    line-height: 1.5;
    font-weight: 400;
    min-width: 100px;
    max-width: 120px;
    padding: 0 0.5rem;
  }

  /* Subtle footer branding */
  .board-footer {
    text-align: center;
    padding: 2rem 0 3rem;
    color: #C9B8A8;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  /* Empty States */
  .empty-gallery {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    margin-bottom: 3rem;
  }

  .empty-gallery h3 {
    font-size: 1.3rem;
    margin: 0 0 0.8rem;
    color: #B8A89A;
    font-weight: 300;
  }

  .empty-gallery p {
    color: #C9B8A8;
    font-size: 0.95rem;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .board-view {
      padding: 0 1.5rem 3rem;
    }

    .board-title {
      font-size: 2.2rem;
    }

    .gallery-item:nth-child(odd),
    .gallery-item:nth-child(even),
    .gallery-item:nth-child(3n) {
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 90% !important;
    }
  }

  /* Print Styles - Single Page Optimized */
  @media print {
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }

    @page {
      size: letter landscape;
      margin: 0.2in;
    }

    body, html {
      margin: 0 !important;
      padding: 0 !important;
      background: #FAF8F5 !important;
      width: 10.6in !important;
      height: 8.1in !important;
      overflow: hidden !important;
    }

    .ylh-sidebar-nav,
    [role="banner"],
    .board-actions,
    nav,
    .action-btn,
    .back-link,
    .fabric-scroll-container,
    #wallpaper-background,
    #optionsModal,
    #editModal,
    .board-notes-section {
      display: none !important;
    }

    .board-view {
      padding: 0 !important;
      max-width: 10.6in !important;
      width: 10.6in !important;
      background: #FAF8F5 !important;
      height: 8.1in !important;
      overflow: hidden !important;
      display: block !important;
      position: relative !important;
    }

    .board-header {
      padding: 0.15in 0.1in 0.1in !important;
      margin-bottom: 0.1in !important;
      page-break-after: avoid !important;
      page-break-inside: avoid !important;
    }

    .board-category {
      margin-bottom: 0.05in !important;
      font-size: 0.5rem !important;
    }

    .board-title {
      font-size: 1.2rem !important;
      margin-bottom: 0.05in !important;
      line-height: 1.1 !important;
    }

    .board-vision {
      font-size: 0.6rem !important;
      margin: 0 !important;
      line-height: 1.2 !important;
    }

    .gallery {
      padding: 0 0.1in !important;
      margin-bottom: 0.1in !important;
      height: 5.5in !important;
      overflow: hidden !important;
      page-break-inside: avoid !important;
    }

    .gallery-collage {
      gap: 0.08in !important;
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(1in, 1fr)) !important;
      grid-auto-rows: 1in !important;
      height: 100% !important;
      overflow: hidden !important;
    }

    .gallery-item {
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      height: auto !important;
      max-width: 100% !important;
      transform: none !important;
      overflow: visible !important;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      line-height: 0 !important;
    }

    .gallery-item img {
      width: 100% !important;
      height: auto !important;
      max-height: 2.5in !important;
      object-fit: contain !important;
      display: block !important;
      margin: 0 !important;
      padding: 0 !important;
      vertical-align: bottom !important;
    }

    .gallery-item:hover {
      transform: none !important;
    }

    .gallery-item-label {
      display: none !important;
    }

    .fixture-item {
      width: 100% !important;
      height: 1in !important;
      max-height: 1in !important;
      margin: 0 !important;
      transform: none !important;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
    }

    .fixture-item img {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      display: block !important;
    }

    .color-palette-section {
      padding: 0.1in 0.1in 0.05in !important;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      margin-top: 0.05in !important;
    }

    .color-palette-title {
      font-size: 0.6rem !important;
      margin-bottom: 0.05in !important;
    }

    .color-palette-strip {
      gap: 0.15in !important;
      margin-bottom: 0 !important;
    }

    .color-swatch-item {
      gap: 0.05in !important;
    }

    .color-swatch-circle {
      width: 0.35in !important;
      height: 0.35in !important;
    }

    .color-swatch-label {
      font-size: 0.4rem !important;
      min-width: auto !important;
    }

    .color-swatch-circle:hover {
      transform: none !important;
    }

    .board-details-section {
      display: block !important;
      visibility: visible !important;
      padding: 0.15in 0.1in 0.1in !important;
      page-break-inside: avoid !important;
      margin-top: 0.15in !important;
      margin-bottom: 0.1in !important;
      border-top: 2px solid #E5DDD0 !important;
      font-size: 0.6rem !important;
      line-height: 1.5 !important;
    }

    .board-details-title {
      font-size: 0.7rem !important;
      font-weight: 700 !important;
      color: #6B6A45 !important;
      margin-bottom: 0.08in !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
    }

    .board-details-content {
      color: #3A352C !important;
      white-space: pre-wrap !important;
    }

    .board-details-section {
      display: block !important;
      visibility: visible !important;
      padding: 0.15in 0.1in 0.1in !important;
      margin: 0.15in 0.1in 0.1in !important;
      page-break-inside: avoid !important;
      border-top: 2px solid #E5DDD0 !important;
      border-bottom: none !important;
      background: transparent !important;
      box-shadow: none !important;
      font-size: 0.6rem !important;
      line-height: 1.5 !important;
    }

    .board-details-title {
      font-size: 0.6rem !important;
      font-weight: 700 !important;
      color: #6B6A45 !important;
      margin-bottom: 0.05in !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
    }

    .board-details-content {
      color: #3A352C !important;
      font-size: 0.55rem !important;
      line-height: 1.4 !important;
      white-space: pre-wrap !important;
    }

    .board-footer {
      padding: 0.05in 0 !important;
      font-size: 0.45rem !important;
      page-break-inside: avoid !important;
    }
  }
</style>

<div class="board-view">
  <!-- Sticky Action Bar -->
  <div class="board-actions">
    <a href="{{ url_for('homeowner_saved_notes') }}" class="back-link">
      ‚Üê Back to Boards
    </a>
    
    <!-- Centered Layout Switcher -->
    <div class="board-actions-center">
      <div class="layout-switcher">
        <button type="button" class="layout-btn active" onclick="switchLayout('organic')" data-layout="organic">
          Organic
        </button>
        <button type="button" class="layout-btn" onclick="switchLayout('grid')" data-layout="grid">
          Grid
        </button>
        <button type="button" class="layout-btn" onclick="switchLayout('editorial')" data-layout="editorial">
          Magazine
        </button>
      </div>
    </div>
    
    <!-- Right Side Options -->
    <div class="board-actions-right">
      <button type="button" class="action-btn" onclick="showOptionsMenu()">
        ‚öôÔ∏è Options
      </button>
    </div>
  </div>

  <!-- Board Header -->
  <div class="board-header">
    <div class="board-category">Interior Inspiration</div>
    <h1 class="board-title">{{ selected_board }}</h1>
    
    {% if selected_details.vision_statement %}
      <p class="board-vision">"{{ selected_details.vision_statement }}"</p>
    {% endif %}
  </div>


  <!-- Editorial Photo Collage -->
  {% if selected_details.photos and selected_details.photos|length > 0 %}
    <div class="gallery" style="position: relative;">
      <div class="gallery-collage organic" id="galleryCollage">
        {% for photo in selected_details.photos %}
          <div class="gallery-item">
            <img
              src="{{ url_for('static', filename=photo) }}"
              alt="Inspiration photo"
              loading="lazy"
              onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23f5f5f5\' width=\'200\' height=\'200\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\'%3EImage not found%3C/text%3E%3C/svg%3E';"
            />
          </div>
          
          <!-- Insert fixtures between photos after 2nd photo -->
          {% if selected_details.fixtures and loop.index == 2 %}
            {% for fixture in selected_details.fixtures %}
              <div class="fixture-item">
                <img
                  src="{{ url_for('static', filename=fixture) }}"
                  alt="Fixture item"
                  loading="lazy"
                />
              </div>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% else %}
    <div class="empty-gallery">
      <h3>‚ú® No Photos Yet</h3>
      <p>Add inspiration photos to bring this board to life</p>
    </div>
  {% endif %}

  <!-- Color Palette Section -->
  {% if selected_details.color_palette and selected_details.color_palette|length > 0 %}
    <div class="color-palette-section">
      <h2 class="color-palette-title">Color Palette</h2>
      <div class="color-palette-strip">
        {% for color in selected_details.color_palette[:6] %}
          <div class="color-swatch-item">
            <div class="color-swatch-circle" style="background-color: {{ color }};"></div>
            <div class="color-swatch-label">{{ hex_to_color_name(color) }}</div>
          </div>
        {% endfor %}
      </div>
      <div class="board-footer">{{ selected_board }}</div>
    </div>
  {% endif %}

  <!-- Board Details Section (Cost, Dimensions, Notes) -->
  {% if selected_details.details %}
    <div class="board-details-section">
      <div class="board-details-title">Project Details</div>
      <div class="board-details-content">{{ selected_details.details }}</div>
    </div>
  {% endif %}

  <!-- Individual Notes with Edit/Delete Buttons -->
  {% if notes_list and notes_list|length > 0 %}
    <div class="board-notes-section" style="margin-top: 3rem; padding: 2rem; background: rgba(255, 255, 255, 0.6); border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
      <h3 style="font-family: var(--font-heading); font-size: 1.5rem; color: var(--charcoal-brown); margin-bottom: 1.5rem; text-align: center;">Saved Estimates & Notes</h3>
      <div style="display: grid; gap: 1.5rem;">
        {% for note in notes_list %}
          <div class="note-card" style="padding: 1.5rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid var(--taupe-beige); position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              {% if note.title %}
                <h4 style="margin: 0; font-size: 1.25rem; color: var(--charcoal-brown); font-weight: 600; flex: 1;">{{ note.title }}</h4>
              {% endif %}
              <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                <a href="{{ url_for('homeowner_edit_note', note_id=note.id) }}" 
                   style="padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--olive-green); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.25rem;">
                  ‚úèÔ∏è Edit
                </a>
                <button onclick="deleteNote({{ note.id }}, '{{ note.title|e|replace("'", "\\'") if note.title else 'this note' }}')" 
                        style="padding: 0.5rem 1rem; font-size: 0.85rem; background: #f5f5f5; border: 1px solid #ddd; color: #b3574a; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
            {% if note.details %}
              <div style="color: var(--charcoal-brown); line-height: 1.6; white-space: pre-wrap; font-size: 0.95rem;">{{ note.details }}</div>
            {% endif %}
            {% if note.created_at %}
              <p style="font-size: 0.75rem; color: #999; margin-top: 1rem; margin-bottom: 0;">Added: {{ note.created_at }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem 0;">
  <div style="width: 90%; max-width: 600px; background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin: auto; max-height: 90vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0; font-size: 1.8rem; color: #3A352C;">Edit Board</h2>
      <button onclick="closeEditModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; line-height: 1;">√ó</button>
    </div>

    <form method="post" action="{{ url_for('homeowner_saved_notes') }}" enctype="multipart/form-data" style="display: grid; gap: 1.5rem;">
      <input type="hidden" name="action" value="edit_board">
      <input type="hidden" name="board_name" value="{{ selected_board }}">

      <div>
        <label style="display: block; font-size: 0.85rem; font-weight: 700; color: #6B6A45; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">
          Board Title <span style="font-weight: 400; color: #999;">(optional)</span>
        </label>
        <input type="text" name="edit_title" value="{{ selected_board }}" placeholder="Board title..." style="width: 100%; padding: 0.9rem; border: 2px solid #E5DDD0; border-radius: 8px; font-size: 1rem;">
      </div>

      <div>
        <label style="display: block; font-size: 0.85rem; font-weight: 700; color: #6B6A45; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">
          Vision Statement / Details
        </label>
        <textarea name="edit_notes" rows="4" placeholder="Add your ideas..." style="width: 100%; padding: 0.9rem; border: 2px solid #E5DDD0; border-radius: 8px; font-size: 1rem; resize: vertical;">{% if selected_details.vision_statement %}{{ selected_details.vision_statement }}{% endif %}</textarea>
      </div>

      <!-- Delete Existing Photos -->
      {% if selected_details.photos and selected_details.photos|length > 0 %}
      <div>
        <label style="display: block; font-size: 0.85rem; font-weight: 700; color: #b3574a; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">
          Remove Photos
        </label>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; max-height: 300px; overflow-y: auto; padding: 0.5rem; border: 2px solid #E5DDD0; border-radius: 8px;">
          {% for photo in selected_details.photos %}
            <label style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem; border: 1px solid #E5DDD0; border-radius: 4px; cursor: pointer; position: relative;">
              <input type="checkbox" name="remove_photos" value="{{ photo }}" style="position: absolute; top: 5px; left: 5px; z-index: 2; width: 20px; height: 20px; cursor: pointer;">
              <img src="{{ url_for('static', filename=photo) }}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 4px;">
            </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div>
        <label style="display: block; font-size: 0.85rem; font-weight: 700; color: #6B6A45; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">
          Add More Photos
        </label>
        <input type="file" name="new_photos" multiple accept="image/*" style="width: 100%; padding: 0.9rem; border: 2px solid #E5DDD0; border-radius: 8px;">
      </div>

      <!-- Delete Existing Fixtures -->
      {% if selected_details.fixtures and selected_details.fixtures|length > 0 %}
      <div>
        <label style="display: block; font-size: 0.85rem; font-weight: 700; color: #b3574a; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">
          Remove Fixtures
        </label>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; border: 2px solid #E5DDD0; border-radius: 8px;">
          {% for fixture in selected_details.fixtures %}
            <label style="display: flex; flex-direction: column; align-items: center; padding: 0.5rem; border: 1px solid #E5DDD0; border-radius: 4px; cursor: pointer; position: relative;">
              <input type="checkbox" name="remove_fixtures" value="{{ fixture }}" style="position: absolute; top: 5px; left: 5px; z-index: 2; width: 20px; height: 20px; cursor: pointer;">
              <img src="{{ url_for('static', filename=fixture) }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
            </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div>
        <label style="display: block; font-size: 0.85rem; font-weight: 700; color: #6B6A45; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem;">
          Add More Fixtures/Furniture <span style="font-weight: 400; color: #999;">(backgrounds removed)</span>
        </label>
        <input type="file" name="new_fixtures" multiple accept="image/*" style="width: 100%; padding: 0.9rem; border: 2px solid #E5DDD0; border-radius: 8px;">
      </div>

      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
        <button type="button" onclick="closeEditModal()" style="padding: 0.9rem 1.5rem; border: 2px solid #E5DDD0; background: white; color: #6B6A45; border-radius: 8px; font-weight: 600; cursor: pointer;">
          Cancel
        </button>
        <button type="submit" style="padding: 0.9rem 1.5rem; background: linear-gradient(135deg, #6B6A45 0%, #5a5939 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Options Menu Modal -->
<div id="optionsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;">
  <div style="width: 90%; max-width: 500px; background: white; border-radius: 16px; padding: 2.5rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0; font-size: 1.8rem; color: #3A352C;">Board Options</h2>
      <button onclick="closeOptionsMenu()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; line-height: 1;">√ó</button>
    </div>

    <div style="display: grid; gap: 1rem;">
      <!-- Edit Board -->
      <button onclick="showEditModal(); closeOptionsMenu();" style="width: 100%; padding: 1rem 1.5rem; text-align: left; background: #6B6A45; border: 2px solid #6B6A45; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
        ‚úèÔ∏è Edit Board
      </button>

      <!-- Duplicate Board -->
      <button onclick="duplicateBoard()" style="width: 100%; padding: 1rem 1.5rem; text-align: left; background: white; border: 2px solid #E5DDD0; border-radius: 8px; color: #3A352C; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
        üìã Duplicate Board
      </button>

      <!-- Crop Photo -->
      <button onclick="openCropModal()" style="width: 100%; padding: 1rem 1.5rem; text-align: left; background: white; border: 2px solid #E5DDD0; border-radius: 8px; color: #3A352C; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
        ‚úÇÔ∏è Crop a Photo
      </button>

      <!-- Download PDF / Print -->
      <a href="{{ url_for('homeowner_design_board_download', board_name=selected_board) }}" target="_blank" style="width: 100%; padding: 1rem 1.5rem; text-align: left; background: white; border: 2px solid #E5DDD0; border-radius: 8px; color: #3A352C; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: block;">
        üì• Download PDF / Print
      </a>
    </div>
  </div>
</div>

<script>
  function showEditModal() {
    document.getElementById('editModal').style.display = 'flex';
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  function showOptionsMenu() {
    document.getElementById('optionsModal').style.display = 'flex';
  }

  function closeOptionsMenu() {
    document.getElementById('optionsModal').style.display = 'none';
  }

  function deleteNote(noteId, noteTitle) {
    if (!confirm(`Are you sure you want to delete "${noteTitle}"? This action cannot be undone.`)) {
      return;
    }
    
    fetch(`/homeowner/design-boards/note/${noteId}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Reload the page to show updated notes
        location.reload();
      } else {
        alert('Could not delete note: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(() => {
      alert('Could not delete note. Please try again.');
    });
  }
  
  // Layout Switcher Function
  function switchLayout(layoutType) {
    const gallery = document.getElementById('galleryCollage');
    const buttons = document.querySelectorAll('.layout-btn');
    
    // Remove all layout classes
    gallery.classList.remove('organic', 'grid', 'editorial');
    
    // Add the selected layout class
    gallery.classList.add(layoutType);
    
    // Update active button state
    buttons.forEach(btn => {
      if (btn.dataset.layout === layoutType) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    // Save preference to localStorage
    localStorage.setItem('moodboardLayout', layoutType);
  }
  
  // Load saved layout preference on page load
  document.addEventListener('DOMContentLoaded', function() {
    const savedLayout = localStorage.getItem('moodboardLayout') || 'organic';
    if (savedLayout !== 'organic') {
      switchLayout(savedLayout);
    }
    
    // Auto-remove white backgrounds from fixture images
    removeFixtureBackgrounds();
  });

  // Background removal function for fixture images
  function removeFixtureBackgrounds() {
    const fixtureImages = document.querySelectorAll('.fixture-item img');
    
    fixtureImages.forEach(img => {
      // Wait for image to load
      if (img.complete) {
        processFixtureImage(img);
      } else {
        img.addEventListener('load', () => processFixtureImage(img));
      }
    });
  }

  function processFixtureImage(img) {
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      
      ctx.drawImage(img, 0, 0);
      
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const width = canvas.width;
      const height = canvas.height;
      
      // PROFESSIONAL AI-GRADE BACKGROUND REMOVAL
      
      // === PHASE 1: SOPHISTICATED BACKGROUND SAMPLING ===
      const edgeDepth = Math.max(Math.floor(Math.min(width, height) * 0.08), 10);
      const backgroundSamples = [];
      
      // Sample all four edges comprehensively
      for (let i = 0; i < edgeDepth; i++) {
        for (let j = 0; j < width; j++) {
          // Top edge
          const topIdx = (i * width + j) * 4;
          backgroundSamples.push([data[topIdx], data[topIdx + 1], data[topIdx + 2]]);
          // Bottom edge
          const bottomIdx = ((height - 1 - i) * width + j) * 4;
          backgroundSamples.push([data[bottomIdx], data[bottomIdx + 1], data[bottomIdx + 2]]);
        }
        for (let j = 0; j < height; j++) {
          // Left edge
          const leftIdx = (j * width + i) * 4;
          backgroundSamples.push([data[leftIdx], data[leftIdx + 1], data[leftIdx + 2]]);
          // Right edge
          const rightIdx = (j * width + (width - 1 - i)) * 4;
          backgroundSamples.push([data[rightIdx], data[rightIdx + 1], data[rightIdx + 2]]);
        }
      }
      
      // K-means clustering to find dominant background color
      const bgColor = kMeansColor(backgroundSamples, 1)[0];
      const [bgR, bgG, bgB] = bgColor;
      
      // === PHASE 2: ADVANCED FEATURE MAPS ===
      const pixelCount = width * height;
      const luminance = new Float32Array(pixelCount);
      const saturation = new Float32Array(pixelCount);
      const gradientMag = new Float32Array(pixelCount);
      const colorDist = new Float32Array(pixelCount);
      
      // Build feature maps
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          const i = idx * 4;
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          
          // Luminance (CIE standard)
          luminance[idx] = 0.2126 * r + 0.7152 * g + 0.0722 * b;
          
          // Saturation (HSV)
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          const delta = max - min;
          saturation[idx] = max === 0 ? 0 : delta / max;
          
          // Color distance from background (CIE Delta E approximation)
          const dr = r - bgR;
          const dg = g - bgG;
          const db = b - bgB;
          colorDist[idx] = Math.sqrt(2 * dr * dr + 4 * dg * dg + 3 * db * db);
          
          // Gradient magnitude (Sobel operator)
          if (x > 0 && x < width - 1 && y > 0 && y < height - 1) {
            const gx = (
              -1 * luminance[idx - 1 - width] + 1 * luminance[idx + 1 - width] +
              -2 * luminance[idx - 1] + 2 * luminance[idx + 1] +
              -1 * luminance[idx - 1 + width] + 1 * luminance[idx + 1 + width]
            );
            const gy = (
              -1 * luminance[idx - width - 1] - 2 * luminance[idx - width] - 1 * luminance[idx - width + 1] +
              1 * luminance[idx + width - 1] + 2 * luminance[idx + width] + 1 * luminance[idx + width + 1]
            );
            gradientMag[idx] = Math.sqrt(gx * gx + gy * gy);
          }
        }
      }
      
      // === PHASE 3: TRIMAP GENERATION (ULTRA-AGGRESSIVE WHITE REMOVAL) ===
      const BACKGROUND = 0;
      const FOREGROUND = 255;
      const UNKNOWN = 128;
      const trimap = new Uint8Array(pixelCount);
      
      // Calculate average background brightness
      const bgBrightness = (bgR + bgG + bgB) / 3;
      const isLightBackground = bgBrightness > 200;
      
      for (let idx = 0; idx < pixelCount; idx++) {
        const i = idx * 4;
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        const cd = colorDist[idx];
        const grad = gradientMag[idx];
        const sat = saturation[idx];
        const lum = luminance[idx];
        
        // For white/light backgrounds, be EXTREMELY aggressive
        if (isLightBackground) {
          // Mark as BACKGROUND if it's bright and close to white
          if (lum > 220 && sat < 0.08 && cd < 50) {
            trimap[idx] = BACKGROUND;
          }
          // Mark as FOREGROUND if it has ANY decent features
          else if (cd > 25 || grad > 8 || sat > 0.1 || lum < 200) {
            trimap[idx] = FOREGROUND;
          }
          else {
            trimap[idx] = UNKNOWN;
          }
        } else {
          // Standard approach for non-white backgrounds
          if (cd > 35 || grad > 12 || sat > 0.12) {
            trimap[idx] = FOREGROUND;
          }
          else if (cd < 25 && grad < 3 && sat < 0.05 && lum > 200) {
            trimap[idx] = BACKGROUND;
          }
          else {
            trimap[idx] = UNKNOWN;
          }
        }
      }
      
      // ULTRA-AGGRESSIVE flood fill - removes all white connected regions
      const visited = new Uint8Array(pixelCount);
      const queue = [];
      
      // Start from all edges
      for (let x = 0; x < width; x++) {
        for (let y = 0; y < height; y++) {
          if (x < edgeDepth * 2 || x >= width - edgeDepth * 2 || 
              y < edgeDepth * 2 || y >= height - edgeDepth * 2) {
            const idx = y * width + x;
            const lum = luminance[idx];
            const sat = saturation[idx];
            
            // If it's bright/white at edge, flood fill from here
            if ((trimap[idx] === BACKGROUND || trimap[idx] === UNKNOWN) && 
                lum > 210 && sat < 0.1) {
              queue.push([x, y]);
              visited[idx] = 1;
              trimap[idx] = BACKGROUND;
            }
          }
        }
      }
      
      // Flood fill - spread to all similar connected pixels
      while (queue.length > 0) {
        const [x, y] = queue.shift();
        const idx = y * width + x;
        const currentLum = luminance[idx];
        
        const neighbors = [
          [x-1, y], [x+1, y], [x, y-1], [x, y+1],
          [x-1, y-1], [x+1, y-1], [x-1, y+1], [x+1, y+1]
        ];
        
        for (const [nx, ny] of neighbors) {
          if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
            const nidx = ny * width + nx;
            if (!visited[nidx]) {
              visited[nidx] = 1;
              const nLum = luminance[nidx];
              const nSat = saturation[nidx];
              const nGrad = gradientMag[nidx];
              
              // Spread to similar bright pixels (AGGRESSIVE)
              if (nLum > 200 && nSat < 0.12 && nGrad < 10 && 
                  Math.abs(nLum - currentLum) < 40) {
                trimap[nidx] = BACKGROUND;
                queue.push([nx, ny]);
              }
            }
          }
        }
      }
      
      // === PHASE 4: ALPHA MATTING (ULTRA-AGGRESSIVE FOR WHITE) ===
      const alpha = new Uint8Array(pixelCount);
      
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          const i = idx * 4;
          
          if (trimap[idx] === FOREGROUND) {
            alpha[idx] = 255;
          } else if (trimap[idx] === BACKGROUND) {
            alpha[idx] = 0;
          } else {
            // For unknown pixels
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            const cd = colorDist[idx];
            const grad = gradientMag[idx];
            const sat = saturation[idx];
            const lum = luminance[idx];
            
            // WHITE BACKGROUND SPECIAL HANDLING
            // If pixel is very white, make it transparent
            if (r > 235 && g > 235 && b > 235 && sat < 0.06) {
              alpha[idx] = 0;
            }
            // If pixel is bright and nearly white
            else if (lum > 230 && sat < 0.08 && grad < 5) {
              alpha[idx] = 0;
            }
            // If pixel has moderate brightness but still very desaturated
            else if (lum > 210 && sat < 0.1 && cd < 30 && grad < 8) {
              // Fade out based on brightness
              const fadeAmount = (240 - lum) / 30;
              alpha[idx] = Math.floor(Math.min(100, fadeAmount * 255));
            }
            // Has some features - keep with varying alpha
            else {
              let alphaValue = 200;
              
              if (cd > 30 || grad > 10 || sat > 0.12) {
                alphaValue = 255;
              } else if (cd > 20) {
                alphaValue = 220;
              } else if (grad > 5) {
                alphaValue = 180;
              } else {
                alphaValue = 100;
              }
              
              // Neighborhood check
              let fgCount = 0;
              let bgCount = 0;
              
              for (let dy = -3; dy <= 3; dy++) {
                for (let dx = -3; dx <= 3; dx++) {
                  const nx = x + dx;
                  const ny = y + dy;
                  if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                    const nidx = ny * width + nx;
                    if (trimap[nidx] === FOREGROUND) fgCount++;
                    if (trimap[nidx] === BACKGROUND) bgCount++;
                  }
                }
              }
              
              if (fgCount > 20) alphaValue = 255;
              else if (bgCount > 30) alphaValue = 0;
              
              alpha[idx] = alphaValue;
            }
          }
        }
      }
      
      // === PHASE 5: AGGRESSIVE EDGE REFINEMENT + BILATERAL FILTERING ===
      const alphaSmoothed = new Uint8Array(pixelCount);
      const spatialSigma = 1.5;
      const rangeSigma = 25.0;
      
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          const currentAlpha = alpha[idx];
          
          // Full opacity or full transparency - no smoothing needed
          if (currentAlpha === 255 || currentAlpha === 0) {
            alphaSmoothed[idx] = currentAlpha;
            continue;
          }
          
          // Edge pixels need smoothing
          let weightSum = 0;
          let valueSum = 0;
          
          for (let dy = -4; dy <= 4; dy++) {
            for (let dx = -4; dx <= 4; dx++) {
              const nx = x + dx;
              const ny = y + dy;
              if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                const nidx = ny * width + nx;
                const nAlpha = alpha[nidx];
                
                // Spatial weight (Gaussian)
                const spatialDist = dx * dx + dy * dy;
                const spatialWeight = Math.exp(-spatialDist / (2 * spatialSigma * spatialSigma));
                
                // Range weight (based on alpha difference)
                const rangeDist = Math.abs(currentAlpha - nAlpha);
                const rangeWeight = Math.exp(-rangeDist / (2 * rangeSigma * rangeSigma));
                
                const weight = spatialWeight * rangeWeight;
                weightSum += weight;
                valueSum += weight * nAlpha;
              }
            }
          }
          
          alphaSmoothed[idx] = Math.floor(valueSum / weightSum);
        }
      }
      
      // Additional pass: Remove isolated transparent pixels (noise)
      const alphaFinal = new Uint8Array(pixelCount);
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          const currentAlpha = alphaSmoothed[idx];
          
          // If pixel is semi-transparent, check if it's isolated
          if (currentAlpha > 0 && currentAlpha < 128) {
            let opaqueNeighbors = 0;
            let totalNeighbors = 0;
            
            for (let dy = -1; dy <= 1; dy++) {
              for (let dx = -1; dx <= 1; dx++) {
                if (dx === 0 && dy === 0) continue;
                const nx = x + dx;
                const ny = y + dy;
                if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                  const nidx = ny * width + nx;
                  totalNeighbors++;
                  if (alphaSmoothed[nidx] > 200) opaqueNeighbors++;
                }
              }
            }
            
            // If surrounded by opaque pixels, make it opaque
            if (opaqueNeighbors > totalNeighbors * 0.6) {
              alphaFinal[idx] = 255;
            } else if (opaqueNeighbors === 0) {
              alphaFinal[idx] = 0;
            } else {
              alphaFinal[idx] = currentAlpha;
            }
          } else {
            alphaFinal[idx] = currentAlpha;
          }
        }
      }
      
      // === PHASE 6: APPLY ALPHA CHANNEL ===
      for (let idx = 0; idx < pixelCount; idx++) {
        data[idx * 4 + 3] = alphaFinal[idx];
      }
      
      ctx.putImageData(imageData, 0, 0);
      
      img.src = canvas.toDataURL('image/png');
      img.style.filter = 'drop-shadow(0 8px 20px rgba(0,0,0,0.25))';
      
      console.log('‚úì AGGRESSIVE background removal complete');
      
    } catch (e) {
      console.error('Background removal failed:', e);
    }
  }
  
  // K-means clustering helper for background detection
  function kMeansColor(samples, k) {
    if (samples.length === 0) return [[255, 255, 255]];
    
    // Initialize centroids randomly
    const centroids = [];
    for (let i = 0; i < k; i++) {
      centroids.push(samples[Math.floor(Math.random() * samples.length)]);
    }
    
    // Run k-means for 5 iterations
    for (let iter = 0; iter < 5; iter++) {
      const clusters = Array.from({ length: k }, () => []);
      
      // Assign samples to nearest centroid
      samples.forEach(sample => {
        let minDist = Infinity;
        let bestCluster = 0;
        
        for (let i = 0; i < k; i++) {
          const dist = Math.sqrt(
            Math.pow(sample[0] - centroids[i][0], 2) +
            Math.pow(sample[1] - centroids[i][1], 2) +
            Math.pow(sample[2] - centroids[i][2], 2)
          );
          if (dist < minDist) {
            minDist = dist;
            bestCluster = i;
          }
        }
        
        clusters[bestCluster].push(sample);
      });
      
      // Update centroids
      for (let i = 0; i < k; i++) {
        if (clusters[i].length > 0) {
          const sumR = clusters[i].reduce((sum, c) => sum + c[0], 0);
          const sumG = clusters[i].reduce((sum, c) => sum + c[1], 0);
          const sumB = clusters[i].reduce((sum, c) => sum + c[2], 0);
          const count = clusters[i].length;
          centroids[i] = [
            Math.floor(sumR / count),
            Math.floor(sumG / count),
            Math.floor(sumB / count)
          ];
        }
      }
    }
    
    return centroids;
  }

  function duplicateBoard() {
    const newName = prompt('Enter a name for the duplicated board:', '{{ selected_board }} (Copy)');
    if (newName && newName.trim()) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '{{ url_for("homeowner_design_board_duplicate", board_name=selected_board) }}';
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'new_name';
      input.value = newName.trim();
      form.appendChild(input);
      
      document.body.appendChild(form);
      form.submit();
    }
  }

  // Close modals on outside click
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeEditModal();
  });

  document.getElementById('optionsModal').addEventListener('click', function(e) {
    if (e.target === this) closeOptionsMenu();
  });
</script>

<!-- Crop Modal -->
<div id="cropModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem 0;">
  <div style="width: 90%; max-width: 900px; background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.5); margin: auto; max-height: 95vh; display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-shrink: 0;">
      <h2 style="margin: 0; font-size: 1.8rem; color: #3A352C;">‚úÇÔ∏è Crop Photo</h2>
      <button onclick="closeCropModal()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; line-height: 1;">√ó</button>
    </div>

    <div style="margin-bottom: 1.5rem; flex-shrink: 0;">
      <label style="display: block; font-size: 0.9rem; font-weight: 600; color: #6B6A45; margin-bottom: 0.8rem;">Select Photo to Crop</label>
      <select id="cropPhotoSelect" onchange="loadCropImage()" style="width: 100%; padding: 0.9rem; border: 2px solid #E5DDD0; border-radius: 8px; font-size: 1rem;">
        <option value="">Choose a photo...</option>
        {% for photo in selected_details.photos %}
          <option value="{{ url_for('static', filename=photo) }}" data-path="{{ photo }}">Photo {{ loop.index }}</option>
        {% endfor %}
      </select>
    </div>

    <div id="cropImageContainer" style="flex: 1; min-height: 300px; max-height: 60vh; margin-bottom: 1.5rem; background: #f5f5f5; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
      <img id="cropImage" style="max-width: 100%; max-height: 60vh; display: block;" />
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0; padding-top: 1rem; border-top: 1px solid #E5DDD0;">
      <button onclick="closeCropModal()" style="padding: 0.9rem 1.5rem; border: 2px solid #E5DDD0; background: white; color: #6B6A45; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
      <button onclick="applyCrop()" style="padding: 0.9rem 1.5rem; background: linear-gradient(135deg, #6B6A45 0%, #5a5939 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Apply Crop</button>
    </div>
  </div>
</div>

<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

<!-- Cropper.js Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
  let cropper = null;
  let currentPhotoPath = null;

  function openCropModal() {
    document.getElementById('cropModal').style.display = 'flex';
    closeOptionsMenu();
  }

  function closeCropModal() {
    document.getElementById('cropModal').style.display = 'none';
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    document.getElementById('cropPhotoSelect').value = '';
    const cropImage = document.getElementById('cropImage');
    if (cropImage) {
      cropImage.src = '';
      cropImage.style.display = 'none';
    }
    const container = document.getElementById('cropImageContainer');
    if (container) {
      container.innerHTML = '<img id="cropImage" style="max-width: 100%; max-height: 500px; display: block;" />';
    }
  }

  function loadCropImage() {
    const select = document.getElementById('cropPhotoSelect');
    const imgUrl = select.value;
    const imgPath = select.options[select.selectedIndex].dataset.path;
    
    if (!imgUrl) return;
    
    currentPhotoPath = imgPath;
    const image = document.getElementById('cropImage');
    
    if (cropper) {
      cropper.destroy();
    }
    
    image.src = imgUrl;
    image.style.display = 'block';
    image.onload = function() {
      // Ensure container is visible
      const container = document.getElementById('cropImageContainer');
      if (container) {
        container.style.display = 'flex';
      }
      
      // Destroy existing cropper if any
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      
      // Initialize cropper
      cropper = new Cropper(image, {
        aspectRatio: NaN,
        viewMode: 1,
        autoCropArea: 0.8,
        responsive: true,
        background: false,
        zoomable: true,
        scalable: true,
        rotatable: true,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: false,
      });
    };
    
    image.onerror = function() {
      alert('Error loading image. Please check the image path.');
    };
  }

  function applyCrop() {
    if (!cropper || !currentPhotoPath) {
      alert('Please select a photo first');
      return;
    }

    const canvas = cropper.getCroppedCanvas();
    canvas.toBlob(function(blob) {
      const formData = new FormData();
      formData.append('cropped_image', blob, 'cropped.png');
      formData.append('original_path', currentPhotoPath);
      formData.append('board_name', '{{ selected_board }}');

      fetch('/homeowner/crop-photo', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úì Photo cropped successfully!');
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || 'Could not crop photo'));
        }
      })
      .catch(err => {
        alert('Error cropping photo');
        console.error(err);
      });
    });
  }
  
  // Luxurious Strategic Label Positioning - relative to board
  (function() {
    function positionFloatingLabels() {
      const labels = document.querySelectorAll('.floating-label');
      if (labels.length === 0) return;
      
      const gallery = document.querySelector('.gallery');
      if (!gallery) return;
      
      const galleryRect = gallery.getBoundingClientRect();
      const galleryWidth = galleryRect.width;
      const galleryHeight = galleryRect.height;
      
      // Strategic positions for luxury placement - relative to gallery/board
      const positions = [
        // Top-left quadrant - elegant corner placement
        {
          x: galleryWidth * 0.1,
          y: galleryHeight * 0.15,
          rotation: -2.5
        },
        // Top-right quadrant - balanced placement
        {
          x: galleryWidth * 0.85,
          y: galleryHeight * 0.2,
          rotation: 3.5
        },
        // Bottom-left quadrant - sophisticated placement
        {
          x: galleryWidth * 0.08,
          y: galleryHeight * 0.8,
          rotation: -4
        },
        // Bottom-right quadrant - refined placement
        {
          x: galleryWidth * 0.88,
          y: galleryHeight * 0.82,
          rotation: 2.8
        }
      ];
      
      labels.forEach((label, index) => {
        const pos = positions[index % positions.length];
        
        // Add slight random variation for organic feel (¬±3%)
        const variationX = (Math.random() - 0.5) * (galleryWidth * 0.03);
        const variationY = (Math.random() - 0.5) * (galleryHeight * 0.03);
        const variationRot = (Math.random() - 0.5) * 1.5; // ¬±0.75 degrees
        
        const finalX = pos.x + variationX;
        const finalY = pos.y + variationY;
        const finalRot = pos.rotation + variationRot;
        
        label.style.left = finalX + 'px';
        label.style.top = finalY + 'px';
        label.style.setProperty('--label-rotation', finalRot + 'deg');
        label.style.transform = `rotate(${finalRot}deg)`;
      });
    }
    
    // Position labels when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', positionFloatingLabels);
    } else {
      positionFloatingLabels();
    }
    
    // Reposition on window resize (with debounce)
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(positionFloatingLabels, 300);
    });
  })();
  
  // Elegant Random Label Positioning
  (function() {
    function positionFloatingLabels() {
      const labels = document.querySelectorAll('.floating-label');
      const container = document.querySelector('.gallery') || document.body;
      const containerRect = container.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      labels.forEach((label, index) => {
        // Random position within viewport, avoiding edges
        const margin = 100;
        const maxX = viewportWidth - margin;
        const maxY = viewportHeight - margin;
        const minX = margin;
        const minY = margin;
        
        // Random positions with some variation
        const randomX = minX + Math.random() * (maxX - minX);
        const randomY = minY + Math.random() * (maxY - minY);
        
        // Slight random rotation
        const rotation = -8 + Math.random() * 16; // -8 to +8 degrees
        
        label.style.left = randomX + 'px';
        label.style.top = randomY + 'px';
        label.style.setProperty('--label-rotation', rotation + 'deg');
        label.style.transform = `rotate(${rotation}deg)`;
      });
    }
    
    // Position labels when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', positionFloatingLabels);
    } else {
      positionFloatingLabels();
    }
    
    // Reposition on window resize (with debounce)
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(positionFloatingLabels, 300);
    });
  })();
</script>

{% endblock %}
